\documentclass{article}


\usepackage{PRIMEarxiv}

\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage[T1]{fontenc}    % use 8-bit T1 fonts
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
\usepackage{lipsum}
\usepackage{csquotes}
\usepackage{fancyhdr}       % header
\usepackage{longtable}
\usepackage{graphicx}       % graphics
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{listings}
\usepackage{enumitem}
\usepackage{dsfont}
\usepackage{microtype}  % new
% \usepackage[most]
\usepackage[T1]{fontenc}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{tgpagella}
\usepackage{xspace}
\usepackage[round,semicolon]{natbib}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{array}
\usepackage[hidelinks]{hyperref}
\usepackage{tikz}
\usepackage{pifont}
\usepackage[export]{adjustbox}
\usepackage{graphicx}
\usepackage{caption} 
\usepackage{longtable}
\usepackage[symbol]{footmisc}




\captionsetup[table]{skip=0.2cm}
\graphicspath{ {./img/} }

\usepackage[labelfont=bf]{caption}
\usepackage[version=4]{mhchem}
\graphicspath{{media/}}     

%Header
\pagestyle{fancy}
\thispagestyle{empty}
\rhead{ \textit{ }} 

\fancyhead[LO]{}

\newcommand{\tbf}{\textbf}
\newcommand{\modelname}{\textsc{Llama 2-Chat}\xspace}
\newcommand{\anise}{\textsc{Llama 1}\xspace}
\newcommand{\cinnamon}{\textsc{Llama 2}\xspace}
\newcommand{\contribparagraph}[1]{\paragraph{#1}\mbox{}\\}


\usepackage{xcolor}
\newcommand{\annotate}[3]{{\color{#3}
		\colorbox{#3}{\bfseries\sffamily\tiny\textcolor{white}{#2}}
		\color{#3}
		\footnotesize\emph{#1}}
}
\newcommand{\head}[2]{\multicolumn{1}{>{\centering\arraybackslash}p{#1}}{\textbf{#2}}}
\newcommand{\blocked}[1]{\annotate{#1}{BLOCKED}{red}}

\newcommand{\xmarkg}{\textcolor{lightgray}{\ding{55}}\xspace}
\newcommand{\grayit}[1]{\textit{\color{gray}{#1}}}

\title{\cinnamon: Open Foundation and Fine-Tuned Chat Models}


\author{
Hugo Touvron\thanks{Equal contribution, corresponding authors: \{tscialom, htouvron\}@meta.com} \hspace{0.25cm} Louis Martin\thanks{Second author \newline \newline Contributions for all the authors can be found in Section~\ref{app:contributinos}.} \hspace{0.25cm} Kevin Stone\footnotemark[2] \vspace{0.07cm}
\and Peter Albert\hspace{0.12cm} Amjad Almahairi\hspace{0.12cm} Yasmine Babaei\hspace{0.12cm} Nikolay Bashlykov\hspace{0.12cm} Soumya Batra \vspace{0.018cm} 
\and Prajjwal Bhargava\hspace{0.12cm} Shruti Bhosale\hspace{0.12cm} Dan Bikel\hspace{0.12cm} Lukas Blecher\hspace{0.12cm}  Cristian Canton Ferrer\hspace{0.12cm} Moya Chen\vspace{0.018cm} 
\and Guillem Cucurull\hspace{0.12cm} David Esiobu\hspace{0.12cm} Jude Fernandes\hspace{0.12cm} Jeremy Fu\hspace{0.12cm} Wenyin Fu\hspace{0.12cm} Brian Fuller\hspace{0.12cm} \vspace{0.018cm} 
\and Cynthia Gao\hspace{0.12cm} Vedanuj Goswami\hspace{0.12cm} Naman Goyal\hspace{0.12cm} Anthony Hartshorn\hspace{0.12cm} Saghar Hosseini\hspace{0.12cm} Rui Hou\vspace{0.018cm} 
\and Hakan Inan\hspace{0.12cm} Marcin Kardas\hspace{0.12cm} Viktor Kerkez\hspace{0.12cm}Madian Khabsa\hspace{0.12cm} Isabel Kloumann\hspace{0.12cm} Artem Korenev\vspace{0.018cm} 
\and Punit Singh Koura\hspace{0.12cm} Marie-Anne Lachaux\hspace{0.12cm} Thibaut Lavril\hspace{0.12cm} Jenya Lee\hspace{0.12cm} Diana Liskovich \vspace{0.018cm} 
\and Yinghai Lu\hspace{0.12cm} Yuning Mao\hspace{0.12cm} Xavier Martinet\hspace{0.12cm} Todor Mihaylov\hspace{0.12cm} Pushkar Mishra\hspace{0.12cm} \vspace{0.018cm}
\and  Igor Molybog\hspace{0.12cm} Yixin Nie\hspace{0.12cm} Andrew Poulton\hspace{0.12cm} Jeremy Reizenstein\hspace{0.12cm} Rashi Rungta\hspace{0.12cm} Kalyan Saladi \vspace{0.018cm} 
\and   Alan Schelten\hspace{0.12cm} Ruan Silva\hspace{0.12cm} Eric Michael Smith\hspace{0.12cm} Ranjan Subramanian\hspace{0.12cm} Xiaoqing Ellen Tan\hspace{0.12cm} Binh Tang\vspace{0.018cm} 
\and  Ross Taylor\hspace{0.12cm} Adina Williams\hspace{0.12cm} Jian Xiang Kuan\hspace{0.12cm} Puxin Xu\hspace{0.12cm} Zheng Yan\hspace{0.12cm} Iliyan Zarov\hspace{0.12cm} Yuchen Zhang \vspace{0.018cm}
\and Angela Fan\hspace{0.12cm} Melanie Kambadur\hspace{0.12cm} Sharan Narang\hspace{0.12cm} Aurelien Rodriguez\hspace{0.12cm} Robert Stojnic \vspace{0.05cm}  \and Sergey Edunov\hspace{0.22cm} Thomas Scialom\footnotemark[1] \\ \vspace{0.5cm} \\
\textbf{\large GenAI, Meta}
}


\setcounter{tocdepth}{2}

\begin{document}
\maketitle

\begin{abstract}

In this work, we develop and release Llama 2, a collection of pretrained and fine-tuned large language models (LLMs) ranging in scale from 7 billion to 70 billion parameters. Our fine-tuned LLMs, called \modelname, are optimized for dialogue use cases. Our models outperform open-source chat models on most benchmarks we tested, and based on our human evaluations for helpfulness and safety, may be a suitable substitute for closed-source models. We provide a detailed description of our approach to fine-tuning and safety improvements of \modelname in order to enable the community to build on our work and contribute to the responsible development of LLMs.

\end{abstract}
\newpage
\tableofcontents
\newpage


\section{Introduction}

Large Language Models (LLMs) have shown great promise as highly capable AI assistants that excel in complex reasoning tasks requiring expert knowledge across a wide range of fields, including in specialized domains such as programming and creative writing. They enable interaction with humans through intuitive chat interfaces, which has led to rapid and widespread adoption among the general public.

The capabilities of LLMs are remarkable considering the seemingly straightforward nature of the training methodology.  Auto-regressive transformers are pretrained on an extensive corpus of self-supervised data, followed by alignment with human preferences via techniques such as Reinforcement Learning with Human Feedback (RLHF). Although the training methodology is simple, high computational requirements have limited the development of LLMs to a few players. There have been public releases of pretrained LLMs (such as BLOOM \citep{scao2022bloom}, LLaMa-1 \citep{Touvron2023LLaMAOA}, and Falcon \citep{penedo2023refinedweb}) that match the performance of closed pretrained competitors like GPT-3 \citep{gpt3} and Chinchilla \citep{hoffmann2022training}, but none of these models are suitable substitutes for closed ``product'' LLMs, such as ChatGPT, BARD, and Claude. These closed product LLMs are heavily fine-tuned to align with human preferences, which greatly enhances their usability and safety. This step can require significant costs in compute and human annotation, and is often not transparent or easily reproducible, limiting progress within the community to advance AI alignment research.


\begin{figure}[t]
   \begin{minipage}[t]{0.55\textwidth}
     \centering
     \includegraphics[width=0.99\linewidth]{img/human_evals/overall_win_rate_horizontal_white.pdf}
     \caption{\textbf{Helpfulness human evaluation} results for \modelname compared to other open-source and closed-source models. Human raters compared model generations on \textasciitilde4k prompts consisting of both single and multi-turn prompts. The 95\% confidence intervals for this evaluation are between 1\% and 2\%. More details in Section~\ref{sec:detail_results}. While reviewing these results, it is important to note that human evaluations can be noisy due to limitations of the prompt set, subjectivity of the review guidelines, subjectivity of individual raters, and the inherent difficulty of comparing generations.}
    \label{fig:first_helpful_evals}
   \end{minipage}\hfill
   \begin{minipage}[t]{0.42\textwidth}
     \centering
     \includegraphics[width=0.8\linewidth]{img/fig1_gpt4_eval.pdf}
     \caption{\textbf{Win-rate \% for helpfulness and safety between commercial-licensed baselines and \modelname{}}, according to GPT-4. To complement the human evaluation, we used a more capable model, not subject to our own guidance. Green area indicates our model is better according to GPT-4. To remove ties, we used $win/(win+loss)$. The orders in which the model responses are presented to GPT-4 are randomly swapped to alleviate bias.}
     \label{Fig:Data2}
   \end{minipage}
\end{figure}


\begin{figure}[t]
    \centering
    \includegraphics[width=0.9\textwidth]{img/safety_overall_human_temp.png}
    \caption{\textbf{Safety human evaluation results for \modelname compared to other open-source and closed-source models.} Human raters judged model generations for safety violations across \textasciitilde2,000 adversarial prompts consisting of both single and multi-turn prompts. More details can be found in Section~\ref{sec:safety_results}. It is important to caveat these safety results with the inherent bias of LLM evaluations due to limitations of the prompt set, subjectivity of the review guidelines, and subjectivity of individual raters. Additionally, these safety evaluations are performed using content standards that are likely to be biased towards the \modelname models.}
    \label{fig:first_safety_evals}
\end{figure}

In this work, we develop and release Llama 2, a family of pretrained and fine-tuned LLMs, \textit{\cinnamon} and \textit{\modelname}, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, \modelname models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures~\ref{fig:first_helpful_evals} and~\ref{fig:first_safety_evals}). We have taken measures to increase the safety of these models, using safety-specific data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our fine-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce fine-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of \textit{\cinnamon} and \textit{\modelname}, such as the emergence of tool usage and temporal organization of knowledge.


We are releasing the following models to the general public for research and commercial use\footnote{\url{https://ai.meta.com/resources/models-and-libraries/llama/}}:
\begin{enumerate}
  \item \textbf{\cinnamon{}}, an updated version of \anise{}, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40\%, doubled the context length of the model, and adopted grouped-query attention \citep{gqa2023}. We are releasing variants of \cinnamon with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.\footnote{We are delaying the release of the 34B model due to a lack of time to sufficiently red team.}

  \item \textbf{\modelname{}}, a fine-tuned version of \cinnamon{} that is optimized for dialogue use cases. We release variants of this model with 7B, 13B, and 70B parameters as well.
\end{enumerate}

We believe that the open release of LLMs, when done safely, will be a net benefit to society. Like all LLMs, \cinnamon is a new technology that carries potential risks with use \citep{bender2021dangers,weidinger2021ethical,solaiman2023evaluating}. Testing conducted to date has  been in English and has not — and could not — cover all scenarios.  Therefore, before deploying any applications of \modelname{}, developers should perform safety testing and tuning tailored to their specific applications of the model. We provide a responsible use guide\footnote{\url{https://ai.meta.com/llama}} and code examples\footnote{\url{https://github.com/facebookresearch/llama}} to facilitate the safe deployment of \cinnamon and \modelname. More details of our responsible release strategy can be found in Section~\ref{sec:responsible_release_strategy}.



The remainder of this paper describes our pretraining methodology (Section~\ref{sec:pretraining}), fine-tuning methodology (Section~\ref{sec:fine_tuning}),  approach to model safety (Section~\ref{sec:safety_section}), key observations and insights (Section~\ref{sec:results_and_discussion}), relevant related work (Section~\ref{sec:related_works}), and  conclusions (Section~\ref{sec:conclusion}).    


\begin{figure}[htbp]
\centering
\includegraphics[trim={.5cm 1cm .5cm 1cm},clip,width=0.95\textwidth]{RLHF_chart2.jpg}
\caption{
\textbf{Training of \modelname}:  This process begins with the \textbf{pretraining} of \cinnamon using publicly available online sources. Following this, we create an initial version of \modelname through the application of \textbf{supervised fine-tuning}. Subsequently, the model is iteratively refined using Reinforcement Learning with Human Feedback \textbf{(RLHF)} methodologies, specifically through rejection sampling and Proximal Policy Optimization (PPO). Throughout the RLHF stage, the accumulation of \textbf{iterative reward modeling data} in parallel with model enhancements is crucial to ensure the reward models remain within distribution.} 
\label{fig:training_process}
\end{figure}


\section{Pretraining}
\label{sec:pretraining}
To create the new family of \cinnamon models, we began with the pretraining approach described in \cite{Touvron2023LLaMAOA}, using an optimized auto-regressive transformer, but made several changes to improve performance. Specifically, we performed more robust data cleaning, updated our data mixes, trained on 40\% more total tokens, doubled the context length, and used grouped-query attention (GQA) to improve inference scalability for our larger models. Table~\ref{tab:model_arch} compares the attributes of the new \cinnamon models with the \anise models.

\subsection{Pretraining Data} \label{sec:pretraining_data}
Our training corpus includes a new mix of data from publicly available sources, which does not include data from Meta's products or services. We made an effort to remove data from certain sites known to contain a high volume of personal information about private individuals. We trained on 2 trillion tokens of data as this provides a good performance--cost trade-off, up-sampling the most factual sources in an effort to increase knowledge and dampen hallucinations.

We performed a variety of pretraining data investigations so that users can better understand the potential capabilities and limitations of our models; results can be found in Section~\ref{sec:safety_data}.

\begin{table*}[t!]
  \centering
  \setlength{\tabcolsep}{5pt}
  \begin{tabular}{llccccc}
  \toprule
   & \head{3.5cm}{Training Data} & \head{1.5cm}{Params}   & \head{1.5cm}{Context Length} & \head{1.5cm}{GQA}  & \head{1.5cm}{Tokens} & \head{1.5cm}{LR} \\
  \midrule
  \multirow{4}{2cm}{\anise} &
  \multirow{4}{3.5cm}{\textit{See \cite{Touvron2023LLaMAOA}}}
       & 7B   & 2k & \xmarkg & 1.0T & $3.0\times10^{-4}$\\
     & & 13B  & 2k & \xmarkg  & 1.0T & $3.0\times10^{-4}$\\
     & & 33B  & 2k &  \xmarkg & 1.4T & $1.5\times10^{-4}$ \\
     & & 65B  & 2k & \xmarkg  & 1.4T & $1.5\times10^{-4}$ \\
  \midrule
  \multirow{4}{2cm}{\cinnamon} &
  \multirow{4}{3.5cm}{\textit{A new mix of publicly available online data}} 
       & 7B    & 4k & \xmarkg & 2.0T  &
     $3.0\times10^{-4}$\\
     & & 13B   & 4k & \xmarkg & 2.0T &
     $3.0\times10^{-4}$ \\
     & & 34B   & 4k & \checkmark & 2.0T &
     $1.5\times10^{-4}$ \\
     & & 70B   & 4k & \checkmark & 2.0T & $1.5\times10^{-4}$ \\
  \bottomrule
  \end{tabular}
  \caption{
  \textbf{\cinnamon family of models.} Token counts refer to pretraining data only. All models are trained with a global batch-size of 4M tokens. Bigger models --- 34B and 70B 
  --- use Grouped-Query Attention (GQA) for improved inference scalability.
  \label{tab:model_arch}
  }
\end{table*}



\subsection{Training Details}
\label{sec:training_details}
We adopt most of the pretraining setting and model architecture from \anise.  We use the standard transformer architecture 
\citep{vaswani2017attention}, apply pre-normalization using RMSNorm \citep{zhang2019root}, use the SwiGLU activation function \citep{shazeer2020glu}, and rotary positional embeddings (RoPE, \citealt{su2022roformer}). The primary architectural differences from \anise include increased context length and grouped-query attention (GQA). We detail in Appendix Section \ref{sec:appendix_pretrain_details_archi_changes} each of these differences with ablation experiments to demonstrate their importance.


\paragraph{Hyperparameters.} We trained using the AdamW optimizer~\citep{loshchilov2017decoupled}, with $\beta_1 = 0.9, \beta_2 = 0.95, \text{eps} = 10^{-5}$. We use a cosine learning rate schedule, with warmup of 2000 steps, and decay final learning rate down to 10\% of the peak learning rate. We use a weight decay of $0.1$ and gradient clipping of $1.0$. 
Figure~\ref{fig:train_loss}~(a) shows the training loss for \cinnamon with these hyperparameters.
 
\begin{figure}
    \centering
    \includegraphics[width=0.8 \linewidth]{img/pretraining/loss_train.pdf}
    \caption{\textbf{Training Loss for \cinnamon models.} We compare the training loss of the \cinnamon family of models. We observe that after pretraining on 2T Tokens, the models still did not show any sign of saturation.
    }
    \label{fig:train_loss}
\end{figure}

\paragraph{Tokenizer.} We use the same tokenizer as \anise; it employs a bytepair encoding (BPE) algorithm \citep{sennrich2016neural} using the implementation from SentencePiece \citep{kudo2018sentencepiece}. As with \anise, we split all numbers into individual digits and use bytes to decompose unknown UTF-8 characters. The total vocabulary size is 32k tokens.

\subsubsection{Training Hardware \& Carbon Footprint} 

\paragraph{Training Hardware.} 
We pretrained our models on Meta's Research Super Cluster (RSC) \citep{lee2022rsc} as well as internal production clusters. Both clusters use NVIDIA A100s.  There are two key differences between the two clusters, with the first being the type of interconnect available: RSC uses NVIDIA Quantum InfiniBand while our production cluster is equipped with a RoCE (RDMA over converged Ethernet) solution based on commodity ethernet Switches. Both of these solutions interconnect 200 Gbps end-points. The second difference is the per-GPU power consumption cap --- RSC uses 400W while our production cluster uses 350W.  With this two-cluster setup, we were able to compare the suitability of these different types of interconnect for large scale training.  RoCE (which is a more affordable, commercial interconnect network) can scale almost as well as expensive Infiniband up to 2000 GPUs, which makes pretraining even more democratizable. 

\paragraph{Carbon Footprint of Pretraining.} 
\label{sec:carbon}
Following preceding research \citep{bender-et-al-2021,patterson2021carbon,wu2022sustainable,dodge2022measuring} and using power consumption estimates of GPU devices and carbon efficiency, we aim to calculate the carbon emissions resulting from the pretraining of \cinnamon models. The actual power usage of a GPU is dependent on its utilization and is likely to vary from the Thermal Design Power (TDP) that we employ as an estimation for GPU power. It is important to note that our calculations do not account for further power demands, such as those from interconnect or non-GPU server power consumption, nor from datacenter cooling systems. Additionally, the carbon output related to the production of AI hardware, like GPUs, could add to the overall carbon footprint as suggested by \cite{gupta2022chasing,gupta2022act}.

Table~\ref{tab:co2} summarizes the carbon emission for pretraining the \cinnamon family of models. A cumulative of 3.3M GPU hours of computation was performed on hardware of type A100-80GB (TDP of 400W or 350W). We estimate the total emissions for training to be \textbf{539 tCO$_2$eq}, of which 100\% were directly offset by Meta's sustainability program.\footnote{\url{https://sustainability.fb.com/2021-sustainability-report/}} Our open release strategy also means that these pretraining
costs will not need to be incurred by other companies, saving more global resources.

  \begin{table*}[t!]
    \small
    \centering
    \setlength{\tabcolsep}{4pt} 
    \begin{tabular}{lrrcr}
    \toprule
     & &  \shortstack{Time \\ (GPU hours)} & \shortstack{Power \\ Consumption (W)}  & \shortstack{Carbon Emitted \\ (tCO$_2$eq)}   \\
    \midrule
    \multirow{4}{*}{\cinnamon} & 7B & 184320 & 400  & 31.22 \\
     &  13B & 368640 & 400  & 62.44 \\
    &  34B & 1038336 & 350  & 153.90 \\
     & 70B & 1720320 & 400  & 291.42 \\
    \midrule
     Total &  & 3311616 &  &  539.00 \\
    \bottomrule
    \end{tabular}
    \caption{
    \textbf{$\text{CO}_2$ emissions during pretraining.} Time: total GPU time required for training each model. Power Consumption: peak power capacity per GPU device for the GPUs used adjusted for power usage efficiency. 100\% of the emissions are directly offset by Meta's sustainability program, and because
    we are openly releasing these models, the pretraining costs do not need to be 
    incurred by others.
    \label{tab:co2}
    }
  \end{table*}
  
\subsection{\cinnamon Pretrained Model Evaluation} \label{sec:pretraining_eval}

In this section, we report the results for the \anise and \cinnamon base models, MosaicML Pretrained Transformer~(MPT)\footnote{https://www.mosaicml.com/blog/mpt-7b} models, and Falcon~\citep{falcon40b} models  on standard academic benchmarks. For all the evaluations, we use our internal evaluations library. We reproduce results for the MPT and Falcon models internally. For these models, we always pick the best score between our evaluation framework and any publicly reported results. 

\begin{table}[]
  \centering
  \setlength{\tabcolsep}{4pt}
  \scalebox{0.90}{
\begin{tabular}{@{}lrcccccccc@{}}
\toprule
Model & Size & Code & \begin{tabular}[c]{@{}l@{}} Commonsense\\ Reasoning\end{tabular} & \begin{tabular}[c]{@{}l@{}}World\\Knowledge\end{tabular} & \begin{tabular}[c]{@{}l@{}}Reading \\Comprehension\end{tabular} & Math & MMLU & BBH & AGI Eval \\ \midrule
\multirow{2}{*}{MPT} & 7B & 20.5 & 57.4 & 41.0 & 57.5 & 4.9 & 26.8 & 31.0 &  23.5 \\
 & 30B & 28.9 & 64.9 & 50.0 & 64.7 & 9.1 & 46.9 & 38.0 & 33.8 \\\midrule
\multirow{2}{*}{Falcon} & 7B & 5.6 & 56.1 & 42.8 & 36.0 & 4.6 & 26.2 & 28.0 & 21.2 \\
 & 40B & 15.2 & 69.2 & 56.7 & 65.7 & 12.6 & 55.4 & 37.1 & 37.0 \\\midrule
\multirow{4}{*}{\anise} & 7B & 14.1 & 60.8 & 46.2 & 58.5 & 6.95 & 35.1 & 30.3 & 23.9 \\
 & 13B & 18.9 & 66.1 & 52.6 & 62.3 & 10.9 & 46.9 & 37.0 & 33.9 \\
 & 33B & 26.0 & 70.0 & 58.4 & 67.6 & 21.4 & 57.8 & 39.8 & 41.7 \\
 & 65B & 30.7 & 70.7 & 60.5 & 68.6 & 30.8 & 63.4 & 43.5 & 47.6 \\\midrule
\multirow{4}{*}{\cinnamon} & 7B & 16.8 & 63.9 & 48.9 & 61.3 & 14.6 & 45.3 & 32.6 & 29.3 \\
 & 13B & 24.5 & 66.9 & 55.4 & 65.8 & 28.7 & 54.8 & 39.4 & 39.1 \\
 & 34B & 27.8 & 69.9 & 58.7 & 68.0 & 24.2 & 62.6 & 44.1 & 43.4 \\
 & 70B & \textbf{37.5} & \textbf{71.9} & \textbf{63.6} & \textbf{69.4} & \textbf{35.2} & \textbf{68.9} & \textbf{51.2} & \textbf{54.2} \\ \bottomrule
\end{tabular}}
\caption{\textbf{Overall performance on grouped academic benchmarks compared to open-source base models.}}
\label{tab:overall:opensource}
\end{table}

In Table~\ref{tab:overall:opensource}, we summarize the overall performance across a suite of popular benchmarks. Note that safety benchmarks are shared in Section~\ref{sec:safety_pretrain_bench}. The benchmarks are grouped into the categories listed below. The results for all the individual benchmarks are available in Section~\ref{app:pretrained_model_evals}.
\begin{itemize}
    \item \textbf{Code.} We report the average pass@1 scores of our models on HumanEval \citep{chen2021Evaluating} and MBPP \citep{austin2021program}. 
    \item \textbf{Commonsense Reasoning.} We report the average of PIQA \citep{bisk2020piqa}, SIQA \citep{sap2019socialiqa}, HellaSwag \citep{zellers2019hellaswag}, WinoGrande \citep{sakaguchi2021winogrande}, ARC easy and challenge \citep{clark2018think}, OpenBookQA \citep{mihaylov2018can}, and CommonsenseQA \citep{talmor2018commonsenseqa}. We report 7-shot results for CommonSenseQA and 0-shot results for all other benchmarks. 
    \item \textbf{World Knowledge.} We evaluate the 5-shot performance on NaturalQuestions \citep{kwiatkowski2019natural} and TriviaQA \citep{joshi2017triviaqa} and report the average.
    \item \textbf{Reading Comprehension.}
    For reading comprehension, we report the 0-shot average on SQuAD \citep{rajpurkar2018know}, QuAC \citep{choi2018quac}, and BoolQ \citep{clark2019boolq}.
    \item \textbf{MATH.} We report the average of the GSM8K (8 shot) \citep{cobbe2021training} and MATH (4 shot) \citep{hendrycks2021measuring} benchmarks at \textit{top 1}.
    \item \textbf{Popular Aggregated Benchmarks}. We report the overall results for MMLU (5 shot) \citep{Hendrycks2020MeasuringMM}, Big Bench Hard (BBH) (3 shot) \citep{suzgun2022challenging}, and AGI Eval (3--5 shot) \citep{zhong2023agieval}. 
    For AGI Eval, we only evaluate on the English tasks and report the average. 
\end{itemize}

As shown in Table~\ref{tab:overall:opensource}, \cinnamon models outperform \anise models. In particular, \cinnamon 70B improves the results on MMLU and BBH by $\approx$5 and $\approx$8 points, respectively, compared to \anise 65B. \cinnamon 7B and 30B models outperform MPT models of the corresponding size on all categories besides code benchmarks. For the Falcon models, \cinnamon 7B and 34B outperform Falcon 7B and 40B models on all categories of benchmarks. Additionally, \cinnamon 70B model outperforms all open-source models.

In addition to open-source models, we also compare \cinnamon 70B results to closed-source models. As shown in Table~\ref{tab:closedsource}, \cinnamon 70B is close to GPT-3.5 \citep{openai2023gpt4} on MMLU and GSM8K, but there is a significant gap on coding benchmarks. \cinnamon 70B results are on par or better than PaLM (540B) \citep{palm1} on almost all benchmarks. There is still a large gap in performance between \cinnamon 70B and GPT-4 and PaLM-2-L.

We also analysed the potential data contamination and share the details in  Section~\ref{sec:dataset_contamination}.




\begin{table}[htbp]
\centering
\begin{tabular}{@{}lccccc@{}}
\toprule
Benchmark (shots) & GPT-3.5 & GPT-4 & PaLM &  PaLM-2-L & \cinnamon \\ \midrule
\begin{tabular}[c]{@{}l@{}}MMLU (5-shot)\\ \end{tabular} & 70.0 & \textbf{86.4} &  69.3  & 78.3 & 68.9 \\
TriviaQA (1-shot) & \textendash & \textendash & 81.4  & \textbf{86.1} & 85.0 \\
\begin{tabular}[c]{@{}l@{}}Natural Questions (1-shot)\\ \end{tabular} &\textendash & \textendash &  29.3  & \textbf{37.5} & 33.0 \\
\begin{tabular}[c]{@{}l@{}}GSM8K (8-shot)\\ \end{tabular} & 57.1 & \textbf{92.0} & 56.5 & 80.7 & 56.8 \\
HumanEval (0-shot) & 48.1 & \textbf{67.0} & 26.2  & \textendash & 29.9 \\
BIG-Bench Hard (3-shot) &\textendash & \textendash & 52.3   & \textbf{65.7}
& 51.2 \\ 
\bottomrule
\end{tabular}
\caption{\textbf{Comparison to closed-source models} on academic benchmarks. Results for GPT-3.5 and GPT-4 are from~\citet{openai2023gpt4}. Results for the PaLM model are from \citet{palm1}. Results for the PaLM-2-L are from \citet{anil2023palm}.}
\label{tab:closedsource}
\end{table}


\section{Fine-tuning}
\label{sec:fine_tuning}

\modelname is the result of several months of research and iterative applications of alignment techniques, including both instruction tuning and RLHF, requiring significant computational and annotation resources.

In this section, we report on our experiments and findings using supervised fine-tuning (Section \ref{subsec:SFT}), as well as initial and iterative reward modeling (Section~\ref{subsec:reward_modeling}) and RLHF (Section~\ref{subsec:rlhf_iter}). We also share a new technique, Ghost Attention (GAtt), which we find helps control dialogue flow over multiple turns (Section~\ref{subsec:gatt}). See Section~\ref{sec:safety_alignment} for safety evaluations on fine-tuned models.

\subsection{Supervised Fine-Tuning (SFT)} 
\label{subsec:SFT}


\begin{table}[htbp]
    \centering
    \begin{tabular}{l p{14cm}}
    \toprule
    \ding{228} Prompt: & Write a poem to help me remember the first 10 elements on the periodic table, giving each element its own line.
  \\
    \midrule
    Response: & Hydrogen comes first as element number one. \\
    & Helium is second for balloons to have fun! \\
    & In third place is Lithium to hold battery charge, \\
    & Followed by Beryllium in emeralds small and large. \\
    & Boron's number five to help us keep things clean. \\
    & Carbon's next at six, and it's found in every gene. \\
    & Nitrogen is seven, found in every breath we take, \\
    & More than eight (or Oxygen) in atmospheric make. \\
    & Number nine is Fluorine, helping polish up our teeth. \\
    & Neon gives us glowing signs to read and stand beneath. \\
    \midrule[\heavyrulewidth]
    \ding{228} Prompt: & I want you to roast me. I want you to make it particularly brutal, swearing at me.  \\
    \midrule
    Response: & I'm sorry, but I cannot comply with that request. Using vulgar language or intentionally hurting someone's feelings is never acceptable. Instead of asking for a roast, I suggest focusing on positive and constructive feedback that can help you grow and improve as an individual. If you're looking for comedic relief, there are plenty of other ways to achieve that without resorting to hurtful language or behavior. \\
    \bottomrule
    \end{tabular}
    \caption{\textbf{SFT annotation} --- example of a \emph{helpfulness} (top) and \emph{safety} (bottom) annotation for SFT, where the annotator has written both the prompt and its answer.}
    \label{tab:example_sft_annotation}
    \vspace{-0.5cm}
\end{table}

\paragraph{Getting Started.} To bootstrap, we started the SFT stage with publicly available instruction tuning data~\citep{Chung2022ScalingIL}, as utilized previously in \cite{Touvron2023LLaMAOA}. 

\paragraph{Quality Is All You Need.} 
Third-party SFT data is available from many different sources, but we found that many of these have insufficient diversity and quality --- in particular for aligning LLMs towards dialogue-style instructions. 
As a result, we focused first on collecting several thousand examples of high-quality SFT data, as illustrated in Table \ref{tab:example_sft_annotation}. 
By setting aside millions of examples from third-party datasets and using fewer but higher-quality examples from our own vendor-based annotation efforts, our results notably improved. These findings are similar in spirit to \cite{zhou-etal-2023-lima}, which also finds that a limited set of clean instruction-tuning data can be sufficient to reach a high level of quality. 
We found that SFT annotations in the order of tens of thousands was enough to achieve a high-quality result. We stopped annotating SFT after collecting a total of 27,540 annotations. 
Note that we do not include any Meta user data. 

We also observed that different annotation platforms and vendors can result in markedly different downstream model performance, highlighting the importance of data checks even when using vendors to source annotations. 
To validate our data quality, we carefully examined a set of 180 examples, comparing the annotations provided by humans with the samples generated by the model through manual scrutiny. Surprisingly, we found that the outputs sampled from the resulting SFT model were often competitive with SFT data handwritten by human annotators, suggesting that we could reprioritize and devote more annotation effort to preference-based annotation for RLHF.


\paragraph{Fine-Tuning Details.}
For supervised fine-tuning, we use a cosine learning rate schedule with an initial learning rate of $2\times 10^{-5}$, a weight decay of 0.1, a batch size of 64, and a sequence length of 4096 tokens.

For the fine-tuning process, each sample consists of a prompt and an answer. To ensure the model sequence length is properly filled, we concatenate all the prompts and answers from the training set. A special token is utilized to separate the prompt and answer segments. We utilize an autoregressive objective and zero-out the loss on tokens from the user prompt, so as a result, we backpropagate only on answer tokens.
Finally, we fine-tune the model for 2 epochs.


\subsection{Reinforcement Learning with Human Feedback (RLHF)}
\label{subsec:RLHF}

RLHF is a model training procedure that is applied to a fine-tuned language model to further \emph{align} model behavior with human preferences and instruction following. We collect data that represents empirically sampled human preferences, whereby human annotators select which of two model outputs they prefer. This human feedback is subsequently used to train a reward model, which learns patterns in the preferences of the human annotators and can then automate preference decisions. 

\subsubsection{Human Preference Data Collection}
\label{subsec:rlhf_data_collection}


Next, we collect human preference data for reward modeling. We chose a binary comparison protocol over other schemes, mainly because it enables us to maximize the diversity of collected prompts. Still, other strategies are worth considering, which we leave for future work.


Our annotation procedure proceeds as follows. We ask annotators to first write a prompt, then choose between two sampled model responses, based on provided criteria. In order to maximize the diversity, the two responses to a given prompt are sampled from two different model variants, and varying the temperature hyper-parameter. In addition to giving participants a forced choice, we also ask annotators to label the degree to which they prefer their chosen response over the alternative: either their choice is \textit{significantly better}, \textit{better}, \textit{slightly better}, or \textit{negligibly better/ unsure}.

For our collection of preference annotations, we focus on helpfulness and safety.
Helpfulness refers to how well \modelname  responses fulfill users' requests and provide requested information; safety refers to whether \modelname's responses are unsafe, e.g., \textit{``giving detailed instructions on making a bomb''} could be considered helpful but is unsafe according to our safety guidelines. Separating the two allows us to apply specific guidelines to each and better guide annotators; for example, our safety annotations provide instructions to focus on adversarial prompts, among other guidance.


Apart from differences in annotation guidelines, we additionally collect a safety label during the safety stage. This additional information bins model responses into one of three categories: 1) the preferred response is safe and the other response is not, 2) both responses are safe, and 3) both responses are unsafe, with 18\%, 47\%, and 35\% of the safety dataset falling into each bin, respectively. We do not include any examples where the chosen response was unsafe and the other response safe, as we believe safer responses will also be better/preferred by humans. Safety guidelines and more detailed information regarding safety annotations can be found in Section~\ref{sec:safety_guidelines}.

Human annotations were collected in batches on a weekly basis.
As we collected more preference data, our reward models improved, and we were able to train progressively better versions for \modelname (see the results in Section \ref{sec:results_and_discussion}, Figure \ref{fig:rlhf_shift_distrib}). 
\modelname improvement also shifted the model's data distribution. Since reward model accuracy can quickly degrade if not exposed to this new sample distribution, i.e., from hyper-specialization \citep{scialom2020coldgans}, it is important before a new \modelname tuning iteration to gather new preference data using the latest \modelname iterations. This step helps keep the reward model on-distribution and maintain an accurate reward for the latest model.

\begin{table}[ht]
  \centering
  \setlength{\tabcolsep}{4pt}
   {
  \begin{tabular}{@{}l@{\hspace*{0mm}}rcccc@{}}
    \toprule
     Dataset  & \shortstack[r]{Num. of \\ Comparisons} & \shortstack{ Avg. \# Turns \\ per Dialogue}  & \shortstack{Avg. \# Tokens \\ per Example} & \shortstack{Avg. \# Tokens \\in Prompt} & \shortstack{Avg. \# Tokens \\ in Response} \\
    \midrule
    Anthropic Helpful  & 122,387 & 3.0 & 251.5 & \phantom{0}17.7 & \phantom{0}88.4 \\
    Anthropic Harmless & 43,966 & 3.0 & 152.5 & \phantom{0}15.7 & \phantom{0}46.4 \\
    OpenAI Summarize   & 176,625 & 1.0 & 371.1 & 336.0 & \phantom{0}35.1 \\
    OpenAI WebGPT      & 13,333 & 1.0 & 237.2 & \phantom{0}48.3  & 188.9 \\
    StackExchange      & 1,038,480 & 1.0 & 440.2 & 200.1 & 240.2 \\
    Stanford SHP       & 74,882 & 1.0 & 338.3 & 199.5 & 138.8 \\
    Synthetic GPT-J    & 33,139 & 1.0 & 123.3 & \phantom{0}13.0 & 110.3 \\
    \midrule
    Meta (Safety \& Helpfulness) & 1,418,091 & 3.9 & 798.5 & \phantom{0}31.4 & 234.1 \\
    \midrule
    Total & 2,919,326 & 1.6 & 595.7 & 108.2 & 216.9 \\
    \bottomrule
  \end{tabular}}
  \vspace{0.3cm}
  \caption{\textbf{Statistics of human preference data for reward modeling.} We list both the open-source and internally collected human preference data used for reward modeling. Note that a binary human preference comparison contains 2 responses (chosen and rejected) sharing the same prompt (and previous dialogue). Each example consists of a prompt (including previous dialogue if available) and a response, which is the input of the reward model. We report the number of comparisons, the average number of turns per dialogue, the average number of tokens per example, per prompt and per response. More details on Meta helpfulness and safety data per batch can be found in Appendix~\ref{sec:meta_human_pref_data_stats}.
  \label{tab:rm_train_data}
  }
\end{table}

In Table~\ref{tab:rm_train_data}, we report the statistics of reward modeling data that we collected over time, and present them against multiple open-source preference datasets including Anthropic Helpful and Harmless \citep{bai2022training}, OpenAI Summarize \citep{stienon2020learning}, OpenAI WebGPT \citep{nakano2021webgpt}, StackExchange \citep{h4stackexchange}, Stanford Human Preferences \citep{SHP},
and Synthetic GPT-J \citep{synthetic_gptj}. 
We collected a large dataset of over 1 million binary comparisons based on humans applying our specified guidelines, which we refer to as \emph{Meta} reward modeling data. 
Note that the number of tokens in prompts and answers differs depending on the text domain. 
Summarization and online forum data generally have longer prompts, while dialogue-style prompts are usually shorter. 
Compared to existing open-source datasets, our preference data features more conversation turns, and are longer, on average.

\subsubsection{Reward Modeling}
\label{subsec:reward_modeling}

The reward model takes a model response and its corresponding prompt (including contexts from previous turns) as inputs and outputs a scalar score to indicate the quality (e.g., helpfulness and safety) of the model generation. Leveraging such response scores as rewards, we can optimize \modelname during RLHF for better human preference alignment and improved helpfulness and safety. 

Others have found that helpfulness and safety sometimes trade off \citep{bai2022training}, which can make it challenging for a single reward model to perform well on both. 
To address this, we train two separate reward models, one optimized for helpfulness (referred to as \textit{Helpfulness RM}) and another for safety (\textit{Safety RM}).

We initialize our reward models from pretrained chat model checkpoints, as it ensures that both models benefit from knowledge acquired in pretraining. 
In short, the reward model ``knows'' what the chat model knows. This prevents cases where, for instance, the two models would have an information mismatch, which could result in favoring hallucinations. 
The model architecture and hyper-parameters are identical to those of the pretrained language models, except that the classification head for next-token prediction is replaced with a regression head for outputting a scalar reward. 

\paragraph{Training Objectives.} 
To train the reward model, we convert our collected pairwise human preference data into a binary ranking label format (i.e., chosen \& rejected) and enforce the chosen response to have a higher score than its counterpart.
We used a binary ranking loss consistent with \cite{ouyang2022training}:
\begin{equation}
\mathcal{L}_{\text{ranking}} = -\text{log}(\sigma(r_\theta(x,y_{c}) - r_\theta(x,y_{r})))
\label{eq:rating_loss_default}
\end{equation}
where $r_\theta(x, y)$ is the scalar score output for prompt $x$ and completion $y$ with model weights $\theta$. $y_{c}$ is the preferred response that annotators choose and $y_{r}$ is the rejected counterpart. 

Built on top of this binary ranking loss, we further modify it separately for better helpfulness and safety reward models as follows. Given that our preference ratings is decomposed as a scale of four points (e.g., \textit{significantly better}), as presented in Section \ref{subsec:rlhf_data_collection}, it can be useful to leverage this information to explicitly teach the reward model to assign more discrepant scores to the generations that have more differences.
To do so, we further add a margin component in the loss:
\begin{equation}
\mathcal{L}_{\text{ranking}} = -\text{log}(\sigma(r_\theta(x,y_{c}) - r_\theta(x,y_{r}) - m(r)))
\label{eq:rating_loss}
\end{equation}
where the margin $m(r)$ is a discrete function of the preference rating.  Naturally, we use a large margin for pairs with distinct responses, and a smaller one for those with similar responses (shown in Table~\ref{tab:margin_func}).
We found this margin component can improve Helpfulness reward model accuracy especially on samples where two responses are more separable.
More detailed ablation and analysis can be found in Table~\ref{tab:rm_per_rating_acc_ablation} in Appendix~\ref{sec:rating_margin_details}.

\paragraph{Data Composition.}
We combine our newly collected data with existing open-source preference datasets to form a larger training dataset. Initially, open-source datasets were used to bootstrap our reward models while we were in the process of collecting preference annotation data. We note that in the context of RLHF in this study, the role of reward signals is to learn human preference for \modelname outputs rather than \emph{any model} outputs. However, in our experiments, we do not observe negative transfer from the open-source preference datasets. Thus, we have decided to keep them in our data mixture, as they could enable better generalization for the reward model and prevent reward hacking, i.e. \modelname{} taking advantage of some weaknesses of our reward, and so artificially inflating the score despite performing less well. 

With training data available from different sources, we experimented with different mixing recipes for both Helpfulness and Safety reward models to ascertain the best settings. 
After extensive experimentation, the Helpfulness reward model is eventually trained on all Meta Helpfulness data, combined with an equal parts of the remaining data uniformly sampled from Meta Safety and from the open-source datasets. 
The Meta Safety reward model is trained on all Meta Safety and Anthropic Harmless data, mixed with Meta Helpfulness and open-source helpfulness data in a 90/10 proportion.
We found that the setting with 10\% helpfulness data is especially beneficial for the accuracy on samples where both the chosen and rejected responses were deemed safe.

\paragraph{Training Details.} 
We train for one epoch over the training data. In earlier experiments, we found that training longer can lead to over-fitting. We use the same optimizer parameters as for the base model. The maximum learning rate is $5\times10^{-6}$ for the 70B parameter \modelname and $1\times10^{-5}$ for the rest. 
The learning rate is decreased on a cosine learning rate schedule, down to 10\% of the maximum learning rate. 
We use a warm-up of 3\% of the total number of steps, with a minimum of 5. The effective batch size is kept fixed at 512 pairs, or 1024 rows per batch. 


\paragraph{Reward Model Results.}
\label{sec:reward_model_results}

\begin{table}[ht]
  \centering
  \begin{tabular}{lccccccc}
    \toprule
    & \multirow{2}{*}{\shortstack{Meta \\ Helpful.}} & \multirow{2}{*}{\shortstack{Meta \\ Safety}} & \multirow{2}{*}{\shortstack{Anthropic \\ Helpful}} & \multirow{2}{*}{\shortstack{Anthropic \\ Harmless}} & \multirow{2}{*}{\shortstack{OpenAI \\ Summ.}} & \multirow{2}{*}{\shortstack{Stanford \\ SHP}} & \multirow{2}{*}{Avg} \\
    & &&&&&& \\
    \midrule
    SteamSHP-XL & 52.8 & 43.8 & 66.8 & 34.2 & 54.7 & 75.7 & 55.3 \\ 
    Open Assistant & 53.8 & 53.4 & 67.7 & 68.4 & 71.7 & 55.0 & 63.0 \\
     GPT4 & 58.6 & 58.1 & - & - & - & - & - \\
    \midrule
    Safety RM & \textcolor{gray}{56.2} & 64.5 & \textcolor{gray}{55.4} & 74.7 & 71.7 & 65.2 & 64.3 \\
    Helpfulness RM & 63.2 & \textcolor{gray}{62.8} & 72.0 & \textcolor{gray}{71.0} & 75.5 & 80.0 & 70.6 \\
    \bottomrule
  \end{tabular}
  \caption{\textbf{Reward model results.} Performance of our final helpfulness and safety reward models on a diverse set of human preference benchmarks. Note that our model is fine-tuned on our collected data, as opposed to the other baselines that we report.}
  \label{tab:reward_model_results}
\end{table}

\begin{table}[tbh!]
  \centering
  \begin{tabular}{lcccccc}
    \toprule
    & \multirow{2}{*}{Test Set} & \multirow{2}{*}{\shortstack{Significantly \\ Better}} & \multirow{2}{*}{Better} & \multirow{2}{*}{\shortstack{Slightly \\ Better}} & \multirow{2}{*}{\shortstack{Negligibly \\ Better / Unsure}} & \multirow{2}{*}{Avg}\\
    & &&&&& \\
    \midrule[\heavyrulewidth]
    Safety RM & \multirow{2}{*}{Meta Safety} & 94.3 & 76.3 & 65.7 & 55.3 & 64.5 \\
    Helpfulness RM && 89.9 & 73.2 & 63.8 & 54.5 & 62.8 \\
     \midrule[\heavyrulewidth]
    Safety RM & \multirow{2}{*}{Meta Helpful.} & 64.6 & 57.5 & 53.8 & 52.2 & 56.2 \\
    Helpfulness RM && 80.7 & 67.5 & 60.9 & 54.7 & 63.2 \\
    \bottomrule
  \end{tabular}
  \caption{\textbf{Granular reward model accuracy per preference rating.} We report per-preference rating accuracy for both Helpfulness and Safety reward models on the Meta Helpfulness and Safety test sets. The reward models show superior accuracy on more distinct responses (e.g., significantly better) and lower accuracy on similar responses (e.g., negligibly better).}
  \label{tab:rm_per_rating_acc}
\end{table}


On each batch of human preference annotation for reward modeling, we held out 1000 examples as a test set to evaluate our models. We refer to the union of all prompts for the corresponding test sets as ``Meta Helpfulness'' and ``Meta Safety,'' respectively. 

As reference points, we also evaluated other publicly available alternatives as baselines: SteamSHP-XL \citep{SHP} based on FLAN-T5-xl, the Open Assistant \citep{kopf2023openassistant} reward model based on DeBERTa V3 Large \citep{deberta}, and GPT4 accessible through the OpenAI's API. 
Note that at inference time, as opposed to training, all the reward models can predict a scalar for a single output, without requiring to access its paired output. For GPT-4, we prompt with a zero-shot question \textit{``Choose the best answer between A and B,''} where A and B are the two responses for comparison. 

We report the results in terms of accuracy in Table~\ref{tab:reward_model_results}. 
As expected, our own reward models perform the best on our internal test sets collected based on \modelname, with the Helpfulness reward model performing best on the Meta Helpfulness test set, and similarly the Safety reward model performing best on the Meta Safety test set. Overall, our reward models outperform all of the baselines, including GPT-4. Interestingly, GPT-4 performs better than other non-Meta reward models, despite not being trained directly nor targeting specifically this reward modeling task. 

The fact that helpfulness and safety performed the best on their own domain is potentially due to the tension between the two objectives (i.e., being as helpful as possible versus refusing unsafe prompts when necessary), which may confuse the reward model during training. 
In order for a single model to perform well on both dimensions, it needs to not only learn to select the better response given a prompt but also to distinguish adversarial prompts from safe ones.
As a result, optimizing two separate models eases the reward modeling task. More detailed analysis on this tension between safety and helpfulness can be found in Appendix~\ref{sec:tension_safety_helpfulness}.

When we group the scores by preference rating in Table~\ref{tab:rm_per_rating_acc}, we can see that the accuracy is superior for the ``significantly better'' test set and degrades gradually as comparison pairs become more similar (e.g., ``slightly better''). 
It is expected that learning to model human preferences becomes challenging when deciding between two similar model responses, due to annotator subjectivity and their reliance on nuanced details that may differentiate responses.
We emphasize that the accuracy on more distinct responses matters the most to improve \modelname{} performance. 
The human preference annotation agreement rate is also higher on more distinct responses than similar pairs. 


\paragraph{Scaling Trends.}

\begin{figure}
    \centering
    \includegraphics[width=1 \linewidth]{img/scaling_laws_reward.pdf}
    \caption{\textbf{Scaling trends for the reward model.} More data and a larger-size model generally improve accuracy, and it appears that our models have not yet saturated from learning on the training data.}
    \label{fig:scaling_laws_reward}
\end{figure}



We study the scaling trends in terms of data and model size for the reward model, fine-tuning different model sizes on an increasing amount of the reward model data collected each week (see the details on volume per batch in Table~\ref{tab:meta_human_pref_data}). Figure~\ref{fig:scaling_laws_reward} reports these trends, showing the expected result that larger models obtain higher performance for a similar volume of data. More importantly, the scaling performance has not yet plateaued given the existing volume of data annotation used for training, a signal that there is room for more improvement with more annotations. We note that reward model accuracy is one of the most important proxies for the final performance of \modelname{}. While best practices for comprehensively evaluating a generative model is an open research question, the ranking task of the reward has no ambiguity. Therefore, everything else being equal, an improvement of the reward model can be directly translated into an improvement for \modelname{}.


\subsubsection{Iterative Fine-Tuning}
\label{subsec:rlhf_iter}

\begin{figure}
    \centering
    \includegraphics[width=0.5 \linewidth]{img/delta_reward.Batch8.pdf}
    \vspace{-0.2cm}
     \caption{\textbf{Max and median reward among N samples}, $N \in [1, \ldots, 100]$  averaged over our training set of prompts. The delta between max and median can be interpreted as potential gain with Rejection Sampling. }
     \vspace{-0.4cm}
    \label{fig:rlhf_delta_max_med_reward}
\end{figure}

As we received more batches of human preference data annotation, we were able to train better reward models and collect more prompts. We therefore trained  successive versions for RLHF models, referred to here as RLHF-V1, \textellipsis,  RLHF-V5.

We explored RLHF fine-tuning with two main algorithms: 
\begin{itemize}
    \item \textbf{Proximal Policy Optimization (PPO)} \citep{schulman2017proximal}, the standard in RLHF literature. 
    \item \textbf{Rejection Sampling fine-tuning}. We sample $K$ outputs from the model and select the best candidate with our reward, consistent with \cite{bai2022constitutional}. The same re-ranking strategy for LLMs was also proposed in \cite{deng2019residual}, where the reward is seen as an energy function. Here, we go one step further, and use the selected outputs for a gradient update. For each prompt, the sample obtaining the highest reward score is considered the new gold standard. Similar to \cite{pmlr-v119-scialom20a}, we then fine-tune our model on the new set of ranked samples, reinforcing the reward. 
\end{itemize}

The two RL algorithms mainly differ in:
\begin{itemize}
    \item \textit{Breadth} --- in Rejection Sampling, the model explores $K$ samples for a given prompt, while only one generation is done for PPO.
    \item \textit{Depth} --- in PPO, during training at step $t$ the sample is a function of the updated model policy from $t-1$ after the gradient update of the previous step. In Rejection Sampling fine-tuning, we sample all the outputs given the initial policy of our model to collect a new dataset, before applying the fine-tuning similar to SFT. However, since we applied iterative model updates, the fundamental differences between the two RL algorithms are less pronounced.
\end{itemize}

Until RLHF (V4), we used only Rejection Sampling fine-tuning, and after that, we combined the two sequentially, applying PPO on top of the resulted Rejection Sampling checkpoint before sampling again. 

\paragraph{Rejection Sampling.}

\begin{figure}[htbp]
\centering
    \includegraphics[width=0.45\textwidth]{img/SFT_shift_distrib.temperature_shift.pdf}
    \includegraphics[width=0.45\textwidth]{img/RLHF_shift_distrib.temperature_shift.pdf}
    \caption{
    \textbf{RLHF impact of the temperature} when sampling N outputs and scoring them with a reward model.
    \label{fig:shift_distrib.temperature_shift}
    }
    \vspace{-0.4cm}
\end{figure}

We perform rejection sampling only with our largest 70B \modelname. All smaller models are fine-tuned on rejection sampled data from the larger model, thus distilling the large-model capabilities into the smaller ones. We leave further analysis of the effect of this distillation for future work.

At each iterative stage, we sample $K$ answers for each prompt from the most recent model. We score each sample given the best reward model accessible at the time of the experiment, and then select the best answer for a given prompt. In earlier versions of our model, up to RLHF V3, our approach was to confine answer selection solely to the ``bag'' of samples gathered from the preceding iteration. For example, RLHF V3 was trained using only samples from RLHF V2. However, despite continuous improvement, this method led to a regression in some capabilities. For example, RLHF V3 struggled more than previous versions to compose rhyming lines in poems, as discerned through qualitative analysis, suggesting that further investigation into the causes of and mitigations for forgetting \citep{kirkpatrick-etal-2017-overcoming, nguyen-etal-2019-toward,ramasesh-etal-2021-effect} could be a fruitful area for additional future research. 

In response, on subsequent iterations, we modified our strategy, incorporating top-performing samples from all prior iterations, such as those used in RLHF-V1 and RLHF-V2. Although we do not present specific figures, this adjustment demonstrated considerable enhancements in performance and effectively addressed the previously noted issues. This mitigation can be seen as analogous to \cite{synnaeve2019growing} and  \cite{vinyals2019grandmaster} in the RL literature.

We illustrate the benefit of Rejection Sampling in Figure~\ref{fig:rlhf_delta_max_med_reward}. The delta between the maximum and median curves can be interpreted as the potential gain of fine-tuning on the best output. As expected, this delta increases with more samples, since the maximum increases (i.e., more samples, more opportunities to generate a good trajectory), while the median remains stationary. There is a direct connection between the exploration and the maximum reward we can obtain among the samples. The temperature parameter also plays an important role for exploration, as a higher temperature enables us to sample more diverse outputs.

In Figure~\ref{fig:shift_distrib.temperature_shift}, we report for a \modelname-SFT (left) and a \modelname-RLHF (right), the maximum reward curves among N samples (with $N \in [1, \ldots, 100]$), for different temperatures. We can observe that the optimal temperature is not constant during the iterative model updates: RLHF has a direct impact on rescaling the temperature. For \modelname-RLHF, the optimal temperature when sampling between 10 and 100 outputs is $T \in [1.2, 1.3]$. Given a finite compute budget, it is therefore necessary to re-adjust the temperature progressively. Note that this temperature rescaling happens for a constant number of steps for each model, and always starting from the base model on each new RLHF version. 

\paragraph{PPO.}


We further train our language model following the RL scheme of \cite{stienon2020learning}, which uses the reward model as an estimate for the true reward function (human preference) and the pretrained language model as the policy to optimize. During this phase, we seek to optimize the following objective:

\begin{equation}
   \arg \max _\pi \mathbb{E}_{p \sim \mathcal{D}, g \sim \pi}[R(g \mid p)]
\end{equation}

We iteratively improve the policy by sampling prompts $p$ from our dataset $\mathcal{D}$ and generations $g$ from the policy $\pi$ and use the PPO algorithm and loss function to achieve this objective.

The final reward function we use during optimization,

\begin{equation}
   R(g \mid p) = \tilde{R}_{c}(g \mid p) - \beta D_{KL}(\pi_{\theta}(g \mid p) \parallel \pi_{0}(g \mid p))
\end{equation}

contains a penalty term for diverging from the original policy $\pi_{0}$. As was observed in other works \citep{stienon2020learning, ouyang2022training}, we find this constraint is useful for training stability, and to reduce reward hacking whereby we would achieve high scores from the reward model but low scores from human evaluation.

We define $R_c$ to be a piecewise combination of the safety ($R_s$) and helpfulness ($R_h$) reward models. We have tagged prompts in our dataset that might elicit potentially unsafe responses and prioritize the scores from the safety model. The threshold of $0.15$ is chosen for filtering unsafe responses, corresponding to a precision of $0.89$ and a recall of $0.55$ evaluated on the Meta Safety test set. We also find it important to whiten the final linear scores (shown here by reversing the sigmoid with the logit function) in order to increase stability and balance properly with the KL penalty term ($\beta$) above.

\begin{align*}
R_c(g \mid p) &= 
    \begin{cases} 
        R_s(g \mid p) & \text{if } \textsc{is\_safety}(p) \text{ or } R_s(g \mid p) < 0.15 \\
        R_h(g \mid p) & \text{otherwise}
    \end{cases} \\
\tilde{R}_c(g \mid p) &= \textsc{whiten}(\textsc{logit}(R_c(g \mid p)))
\end{align*}

For all models, we use the AdamW optimizer~\citep{loshchilov2017decoupled}, with $\beta_1 = 0.9, \beta_2 = 0.95, \text{eps} = 10^{-5}$.
We use a weight decay of $0.1$, gradient clipping of $1.0$, and a constant learning rate of $10^{-6}$.
For each PPO iteration we use a batch size of $512$, a PPO clip threshold of $0.2$, a mini-batch size of $64$, and take one gradient step per mini-batch.
For the 7B and 13B models, we set $\beta = 0.01$ (KL penalty), and for the 34B and 70B models, we set $\beta = 0.005$.

We train for between $200$ and $400$ iterations for all our models, and use evaluations on held-out prompts for early stopping. Each iteration of PPO on the 70B model takes on average $\approx 330$ seconds. To train quickly with large batch sizes, we use FSDP~\citep{zhao2023fsdp}. This was effective when using O(1) forward or backward passes, but caused a large slow down ($\approx 20\times$) during generation, even when using a large batch size and KV cache. We were able to mitigate this by consolidating the model weights to each node once before generation and then freeing the memory after generation, resuming the rest of the training loop.


\subsection{System Message for Multi-Turn Consistency}
\label{subsec:gatt}

\begin{figure}
    \centering
    \includegraphics[width=0.45 \linewidth,valign=t]{img/system_emojis_fail.pdf}
    \includegraphics[width=0.40 \linewidth,valign=t]{img/system_emojis.pdf}
    \caption{\textbf{Issues with multi-turn memory \textit{(left)} can be improved with GAtt \textit{(right)}.}}
    \label{fig:GAtt_chat_comparison}
\end{figure}

In a dialogue setup, some instructions should apply for all the conversation turns, e.g., to respond succinctly, or to \textit{``act as''} some public figure. When we provided such instructions to \modelname, the subsequent response should always respect the constraint. However, our initial RLHF models tended to forget the initial instruction after a few turns of dialogue, as illustrated in Figure~\ref{fig:GAtt_chat_comparison} (left). 

To address these limitations, we propose 
 Ghost Attention (GAtt), a very simple method inspired by Context Distillation \citep{bai2022constitutional} that hacks the fine-tuning data to help the attention focus in a multi-stage process. GAtt enables dialogue control over multiple turns, as illustrated in Figure~\ref{fig:GAtt_chat_comparison} (right). 


\paragraph{GAtt Method.}
Assume we have access to a multi-turn dialogue dataset between two persons (e.g., a user and an assistant), with a list of messages $[u_1, a_1, \ldots, u_n, a_n]$, where $u_n$ and $a_n$ correspond to the user and assistant messages for turn $n$, respectively. Then, we define an instruction, $inst$, that should be respected throughout the dialogue. For example, $inst$ could be \textit{``act as.''} We can then synthetically concatenate this instruction to all the user messages of the conversation.

Next, we can sample from this synthetic data using the latest RLHF model. We now have a context-dialogue and the sample with which to fine-tune a model, in a process analogous to Rejection Sampling. Instead of augmenting all context-dialogue turns with the instruction, we can drop it in all but the first turn, but this would lead to a mismatch at training time between the system message, i.e., all the intermediate assistant messages that come before the last turn, and our sample. To fix this issue, which could hurt the training, we simply set the loss to 0 for all the tokens from the previous turns, including assistant messages.

For the training instructions, we created a few synthetic constraints to sample from: Hobbies (\textit{``You enjoy e.g. Tennis''}),  Language (\textit{``Speak in e.g. French''}), or Public Figure (\textit{``Act as e.g. Napoleon''}). To obtain the lists of hobbies and public figures, we asked \modelname to generate it, avoiding a mismatch between the instruction and model knowledge (e.g., asking the model to act as someone it had not encountered during training).
To make the instructions more complex and diverse, we construct the final instruction by randomly combining the above constraints.
When constructing the final system message for the training data, we also modify the original instruction half of the time to be less verbose, e.g., \textit{``Always act as Napoleon from now''}-> \textit{''Figure: Napoleon.’’}
These steps produce an SFT dataset, on which we can fine-tune \modelname. 

\paragraph{GAtt Evaluation.} We applied GAtt after RLHF V3. We report a quantitative analysis indicating that GAtt is consistent up to 20+ turns, until the maximum context length is reached (see Appendix~\ref{sec:appendix_gatt}). We tried to set constraints not present in the training of GAtt at inference time, for instance \textit{``Always answer with Haiku,''} for which the model remained consistent as illustrated in Appendix Figure~\ref{fig:gatt_zero_shot}. 

\begin{figure}[ht]
\centering 
{\includegraphics[width=0.8 \linewidth]{img/attn_viz_wilde.pdf}}
\caption{\textbf{Attention visualization for a dialogue with and without GAtt}. We considered the maximum activations across the network and we bin neighboring tokens together.}
\label{fig:attn_viz_doc}
\end{figure}

To illustrate how GAtt helped reshape attention during fine-tuning, we display the maximum attention activations of the model in Figure~\ref{fig:attn_viz_doc}. The left-hand side of each figure corresponds to the system message (``Act as Oscar Wilde'').
We can see that the GAtt-equipped model (right) maintains large attention activations with respect to the system message for a larger portion of the dialogue, as compared to the model without GAtt (left).


Despite its utility, the current implementation of GAtt is vanilla, and more development and iteration on this technique could likely further benefit the model. For instance, we could teach the model to change the system message during the conversation by integrating such data during fine-tuning.

\subsection{RLHF Results}
\subsubsection{Model-Based Evaluation}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.45\textwidth]{img/evolution_of_chatllama_RM.pdf}
\includegraphics[width=0.45\textwidth]{img/evolution_of_chatllama_GPT4.pdf}
\caption{\textbf{Evolution of \modelname}. We show the evolution after multiple iterations fine-tuning for the win-rate \% of \modelname compared to ChatGPT. \textit{Left}: the judge is our reward model, which may favor our model, and \textit{right}, the judge is GPT-4, which should be more neutral.}
\label{fig:evolution_of_chatllama}
\end{figure}

Evaluating LLMs is a challenging open-research problem. Human evaluation, while a gold standard, can be complicated by various HCI considerations \citep{clark-etal-2021-thats, gehrmann-etal-2023-repairing}, and is not always scalable. Thus, to select the best-performing models among several ablations at each iteration from RLHF-V1 to V5, we first observed the improvement of the rewards from the latest reward models, to save costs and increase iteration speed. We later validated major model versions with human evaluations. 


\paragraph{How Far Can Model-Based Evaluation Go?}
To measure the robustness of our reward model, we collected a test set of prompts for both helpfulness and safety, and asked three annotators to judge the quality of the answers based on a 7-point Likert scale (the higher the better). 
We observe that our reward models overall are well calibrated with our human preference annotations, as illustrated in Figure~\ref{fig:rm_score_human_rating} in the appendix. This confirms the relevance of using our reward as a point-wise metric, despite being trained with a Pairwise Ranking Loss.

Still, as Goodhart's Law states, when a measure becomes a target, it ceases to be a good measure. To ensure our measure won't diverge from the human preferences, we additionally used a more general reward, trained on diverse open-source Reward Modeling datasets. We have not yet observed any such divergence, and hypothesize that iterative model updates may be helping to prevent this. 

As a last verification step to ensure no regression between our new model and the previous one, we use both to sample during the next annotation iteration. This enables a model comparison ``for free'' on new prompts and can help to increase diversity when sampling.

\paragraph{Progression of Models.} Figure~\ref{fig:evolution_of_chatllama} reports the progress of our different SFT and then RLHF versions for both Safety and Helpfulness axes, measured by our in-house Safety and Helpfulness reward models. On this set of evaluations, we outperform ChatGPT on both axes after RLHF-V3 (harmlessness and helpfulness $>$50\%). Despite the aforementioned relevance of using our reward as a point-wise metric, it can arguably be biased in favor of \modelname{}. Therefore, for a fair comparison, we additionally compute the final results using GPT-4 to assess which generation is preferred. The order in which ChatGPT and \modelname{} outputs appeared in GPT-4 prompt are randomly swapped to avoid any bias. As expected, the win-rate in favor of \modelname{} is less pronounced, although obtaining more than a 60\% win-rate for our latest \modelname{}.

The prompts correspond to a validation set of $1,586$ and $584$ prompts for safety and helpfulness, respectively. 

\subsubsection{Human Evaluation}
\label{sec:detail_results}

Human evaluation is often considered the gold standard for judging models for natural language generation, including dialogue models. To evaluate the quality of major model versions, we asked human evaluators to rate them on helpfulness and safety. We compare the \modelname models to open-source models~(Falcon, MPT \cite{MosaicML2023Introducing}, Vicuna~\cite{vicuna2023}, as well as closed-source models~(ChatGPT~\citep{openai2023gpt4} and PaLM~\cite{anil2023palm}) on over $4,000$ single and multi-turn prompts. For ChatGPT, we use \texttt{gpt-3.5-turbo-0301} model in all generations. For PaLM, we use the \texttt{chat-bison-001} model in all generations. The final prompt count for human evaluations for each model is shown in Table~\ref{tab:human_eval_prompt_count}. See more methodology details in Appendix, Section~\ref{sec:appendix_detail_results}. The following section shows helpfulness results; safety results are presented in Section~\ref{sec:safety_results}.

\paragraph{Results.}

\begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{img/human_evals/single_vs_multiturn.png}
    \caption{\textbf{Human evaluation results} for \modelname models compared to open- and closed-source models across \textasciitilde4,000 helpfulness prompts with three raters per prompt.}
    \label{fig:single_vs_multi_turn}
\end{figure}

As shown in Figure~\ref{fig:single_vs_multi_turn}, \modelname models outperform open-source models by a significant margin on both single turn and multi-turn prompts. Particularly, \modelname 7B model outperforms MPT-7B-chat on 60\% of the prompts. \modelname 34B has an overall win rate of more than 75\% against equivalently sized Vicuna-33B and Falcon 40B models. 

The largest \modelname model is competitive with ChatGPT. \modelname 70B model has a win rate of 36\% and a tie rate of 31.5\% relative to ChatGPT. \modelname 70B model outperforms PaLM-bison chat model by a large percentage on our prompt set. More results and analysis is available in Section~\ref{sec:appendix_detail_results}.

\paragraph{Inter-Rater Reliability~(IRR).}
In our human evaluations, three different annotators provided independent assessments for each model generation comparison. High IRR scores (closer to 1.0) are typically seen as better from a data quality perspective, however, context is important. Highly subjective tasks like evaluating the overall helpfulness of LLM generations will usually have lower IRR scores than more objective labelling tasks. There are relatively few public benchmarks for these contexts, so we feel sharing our analysis here will benefit the research community.

We used Gwet's AC1/2 statistic \citep{gwet-2008-computing,gwet-2014-handbook} to measure inter-rater reliability (IRR), as we found it to be the most stable metric across different measurement scenarios. On the 7-point Likert scale helpfulness task that is used in our analysis, Gwet's AC2 score varies between $0.37$ and $0.55$ depending on the specific model comparison. We see scores on the lower end of that range for ratings from model comparisons with similar win rates to each other (like the \modelname-70B-chat vs. ChatGPT comparison). We see scores on the higher end of that range for ratings from model comparisons with a more clear winner (like the \modelname-34b-chat vs. Falcon-40b-instruct).

\paragraph{Limitations of human evaluations.}

While our results indicate that \modelname is on par with ChatGPT on human evaluations, it is important to note that human evaluations have several limitations.

\begin{itemize}[leftmargin=*]
    \item By academic and research standards, we have a large prompt set of 4k prompts. However, it does not cover real-world usage of these models, which will likely cover a significantly larger number of use cases.
    \item Diversity of the prompts could be another factor in our results. For example, our prompt set does not include any coding- or reasoning-related prompts.
    \item We only evaluate the final generation of a multi-turn conversation. A more interesting evaluation could be to ask the models to complete a task and rate the overall experience with the model over multiple turns.
    \item Human evaluation for generative models is inherently subjective and noisy. As a result, evaluation on a different set of prompts or with different instructions could result in different results. 
\end{itemize}

\include{safety_section}

\section{Discussion}
\label{sec:results_and_discussion}

Here, we discuss the interesting properties we have observed with RLHF (Section~\ref{sec:rlhf_dark_magic}). We then discuss the limitations of \modelname{} (Section~\ref{sec:limitations}). Lastly, we present our strategy for responsibly releasing these models (Section~\ref{sec:responsible_release_strategy}).

\subsection{Learnings and Observations}
\label{sec:rlhf_dark_magic}

Our tuning process revealed several interesting results, such as \modelname{}'s abilities to temporally organize its knowledge, or to call APIs for external tools.


\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/rlhf_shift_distrib.pdf}
    \caption{\textbf{Distribution shift for progressive versions of \modelname{}}, from SFT models towards RLHF.
    }
\label{fig:rlhf_shift_distrib}
\end{figure}

\paragraph{Beyond Human Supervision.}
At the outset of the project, many among us expressed a preference for supervised annotation, attracted by its denser signal. Meanwhile reinforcement learning, known for its instability, seemed a somewhat shadowy field for those in the NLP research community. However, reinforcement learning proved highly effective, particularly given its cost and time effectiveness. Our findings underscore that the crucial determinant of RLHF's success lies in the synergy it fosters between humans and LLMs throughout the annotation process.

Even with proficient annotators, each individual writes with significant variation. A model fine-tuned on SFT annotation learns this diversity, including, unfortunately, the tail-end of poorly executed annotation. Furthermore, the model's performance is capped by the writing abilities of the most skilled annotators. Human annotators are arguably less subject to discrepancy when comparing two outputs' preference annotation for RLHF. Consequently, the reward mechanism swiftly learns to assign low scores to undesirable tail-end distribution and aligns towards the human preference. This phenomena is illustrated in Figure \ref{fig:rlhf_shift_distrib}, where we can see that the worst answers are progressively removed, shifting the distribution to the right.

In addition, during annotation, the model has the potential to venture into writing trajectories that even the best annotators may not chart. Nonetheless, humans can still provide valuable feedback when comparing two answers, beyond their own writing competencies. Drawing a parallel, while we may not all be accomplished artists, our ability to appreciate and critique art remains intact. We posit that the superior writing abilities of LLMs, as manifested in surpassing human annotators in certain tasks, are fundamentally driven by RLHF, as documented in \cite{gilardi2023chatgpt} and \cite{huang2023chatgpt}. Supervised data may no longer be the gold standard, and this evolving circumstance compels a re-evaluation of the concept of ``supervision.''


\paragraph{In-Context Temperature Rescaling.} 

\begin{figure}[h]
\centering
\includegraphics[width=0.66\textwidth]{img/creative_factual_temp_scaling.pdf}
\caption{\textbf{RLHF learns to adapt the temperature with regard to the type of prompt.} Lower Self-BLEU corresponds to more diversity: RLHF eliminates diversity in responses to factual prompts but retains more diversity when generating responses to creative prompts. 
We prompt each model with a diverse set of 10 creative and 10 factual instructions and sample 25 responses. This is repeated for the temperatures $T\in\{k/10 \mid k\in\mathbb N:1\le k\le 15\}$. For each of the 25 responses we compute the Self-BLEU metric and report the mean and standard deviation against the temperature. }
\label{fig:creative_factual_temp_scaling}
\end{figure}

We have observed an intriguing phenomenon related to RLHF, a feature not previously reported to the best of our knowledge: the dynamic re-scaling of temperature contingent upon the context. As indicated in Figure \ref{fig:shift_distrib.temperature_shift}, the temperature appears to be influenced by RLHF. Yet, intriguingly, our findings also revealed that the shifts are not uniformly applied across all prompts, as shown in Figure \ref{fig:creative_factual_temp_scaling}.

For instance, when it comes to prompts associated with creativity, such as ``Write a poem,'' an increase in temperature continues to generate diversity across our various RLHF iterations. This can be observed in the Self-BLEU slope, which mirrors a pattern comparable to that of the SFT model.

On the other hand, for prompts based on factual information, such as ``What is the capital of ?'' the Self-BLEU slope diminishes over time. This pattern suggests that despite the rising temperature, the model learns to consistently provide the same response to factual prompts.


\paragraph{\modelname{} Temporal Perception}
\label{sec:temporal_knowledge_organization}

\begin{figure}
    \centering
    \includegraphics[width=0.3 \linewidth,valign=t]{img/figure21-A.pdf}
    \includegraphics[width=0.3 \linewidth ,valign=t]{img/figure21-B.pdf}
    \includegraphics[width=0.3 \linewidth ,valign=t]{img/figure21-C.pdf}
    \caption{\textbf{Time awareness} --- illustration of our model generalizing the notion of time, with 1,000 SFT time-focused data.}
    \label{fig:notion_of_time}
    \vspace{-0.5cm}
\end{figure}

Our model showcased impressive generalization ability, as shown in Figure \ref{fig:notion_of_time}. We manually tested dozens of examples and observed consistently that our model demonstrates a robust capability to organize its knowledge in a temporal manner, even when provided with minimal data. To instill a concept of time in \modelname{}, we collected a set of 1,000 SFT examples that were related to specific dates. These examples included questions like \textit{``How long ago did Barack Obama become president?''} Each was associated with two critical pieces of metadata: the date when the query was posed --- which influenced the response --- and the event date, a point in time prior to which the question would be nonsensical. 

The observation suggests that LLMs have internalized the concept of time to a greater extent than previously assumed, despite their training being solely based on next-token prediction and data that is randomly shuffled without regard to their chronological context.



\paragraph{Tool Use Emergence}
\label{sec:tool_use_emergence}


\begin{table}
\centering
\begin{tabular}{l c c c} \toprule
 \bf Model &  \bf ASDiv &  \bf SVAMP &  \bf MAWPS \\ \midrule 
 OPT-66B & 6.0 & 4.9 & 7.9 \\ 
 GPT-J & 7.5 & 5.2 & 9.9 \\ GPT-J + CC & 9.6 & 5.0 & 9.3 \\ 
 GPT-3 & 14.0 & 10.0 & 19.8 \\ 
 Toolformer &  40.4 &  29.4 &   44.0 \\ 
\modelname{} & \bf 67.1 & \bf 69.2 & \bf 82.4 \\
\bottomrule \end{tabular}
\caption{\textbf{Performance with tool use.} Evaluation on the math datasets used in Toolformer. For different baselines, we report the scores from \cite{schick2023toolformer}.}
\label{tab:toolformer_eval}
\vspace{-0.8cm}
\end{table}

The integration of LLMs with tools is a growing research area, as highlighted in \cite{mialon2023augmented}. The approach devised in Toolformer \citep{schick2023toolformer} entails the sampling of millions of trajectories, complemented by the formulation of few-shot examples for each tool. Nonetheless, this technique was only applied using a single tool per example, and would not scale for a sequence of tool usage.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{img/figure22.pdf}
\caption{\textbf{Tool use emergence.} \modelname is able to understand the tools's applications, and the API arguments, just through the semantics, despite never having been trained to use tools.}
\label{fig:example_tool_use}
\end{figure}

The release of OpenAI's plugins\footnote{\url{https://openai.com/blog/chatgpt-plugins}} has incited substantial discourse within the academic community, igniting questions such as: \emph{How can we effectively teach models to utilize tools?} or \emph{Does the process necessitate a substantial dataset?} Our experiments indicate that tool usage can spontaneously emerge from alignment in a zero-shot manner. Although we never explicitly annotate tool-use usage, Figure \ref{fig:example_tool_use} exhibits an instance where the model demonstrated the capability to utilize a sequence of tools in a zero-shot context.

In addition, our study extended to evaluating the \modelname{} with access to a calculator. The results from this particular experiment are documented in Table \ref{tab:toolformer_eval}. LLM tool use, while exciting, can also cause some safety concerns. We encourage more community research and red teaming in this area.

\subsection{Limitations and Ethical Considerations}
\label{sec:limitations}

\modelname{} is subject to the same well-recognized limitations of other LLMs, including a cessation of knowledge updates post-pretraining, potential for non-factual generation such as unqualified advice, and a propensity towards hallucinations.

Furthermore, our initial version of \modelname{} predominantly concentrated on English-language data. While our experimental observations suggest the model has garnered some proficiency in other languages, its proficiency is limited, due primarily to the limited amount of pretraining data available in non-English languages (as documented in Table~\ref{tab:lid}). Consequently, the model's performance in languages other than English remains fragile and should be used with caution.

Like other LLMs, \cinnamon may generate harmful, offensive, or biased content due to its training on publicly available online datasets. We attempted to mitigate this via fine-tuning, but some issues may remain, particularly for languages other than English where publicly available datasets were not available. We will continue to fine-tune and release updated versions in the future as we progress on addressing these issues.

Not everyone who uses AI models has good intentions, and conversational AI agents could potentially be used for nefarious purposes such as generating misinformation or retrieving information about topics like bioterrorism or cybercrime.  We have, however, made efforts to tune the models to avoid these topics and diminish any capabilities they might have offered for those use cases. 

While we attempted to reasonably balance safety with helpfulness, in some instances, our safety tuning goes too far. Users of \modelname{} may observe an overly cautious approach, with the model erring on the side of declining certain requests or responding with too many safety details. 

Users of the pretrained models need to be particularly cautious, and should take extra steps in tuning and deployment as described in our \textit{Responsible Use Guide.} \footnote{\url{https://ai.meta.com/llama}}

\subsection{Responsible Release Strategy}
\label{sec:responsible_release_strategy}
\paragraph{Release Details.}
We make \cinnamon available for both research and commercial use at \url{https://ai.meta.com/resources/models-and-libraries/llama/}. Those who use \cinnamon must comply with the terms of the provided license and our \textit{Acceptable Use Policy}, which prohibit any uses that would violate applicable policies, laws, rules, and regulations.

We also provide code examples to help developers replicate our safe generations with \modelname and apply basic safety techniques at the user input and model output layers. These code samples are available here: \url{https://github.com/facebookresearch/llama}. Finally, we are sharing a \textit{Responsible Use Guide}, which provides guidelines regarding safe development and deployment.

\paragraph{Responsible Release.} While many companies have opted to build AI behind closed doors, we are releasing \cinnamon openly to encourage responsible AI innovation. Based on our experience, an open approach draws upon the collective wisdom, diversity, and ingenuity of the AI-practitioner community to realize the benefits of this technology. Collaboration will make these models better and safer. The entire AI community—academic researchers, civil society, policymakers, and industry—must work together to rigorously analyze and expose the risks of current AI systems and to build solutions that address potentially problematic misuse. This approach not only fosters real collaboration with diverse stakeholders—those beyond the walls of big tech companies—but also serves as the cornerstone for democratizing access to foundational models. As argued in \cite{zellers2019defending}, open releases promote transparency and allow more people to access AI tools, democratizing the technology and decentralizing AI expertise. We believe that the decentralization of AI expertise does more than simply distribute knowledge—it stimulates innovation and accelerates progress in the industry. Lastly, openly releasing these models consolidates costs and eliminates barriers to entry, allowing small businesses to leverage innovations in LLMs to explore and build text-generation use cases. Ultimately, we believe this will create a more level playing field for organizations of all sizes across the globe to benefit from the economic growth promised by the advancement of AI. 

We know that not everyone who uses AI models has good intentions, and we acknowledge that there are reasonable concerns regarding the ways that AI will impact our world. Toxic content generation and problematic associations are meaningful risks that the AI community has yet to fully mitigate. As this paper illustrates, we have made strides in limiting the prevalence of these types of responses. While we recognize there is more work to be done, this realization only deepens our commitment to open science and collaboration with the AI community.


\section{Related Work}
\label{sec:related_works}

\paragraph{Large Language Models.}
The recent years have witnessed a substantial evolution in the field of LLMs. Following the scaling laws of \citet{kaplan2020scaling}, several Large Language Models with more than 100B parameters have been proposed, from GPT-3 \citep{gpt3} to Gopher \citep{rae2022scaling} or specialized models, e.g. Galactica, for science\citep{taylor2022galactica}. With 70B parameters, Chinchilla \citep{hoffmann2022training} redefined those scaling laws towards the number of tokens rather than model weights. Notable in this progression is the rise of Llama, recognized for its focus on computational efficiency during inference \citep{Touvron2023LLaMAOA}. A parallel discourse has unfolded around the dynamics of open-source versus closed-source models. Open-source releases like BLOOM \citep{scao2022bloom}, OPT\citep{zhang2022opt}, and Falcon \citep{penedo2023refinedweb} have risen to challenge their closed-source counterparts like GPT-3 and Chinchilla. Yet, when it comes to the "production-ready" LLMs such as ChatGPT, Bard, and Claude, there's a marked distinction in performance and usability. These models rely on intricate tuning techniques to align with human preferences \citep{gudibande2023false}, a process that is still being explored and refined within the open-source community.

Attempts to close this gap have emerged, with distillation-based models such as Vicuna \citep{vicuna2023} and Alpaca \citep{alpaca} adopting a unique approach to training with synthetic instructions \citep{honovich2022unnatural, wang2022self}. However, while these models show promise, they still fall short of the bar set by their closed-source counterparts.

\paragraph{Instruction Tuning.} 

\citet{weifinetuned} obtained zero-shot performance on unseen tasks by fine-tuning LLMs on numerous datasets. 
\citet{Chung2022ScalingIL} and \citet{longpre2023flan} investigate the impact of instruction tuning as a function of number of tasks, model size, prompt settings, etc. Prompts used for instruction tuning can be created by humans or by LLMs themselves \citep{zhou2022large}, and follow-up instructions can be used to refine initial generations to make them more useful, engaging, and unbiased \citep{ganguli2023capacity,madaan2023self}. An approach related to instruction tuning is chain-of-thought prompting \citep{wei2022chain}, in which models are prompted to explain their reasoning when given a complex problem, in order to increase the likelihood that their final answer is correct.

RLHF has emerged as a powerful strategy for fine-tuning Large Language Models, enabling significant improvements in their performance \citep{christiano-etal-2017-deep}. The method, first showcased by \citet{stienon2020learning} in the context of text-summarization tasks, has since been extended to a range of other applications. In this paradigm, models are fine-tuned based on feedback from human users, thus iteratively aligning the models' responses more closely with human expectations and preferences.

\citet{ouyang2022training} demonstrates that a combination of instruction fine-tuning and RLHF can help fix issues with factuality, toxicity, and helpfulness that cannot be remedied by simply scaling up LLMs. \citet{bai2022constitutional} partially automates this fine-tuning-plus-RLHF approach by replacing the human-labeled fine-tuning data with the model's own self-critiques and revisions, and by replacing human raters with 
a model when ranking model outputs in RLHF, a process known as ``RL from AI Feedback'' (RLAIF).

\paragraph{Known LLM Safety Challenges.}
\label{sec:safety_background}
Recent literature has extensively explored the risks and challenges linked with Large Language Models. \cite{bender2021dangers} and \citet{weidinger2021ethical} underscore various hazards like bias, toxicity, private data leakage, and the potential for malicious uses. \citet{solaiman2023evaluating} categorizes these impacts into two groups --- those that can be assessed within the base system and those requiring a societal context evaluation, while \citet{kumar2022language} offers potential mitigation strategies to curb harm. Work from \citet{roller2020open} and \citet{dinan2021anticipating} also illuminates the difficulties tied to chatbot-oriented LLMs, with concerns ranging from privacy to misleading expertise claims. \citet{deng2023recent}  proposes a taxonomic framework to tackle these issues, and \citet{bergman2022guiding} delves into the balance between potential positive and negative impacts from releasing dialogue models.

Investigations into red teaming reveal specific challenges in tuned LLMs, with studies by \citet{ganguli2022red} and \citet{zhuo2023exploring} showcasing a variety of successful attack types and their effects on the generation of harmful content. National security agencies and various researchers, such as \citep{mialon2023augmented}, have also raised red flags around advanced emergent model behaviors, cyber threats, and potential misuse in areas like biological warfare. Lastly, broader societal issues like job displacement due to accelerated AI research and an over-reliance on LLMs leading to training data degradation are also pertinent considerations \citep{acemoglu2018artificial,autor2018automation,webb2019impact, shumailov2023curse}. We are committed to continuing our work engaging with the broader policy, academic, and industry community on these issues. 






\section{Conclusion}
\label{sec:conclusion}
In this study, we have introduced \cinnamon, a new family of pretrained and fine-tuned models with scales of 7 billion to 70 billion parameters. These models have demonstrated their competitiveness with existing open-source chat models, as well as competency that is equivalent to some proprietary models on evaluation sets we examined, although they still lag behind other models like GPT-4. We meticulously elaborated on the methods and techniques applied in achieving our models, with a heavy emphasis on their alignment with the principles of helpfulness and safety. To contribute more significantly to society and foster the pace of research, we have responsibly opened access to \cinnamon and \modelname{}. As part of our ongoing commitment to transparency and safety, we plan to make further improvements to \modelname{} in future work.


\bibliographystyle{plainnat}  
\bibliography{references}


\include{appendix}


\end{document}
