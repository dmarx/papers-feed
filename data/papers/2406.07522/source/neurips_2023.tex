\documentclass{article}

\usepackage{iclr2025_conference,times}
\iclrfinalcopy

\input{math_commands.tex}


\usepackage{multirow}
\usepackage{arydshln}
\usepackage{wrapfig}
\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage{needspace}
\usepackage{float}
\usepackage{lipsum}
\usepackage[caption = true]{subfig}
\usepackage[T1]{fontenc}
% \usepackagindicatinguse 8-bit T1 fonts
\usepackage{hyperref}       % hyperlinks
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography
% \usepackage[table, svgnames, dvipsnames]{xcolor}       % colors
\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%
\usepackage{graphicx}
\usepackage{amsmath}
% \usepackage{bbm}
\usepackage{cleveref}
\usepackage{amsthm}
\usepackage{verbatim}
\usepackage{listings}
% \usepackage{todonotes}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{comment}
\usepackage{listings}
\usepackage{inconsolata}
\usepackage{makecell}
\usepackage{tabularx} 
\usepackage{adjustbox}
\usepackage{rotating}

% \usepackage{biblatex}
% \theoremstyle{definition}
% \newtheorem{definition}{Definition}[section]
% \theoremstyle{lemma}
% \newtheorem{lemma}{Lemma}[section]
% \theoremstyle{remark}
% \newtheorem*{remark}{Remark}
\usepackage{amssymb}
% \usepackage{tcolorbox,mathtools,biolinum}
\usepackage{hyperref}
\hypersetup{colorlinks,linkcolor={red},citecolor={blue},urlcolor={red}} 
% \tcbuselibrary{skins,theorems}
\usepackage{amsthm}
%\newtheorem{assumption}{Assumption}[section]

\newtheorem{theorem}{Theorem}[]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}


\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=python,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3,
  captionpos=b, 
}

\title{ \textsc{Samba}: Simple Hybrid State Space Models \\ for Efficient Unlimited Context \\ Language Modeling }


\author{%\hspace{-0.1cm}
Liliang Ren$^{1,2}$\thanks{Work partially done during internship at Microsoft.} ~~ Yang Liu$^{1\dag}$ ~~ Yadong Lu$^{1}$\thanks{Equal second-author contribution.} ~~ Yelong Shen$^1$ ~~ \textbf{Chen Liang}$^1$ ~~ \textbf{Weizhu Chen}$^1$\\
$^1$Microsoft ~~ $^2$University of Illinois at Urbana-Champaign\\
\texttt{\{liliangren,yaliu10,yadonglu,yelong.shen,chenliang1,wzchen\}@microsoft.com }}


\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}


\begin{document}


\maketitle

\begin{abstract}
% As humans, we encode the world recurrently and pay attention for precise information recalling.
Efficiently modeling sequences with infinite context length has long been a challenging problem. Previous approaches have either suffered from quadratic computational complexity or limited extrapolation ability in length generalization. In this work, we present \textsc{Samba}, a simple hybrid architecture that layer-wise combines Mamba, a selective State Space Model (SSM), with Sliding Window Attention (SWA). \textsc{Samba} selectively compresses a given sequence into recurrent hidden states while still maintaining the ability to precisely recall recent memories with the attention mechanism.
We scale \textsc{Samba} up to 3.8B parameters with 3.2T training tokens and demonstrate that it significantly outperforms state-of-the-art models across a variety of benchmarks. Pretrained on sequences of 4K length, \textsc{Samba} shows improved perplexity in context lengths of up to 1M in zero-shot. When finetuned on 4K-length sequences, \textsc{Samba} efficiently extrapolates to a 256K context length with perfect memory recall on the Passkey Retrieval task, and exhibits superior retrieval extrapolation on the challenging Phonebook task compared to full-attention models. As a linear-time sequence model, \textsc{Samba} achieves a $3.73\times$ higher throughput compared to Transformers with grouped-query attention for user prompts of 128K length, and a $3.64\times$ speedup when generating 64K tokens with unlimited streaming. 
Our code for training on open source data is publicly available at \url{https://github.com/microsoft/Samba}.

\end{abstract}




\section{Introduction}
% \todo{Research Questions: 1. How to have infinite context length with linear complexity?  }


% \todo{add self-extend baseline of llama-3}


Attention-based models \citep{vaswani2017attention, bahdanau2014neural} have dominated the neural architectures of Large Language Models (LLMs) \citep{gpt2, gpt3, openai2023gpt4, bubeck2023sparks} due to their ability to capture complex long-term dependencies and the efficient parallelization for large-scale training \citep{dao2022flashattention}.
Recently, State Space Models (SSMs) \citep{gu2021efficiently,s5,s4d, gu2023mamba} have emerged as a promising alternative, offering linear computation complexity and the potential for better extrapolation to longer sequences than seen during training. Specifically, Mamba \citep{gu2023mamba}, a variant of SSMs equipped with selective state spaces, has demonstrated notable promise through strong empirical performance and efficient hardware-aware implementation. Recent work also shows that transformers have poorer modeling capacities than input-dependent SSMs in state tracking problems \citep{merrill2024illusion}.
% \todo{2. How to measure the extrapolation ability}
% \todo{For publication: talk about length extrapolation works first (LM infinite, self-extend, longlora, long llama, etc) -> they are not linear complexity or linear complexity but similar performance as SWA -> our work is linear complexity and better than those works (need more experiments to prove this)}
However, SSMs struggle with memory recall due to their recurrent nature \citep{arora2023zoology}, and experimental results on information retrieval-related tasks \citep{h3, wen2024rnns, arora2024simple}, have further shown that SSMs are not as competitive as their attention-based counterparts. 

%Despite the promising aspects of these two architectures, they are not without shortcomings.
%After the sequence length grows beyond a certain size, the computational and memory requirements of full attention-based models become prohibitive because of its quadratic complexity with respect to the input length. 


Previous works \citep{zuo2022efficient, h3, mega, ren2023sparse} have explored various approaches to hybridize SSMs with the attention mechanism, but none have demonstrated significantly better language modeling performance compared to state-of-the-art Transformer architectures. Existing length extrapolation techniques \citep{han2023lminfinite, xiao2023efficient, jin2024llm} designed for attention mechanisms are constrained by quadratic computational complexity or insufficient context extrapolation performance, particularly when evaluated under perplexity metrics.
In this paper, we introduce \textsc{Samba}, a simple neural architecture that harmonizes the strengths of both the SSM and the attention-based models, while achieving a potentially infinite length extrapolation with linear time complexity.
\textsc{Samba} combines SSMs with attention through layer-wise interleaving Mamba \citep{gu2023mamba}, SwiGLU \citep{shazeer2020glu}, and Sliding Window Attention (SWA) \citep{beltagy2020longformer}. Mamba layers capture the time-dependent semantics and provide a backbone for efficient decoding, while SWA fills in the gap modeling complex, non-recurrent dependencies. A detailed discussion of related work is included in \Cref{rel}.


% Extensive engineering effort and ablation studies have been implemented for the design of \textsc{Samba} to perfect training and inference efficiently.  
We scale \textsc{Samba} with 421M, 1.3B, 1.7B and up to 3.8B parameters with 3.2T tokens. In particular, the largest 3.8B post-trained model achieves a 47.9 score for MMLU-Pro \citep{mmlu}, 70.1 for HumanEval \citep{humaneval}, and 86.4 for GSM8K \citep{gsm8k}, substantially outperforming strong open source language models up to 8B parameters, as detailed in \Cref{tab:benchmark-comparison-3.5}. Despite being pre-trained in the 4K sequence length, \textsc{Samba} can be extrapolated to 1M length in zero shot with improved perplexity on Proof-Pile  \citep{proofpile}, achieving a 256$\times$ extrapolation ratio, while still maintaining the linear decoding time complexity with unlimited token streaming, as shown in \Cref{fig:speed}.
We show that when instruction-tuned in a 4K context length with only 500 steps, \textsc{Samba} can be extrapolated to a 256K context length with perfect memory recall in Passkey Retrieval \citep{pk}. In contrast, the fine-tuned SWA-based model simply cannot recall memories beyond 4K length. We further demonstrate that the instruction-tuned \textsc{Samba} 3.8B model can achieve significantly better performance than the SWA-based models on downstream long-context summarization tasks, while still keeping its impressive performance on the short-context benchmarks. In a more challenging multiple key-value retrieval task, Phonebook \citep{jelassi2024repeat}, we demonstrate that instruction fine-tuning enables \textsc{Samba} to bridge the retrieval performance gap with full-attention models, while exhibiting significantly better extrapolation ability when retrieving phone numbers beyond the training context length.
Finally, we perform extensive analyzes and ablation studies across model sizes up to 1.7B parameters to validate the architectural design of \textsc{Samba}. We also offer potential explanations for the effectiveness of our simple hybrid approach through the lens of attention/selection entropy. To the best of our knowledge, Samba is the first hybrid model showing that linear complexity models can be substantially better than state-of-the-art Transformer models on short-context tasks at large scale, while still being able to extrapolate to extremely long sequences under the perplexity metric. 
% We are also the first to propose and prove that instruction tuning on retrieval tasks can elicit the long-term memorization ability of the hybrid models with linear complexity, resulting in significant extrapolation performance gains on downstream tasks such as Passkey Retrieval, Phonebook and long-context summarization.\textcolor{purple}{This seems to be overclaim to me, we just have one hybrid model and two datasets}

% \todo{talk about other hybrid models}
% \todo{try long llama data}
% Compared with its attention-based counterparts and many strong baselines, \textsc{Samba} models achieve superior performance on several benchmark tasks, including language modeling, question answering, and natural language inference, while significantly reducing the computational and memory requirements.
% Our contributions are summarized in three-fold:
% \todo{todo}
% \begin{itemize}

%     \item We propose a simple hybrid state space model, that significantly outperforms ......
%     \item We show that our model can support up to 256K length memory recall with only 500 steps and 4K sequence length instruction tuning.
%     \item We show that Samba has better performance and is more efficient than length extrapolated transformer.
% \end{itemize}

% \section{Background}
% \subsection{Attention-based Models}
% Attention-based models, such as Transformers, have been the cornerstone of many state-of-the-art results in natural language processing tasks. These models utilize a self-attention mechanism that allows each token in the input sequence to attend to all other tokens, thereby capturing complex, long-range dependencies. However, the computational and memory complexity of the self-attention mechanism scales quadratically with the sequence length, making it inefficient for long sequences.
% \todo
% \subsection{State Space Models and MAMBA}
% State Space Models (SSMs) are a class of models that represent the hidden state of a system as a function of its previous state and current input. This recurrent property allows SSMs to efficiently model time-dependent semantics with linear computational and memory complexity. However, the recurrent nature of SSMs also limits their ability to capture long-term dependencies, as the influence of a token on the hidden state diminishes rapidly with time.

% Mamba~\citep{gu2023mamba} is a recently proposed SSM-based model with selective state spaces. This model enables the selective gating of inputs for the SSM recursion, ensuring computational efficiency through the use of a parallel scan algorithm.


% Attention models struggle with computational and memory pressures, especially, with longer sequences, while state space models can still underperform in capturing complex, long-term context. 

% limiting their scalability and accessibility. Sparse attention mechanisms and state space models (SSMs) have been proposed as alternatives to mitigate these issues, yet each approach has its own limitations. In this work, we introduce Sliding Mamba, a novel hybrid selective state space model that combines the strengths of sparse attention and SSMs to achieve efficient and extrapolatable language modeling.




\section{Methodology} \label{meth}

We explore different hybridization strategies consisting of the layers of Mamba, Sliding Window Attention (SWA), and Multi-Layer Perceptron \citep{shazeer2020glu,dauphin2016language}. We conceptualize the functionality of Mamba as the capture of recurrent sequence structures, SWA as the precise retrieval of memory, and MLP as the recall of factual knowledge. We also explore other linear recurrent layers including Multi-Scale Retention \citep{sun2023retentive} and GLA \citep{yang2023gated} as potential substitutions for Mamba in \Cref{linear_exp}. Our goal of hybridization is to harmonize between these distinct functioning blocks and find an efficient architecture for language modeling with unlimited length extrapolation ability.
% \textsc{Samba} is a simple neural architecture that harmonizes the strengths of both SSM-based and attention-based models.
%  The key idea is to decompose the full self-attention mechanism into a combination of SSM and local-window attention. This decomposition allows \textsc{Samba} to efficiently capture both time-dependent semantics and complex, non-recurrent dependencies.

\begin{figure}[h]
\includegraphics[width=13.5cm]{Samba.png}
\caption{From left to right: Samba, Mamba-SWA-MLP, Mamba-MLP, and Mamba. The illustrations depict the layer-wise integration of Mamba with various configurations of Multi-Layer Perceptrons (MLPs) and Sliding Window Attention (SWA). We assume the total number of intermediate layers to be $N$, and omit the embedding layers and output projections for simplicity. Pre-Norm \citep{prenorm,rms} and skip connections \citep{resnet} are applied for each of the intermediate layers.
%Samba uniquely combines the efficiency of SSM with the nuanced context capture of sliding window attention.
}
\label{smamba}
\vspace{-0.4cm}
\end{figure}

\subsection{Architecture} \label{arch}
As illustrated in Figure~\ref{smamba}, we explore three kinds of layerwise hybridization strategies on the 1.7B scale: Samba, Mamba-SWA-MLP, and Mamba-MLP. We also explore other hybridization approaches with full self-attention on smaller scales in \Cref{ana}.
% Samba architecture consists of several key components: the Mamba layer, the Sliding Window Attention (SWA) layers, and the Multi-Layer Perceptron (MLP) layers.
The number of layers $N$ is set to 48 for Samba, Mamba-MLP, and Mamba, while Mamba-SWA-MLP has 54 layers, so each model has approximately 1.7B parameters. We only modify the layer-level arrangement for each of the models and keep every other configuration the same to have apple-to-apple comparisons. More details on the configuration of each layer are explained in the following subsections.
%\todo{talk about samba first, more details of baseline arch}


\subsubsection{Mamba Layer}


Mamba~\citep{gu2023mamba} is a recently proposed SSM-based model with selective state spaces. It enables input-dependent gating to both the recurrent states and the input representation for a soft selection of the input sequence elements. Given an input sequence representation $\mathbf{X}\in \mathbb{R}^{n\times d_m}$, where $n$ is the length of the sequence and $d_m$ is the hidden size, Mamba first expands the inputs to a higher dimension $d_e$, \emph{i.e.},
\[
\mathbf{H} = \mathbf{X} \mathbf{W}_{\text{in}}  ~\in \mathbb{R}^{n\times d_e}
\]
where $\mathbf{W}_{\text{in}} \in \mathbb{R}^{d_m\times d_e}$ is a learnable projection matrix. Then a Short Convolution (SC) \citep{poli2023hyena} operator is applied to smooth the input signal,
\begin{equation}\label{sc}
   \mathbf{U} = \text{SC}(\mathbf{H}) = \text{SiLU}(\text{DepthwiseConv}(\mathbf{H}, \mathbf{W}_\text{conv})) ~\in \mathbb{R}^{n\times d_e} 
\end{equation} 
where $ \mathbf{W}_\text{conv} \in \mathbb{R}^{k \times d_e}$ and the kernel size $k$ is set to 4 for hardware-aware efficiency. The Depthwise Convolution \citep{he2019depthwise} is applied over the sequence dimension followed by a SiLU \citep{silu} activation function. The selective gate is then calculated through a low-rank projection followed by Softplus \citep{softplus},
\begin{equation}\label{sp}
\Delta = \text{Softplus}(\mathbf{U} \mathbf{W}_\text{r} \mathbf{W}_\text{q} + \mathbf{b}) ~\in \mathbb{R}^{n \times d_e}
\end{equation} 
where $ \mathbf{W}_\text{r} \in \mathbb{R}^{d_e\times d_r} $,  $ \mathbf{W}_\text{q} \in \mathbb{R}^{d_r\times d_e} $ and $d_r$ is the low-rank dimension. $\mathbf{b} \in \mathbb{R}^{d_e}$ is carefully initialized so that $\Delta \in [\Delta_\text{min}, \Delta_\text{max}] $ after the initialization stage. We set $[\Delta_\text{min}, \Delta_\text{max}] = [0.001,0.1] $, and find that these values are not sensitive to language modeling performance under the perplexity metric. The input dependence is also introduced for the parameters $\mathbf{B}$ and $\mathbf{C}$ of SSM,
\[
\mathbf{B} = \mathbf{U} \mathbf{W}_\text{b} ~\in \mathbb{R}^{n \times d_s}
\]
\[
\mathbf{C} = \mathbf{U} \mathbf{W}_\text{c} ~\in \mathbb{R}^{n \times d_s}
\]
where $d_s$ is the state dimension. For each time step $1 \leq t \leq n$, the recurrent inference of the Selective SSM (S6) is performed in an expanded state space $\mathbf{Z}_t \in \mathbb{R}^{ d_e \times d_s} $, \emph{i.e.},
\[
\mathbf{Z}_t = \exp(- \Delta_t \odot \exp(\mathbf{A})) \odot \mathbf{Z}_{t-1} + \Delta_t \odot (\mathbf{B}_t \otimes \mathbf{U}_t) ~\in \mathbb{R}^{d_e \times d_s}
\]
\[
\mathbf{Y}_t = \mathbf{Z}_t \mathbf{C}_t  + \mathbf{D} \odot \mathbf{U}_t  ~ \in \mathbb{R}^{d_e}
\]
where $\mathbf{Z}_0 = \mathbf{0}$, $\odot$ means the point-wise product, $\otimes$ means the outer product and $\exp$ means the point-wise natural exponential function. $\mathbf{D} \in \mathbb{R}^{d_e } $ is a learnable vector initialized as $D_i = 1$ and $\mathbf{A} \in \mathbb{R}^{d_e \times d_s}$ is a learnable matrix initialized as $A_{ij} = \log(j), 1\leq j\leq d_s$, following the S4D-Real \citep{s4d} initialization. In practice, Mamba implements a hardware-aware parallel scan algorithm for efficient parallelizable training.
The final output is obtained through a gating mechanism similar to Gated Linear Unit \citep{shazeer2020glu, dauphin2016language},
\[
\mathbf{O} = \mathbf{Y} \odot \text{SiLU}(\mathbf{X} \mathbf{W}_{\text{g}}) \mathbf{W}_{\text{out}} \in \mathbb{R}^{n\times d_m}
\]
where $\mathbf{W}_{g} \in \mathbb{R}^{d_m\times d_e}$ and $\mathbf{W}_{\text{out}} \in \mathbb{R}^{d_e\times d_m}$ are learnable parameters. In this work, we set $d_e = 2 d_m$, $d_r = d_m /16 $, and $d_s = 16$. The Mamba layer in \textsc{Samba} is expected to capture the time-dependent semantics of the input sequence through its recurrent structure. The input selection mechanism in the Mamba layer enables the model to focus on relevant inputs, thereby allowing the model to memorize important information in the long term.

\subsubsection{Sliding Window Attention (SWA) Layer}
We include Sliding Window Attention \citep{beltagy2020longformer} layers to address the limitations of Mamba layers in capturing non-recurrent dependencies in sequences. Our SWA layer operates on a window size $w= 2048$ that slides over the input sequence, ensuring that the computational complexity remains linear with respect to the sequence length. RoPE \citep{su2021roformer} is applied within the sliding window, with a base frequency of 10,000. By directly accessing the contents in the context window through attention, the SWA layer can retrieve high-definition signals from the middle to short-term history that cannot be clearly captured by the recurrent states of Mamba. We use FlashAttention 2 \citep{dao2023flashattention2} for the efficient implementation of self-attention throughout this work. We also choose the 2048 sliding window size for efficiency consideration; FlashAttention 2 has the same training speed as Mamba's 
 selective parallel scan at the sequence length of 2048 based on the measurements in \citep{gu2023mamba}.

\subsubsection{Multi-Layer Perceptron (MLP) Layer}
The MLP layers in \textsc{Samba} serve as the architecture's primary mechanism for nonlinear transformation and recall of factual knowledge \citep{dai2021knowledge}. We use SwiGLU \citep{shazeer2020glu} for all the models trained in this paper and denote its intermediate hidden size as $d_p$. As shown in Figure~\ref{smamba}, Samba applies separate MLPs for different types of information captured by Mamba and the SWA layers. 




\section{Experiments and Results}
\label{headings_exp}

We pre-train four \textsc{Samba} models with different parameter sizes, 421M, 1.3B, 1.7B and 3.8B, to investigate its performance across different scales. The details of the hyperparameters for the training and architecture designs are shown in \Cref{hype} of \Cref{impl}.  We also train other hybrid architectures as mentioned in \Cref{arch}, including the baseline Mamba \citep{gu2023mamba}, Llama-3 \citep{llama3,dubey2024llama}, and Mistral \citep{jiang2023mistral} architecture on a scale of around 1.7B, with detailed hyperparameters in \Cref{hype_base} of \Cref{impl}. We do comprehensive downstream evaluations on a wide range of benchmarks, focusing on four main capabilities of the models: commonsense reasoning (ARC \citep{arc}, PIQA \citep{piqa}, WinoGrande \citep{winogrande}, SIQA \citep{siqa}), language understanding (HellaSwag \citep{zellers2019hellaswag}, BoolQ \citep{boolq}, OpenbookQA \citep{openbookqa}, SQuAD \citep{rajpurkar2016squad}, MMLU \citep{mmlu}, MMLU-Pro \citep{wang2024mmlupro}, GPQA\citep{rein2023gpqa}), truthfulness (TruthfulQA \citep{lin-etal-2022-truthfulqa}) and math and coding (GSM8K \citep{gsm8k}, MBPP \citep{mbpp}, HumanEval \citep{humaneval}).


\begin{table}[h]
\centering
\small
\renewcommand{\arraystretch}{1.1}
\caption{
Downstream performance comparison between Samba-3.8B-IT (preview) and Phi-3-mini-4K on both long-context and short-context tasks. We report 5-shot accuracy (averaged by category) for MMLU, 8-shot CoT \citep{cot} for GSM8K, 0-shot pass@1 for HumanEval, ROUGE-L for both GovReport and SQuALITY. \dag\ Results from the Phi-3 technical report \citep{abdin2024phi3}. } 
\vspace{0.1cm}
\begin{tabular}{c|ccc|cc}
\toprule
\bf Model  &  \bf MMLU & \bf 
GSM8K  & \bf HumanEval & \bf GovReport  & \bf SQuALITY   \\
% &     & \bf 8K  &\bf  Eval & \bf Report  &  \bf  &   \\
\midrule

Phi-3-mini-4K-instruct \dag & 68.8 & 82.5 &  58.5 & 14.4  & \bf 21.6 \\
Samba-3.8B-IT (preview) & \bf 71.9  &  \bf 87.6 & \bf 62.8 &  \bf 18.9    &  21.2  \\

\bottomrule
\end{tabular}
\label{tab:eval_l}
\vspace{-0.4cm}
\end{table}

\subsection{Language Modeling on Textbook Quality Data}

We first present results from our largest 3.8B \textsc{Samba} model, trained on the same data set used by Phi3 \citep{abdin2024phi3} with 3.2T tokens.  We follow the same multiphase pretraining strategy as Phi3-mini, and apply both the original Phi-3-mini post-training recipe and the Phi3-mini-June-2024 recipe to produce our instruction-tuned \textsc{Samba} 3.8B models, \emph{i.e.}, Samba-3.8B-IT (preview) and Samba-3.8B (June) respectively. We report comprehensive benchmark results of the Samba 3.8B base model and Samba-3.8B (June) in \Cref{add_res}. 
%The training takes 14 days on 256 H100 GPUs. 
As shown in \Cref{tab:eval_l}, we evaluate the downstream performance of Samba-3.8B-IT (preview) on both long-context summarization tasks (GovReport \citep{govreport2023}, SQuALITY \citep{squality}) and major short-context benchmarks (MMLU, GSM8K, HumanEval). We can see that Samba has substantially better performance than Phi-3-mini-4k-instruct on both the short-context (MMLU, GSM8K, HumanEval) and long-context (GovReport) tasks, while still having the 2048 window size of its SWA layer and maintaining the linear complexity for efficient processing of long documents. Details of data statistics and evaluation setup for long context tasks are included in \Cref{add_data}.




\begin{table}[h]
\renewcommand{\arraystretch}{1.1}
\centering
\small
\caption{Downstream evaluation of the architectures trained on 230B tokens of the Phi2 dataset. We report the unnormalized accuracy for multiple choice tasks. GSM8K is evaluated with 5-shot examples while other tasks are in zero-shot. Best results are in bold, second best underlined.}
\vspace{0.1cm}
\begin{tabular}{ccccccc}
\toprule
\multirow{2}{*}{\textbf{Benchmark}} &  Llama-3  & Mistral &  Mamba & Mamba-SWA-MLP  &  Mamba-MLP & \textsc{Samba}\\ 
 &   1.6B &   1.6B &  1.8B & 1.6B &  1.9B &  1.7B \\ 

\midrule
ARC-Easy & 76.85  & 77.02  & 77.99 & 76.68 &  \underline{78.91} & \bf 79.25 \\ 
ARC-Challenge & 43.26  & 44.20  & 45.22 &  46.16 & \underline{47.35} & \bf 48.21 \\ 
PIQA & 76.66  & 75.79  & \underline{77.31} & 76.50 & \bf 78.84 & 77.10 \\ 
WinoGrande & 70.01  & 70.72  & \underline{73.40} & \bf{73.72} & 72.38 & 72.93 \\ 
SIQA & 51.23  & 52.00  & 53.12 & \bf 55.12 & \underline{ 54.30} & 53.68 \\ 
\midrule
HellaSwag & 46.98  & 47.19  &\underline{49.80} &  49.71 & \bf{50.14} & 49.74 \\ 
BoolQ & 68.20  & 70.70  & \underline{74.83} & 74.74 & 73.70 & \bf{75.57} \\ 
OpenbookQA & 34.00  & 32.80  & \underline{36.60} & 33.80 & 35.40 & \bf  37.20 \\ 
SQuAD & 74.88  & 72.82  & 67.66 & \underline{76.73} & 63.86 & \bf 77.64 \\ 
MMLU & 43.84  & 43.54  & 45.28 & \underline{47.39} & 43.68 & \bf{48.01} \\ 
\midrule
TruthfulQA (MC1) & 25.70  & 25.09  & 26.81 & 26.20 & \underline{26.44} & \bf 27.78 \\ 
TruthfulQA (MC2) & 40.35  & 38.80  & 40.66 & \underline{40.80} & 40.04 & \bf 41.62 \\ 
\midrule
GSM8K & 32.68  & 32.45  & 32.07 & \bf 44.05 & 27.52 & \underline{38.97} \\ 
MBPP & 46.30  & 47.08  & \underline{47.86} &  47.08 & 47.08 &\bf 48.25 \\ 
HumanEval & 36.59  & 36.59  &  35.98 & \underline{37.80} & 31.10 & \bf 39.02 \\ 
\midrule
\textbf{Average} & 51.17  & 51.12 & 52.31 & \underline{53.77} & 51.38 & \bf 54.33 \\ 

\bottomrule
\end{tabular}
\label{tab:eval2}
\vspace{-0.2cm}
\end{table}










To examine the different hybridization strategies mentioned in \Cref{arch}, we train 6 models with around 1.7B parameters on the Phi2 \citep{li2023textbooks} dataset with 230B tokens and evaluate them in the full suite of 15 downstream benchmarks to have a holistic assessment of hybrid and purebred architectures. As shown in Table~\ref{tab:eval2}, \textsc{Samba} demonstrates superior performance on a diverse set of tasks, including commonsense reasoning (ARC-Challenge), language understanding (MMLU, SQuAD), TruthfulQA and code generation (HumanEval, MBPP).
It outperforms both the pure attention-based and SSM-based models in most tasks and achieves the best average performance.
By comparing the performance of Mamba-MLP and Mamba in Table~\ref{tab:eval2}, we can observe that replacing Mamba blocks with MLPs does not harm common sense reasoning ability, but its performance in language understanding and complex reasoning ability, such as coding and mathematical reasoning, degenerates significantly. We can also see that pure Mamba models fall short on retrieval intensive tasks such as SQuAD due to their lack of precise memory retrieval ability. The best results are achieved through the combination of the attention and Mamba modules, as shown with our Samba architecture. We can also notice that Mamba-SWA-MLP has significantly better performance on GSM8K, potentially resulting from a closer collaboration between the Mamba and the SWA layers. The distinct downstream performances of different hybridization strategies pose interesting future work for developing task-adaptive dynamic architectures. 



%where it significantly outperforms other models, indicating its robustness in complex reasoning and truthfulness assessment.


% how to hybrid model

% slimpajama 1.3 b
% 2. hybrid mamba + SWA,  transformer (sliding-window-attention) 1.3B scale (slim-Pajama) --> downstream task

% 3. hybrid mamba + SWA,  transformer (sliding-window-attention) 1.7B scale 
% (Phi2v6) --> downstream tasks

% mamba+local is better at math tasks such as GSM8K




\subsection{Exploration on Hybridizing Attention and Linear Recurrence} \label{linear_exp}

\begin{table}[!htbp]
\centering
\small
\caption{Perplexity on the validation set of SlimPajama for different attention and linear recurrent model architectures trained at 4,096 context length. We use window size 2,048 for Sliding Window Attention (SWA). The perplexity results have a fluctuation around $\pm 0.3\%$.
%We use a window size of 2,048 for the sliding window attention layers.
} 
\begin{tabular}{lccccccc}
\toprule
\multirow{2}{*}{\bf Architecture} & \multirow{2}{*}{\bf Size } & \multirow{2}{*}{\bf Layers } & \bf Training Speed &  \multicolumn{3 }{c}{\bf Validation Context Length} \\
  & &   &($\times 10^5$ tokens/s) &  4096  &  8192  &   16384 \\ 
\midrule
\multicolumn{6}{l}{\emph{20B training tokens on 8$\times$A100 GPUs}} \\
\midrule
Llama-2     & 438M   & 24 & 4.85 & 11.14 & 47.23 & 249.03 \\
Llama-2-SWA & 438M   & 24 & 4.96 & 11.12 & 10.66 & 10.57 \\
Mamba & 432M    &  60 & 2.46 & 10.70  & 10.30 & 10.24  \\
Sliding GLA      & 438M  & 24  & 4.94 & 10.43 & 10.00 & 9.92 \\
Sliding RetNet & 446M & 24  & 4.32 & 10.38 & 9.96 & 9.87 \\


Mega-S6 & 422M & 24 & 3.26 & 12.63 & 12.25 & 12.25  \\
Mamba-SWA-MLP & 400M & 24 & 4.21 & 10.07 & 9.67 & 9.59  \\
MLP2-SWA-MLP & 417M & 24 & \bf 5.08 & 10.95 & 10.50 & 10.41 \\
\textsc{Samba}-NoPE & 421M  & 24  & 4.48 & 
 10.11  & 28.97 &  314.78 \\
\textsc{Samba} & 421M  & 24  & 4.46 & \bf 10.06  & \bf 9.65 & \bf 9.57 \\
\midrule
\multicolumn{6}{l}{\emph{100B training tokens on 64$\times$H100 GPUs}} \\
\midrule
Llama-2  & 1.3B   & 40  & 25.9 & 7.60  & 44.32 & 249.64 \\
Llama-2-SWA & 1.3B  & 40    &  26.2  & 7.60  & 7.37 & 7.21 \\
Mamba  & 1.3B  & 48 & 17.8  &   7.47  & 7.26&  7.15\\
Sliding GLA     & 1.2B & 36   & 25.9   &  7.58 &  7.35  &  7.19  \\
Sliding RetNet & 1.4B  & 36    & 23.0  & 7.56  & 7.35 & 7.56 \\


Mega-S6 & 1.3B & 36 & 17.9 & 9.01 & 8.81 & 8.68 \\
Mamba-SWA-MLP & 1.3B & 36 & 23.5 & 7.37 & 7.16 & 7.00 \\
MLP2-SWA-MLP & 1.3B & 36 & \bf 26.6 & 7.81 & 7.58 & 7.42 \\
\textsc{Samba}-NoPE & 1.3B  & 36   &  25.2 &   7.33  & 20.40  & 326.17 \\
\textsc{Samba} & 1.3B  & 36   &  25.2 & \bf  7.32  & \bf 7.11  & \bf 6.96 \\
\bottomrule
\end{tabular}
\label{tab:SCs}
\vspace{-0.4cm}
\end{table}


Since SSMs belong to a broader realm of linear recurrent models \citep{lru, hgrn, yang2023gated, katsch2023gateloop, qin2024hgrn2}, there exist multiple alternatives other than Mamba when combing attention-based layers with recurrent neural networks. We also add architecture ablation studies to justify the design choices of Samba. Specifically, in addition to Llama-2, Mamba, Samba and Mamba-SWA-MLP, we investigate the comparative analysis of the following architectures:

% \todo{list and cite benchmarks briefly}
% We conducted a series of experiments comparing different configurations. These configurations include the Llama-2 model, which represents a pure attention-based approach, and the Mamba model, which is purely SSM-based. We also tested hybrid models such as Llama-2-SWA, which replace all layers in Llama-2 to sliding window attention layers. Sliding GLA, which combines global linear attention with sliding window attention, and Sliding RetNet, which integrates a recurrent transformer network with sliding window attention.


\begin{itemize}
        % \item \textbf{Llama-2} \citep{touvron2023llama} is an attention-based Transformer architecture that utilizes full self-attention across the entire sequence. 
        %It uses SwiGLU \citep{shazeer2020glu} for the MLP layers.
    % \item \textbf{Mamba} \citep{gu2023mamba} is an SSM-based architecture that has all the layers as the Mamba layers. \todo

    \item \textbf{Llama-2-SWA} is a pure attention-based architecture that replaces all full attention layers in Llama-2 with sliding window attention. 
    % \item \textbf{Mistral} \citep{jiang2023mistral} is an attention-based architecture that replaces all the full attention layers in Llama-2 with sliding window attention, and the key-value heads are shared between query heads as GQA. 
    % % \item 
    \item \textbf{Sliding RetNet} replaces Mamba layers in the Samba architecture with Multi-Scale Retention ~\citep{sun2023retentive} layers. RetNet is a linear attention model with fixed and input-independent decay applying to the recurrent hidden states.
    \item \textbf{Sliding GLA} replaces Mamba layers in the Samba architecture with Gated Linear Attention (GLA)~\citep{yang2023gated}. GLA is a more expressive variant of linear attention with input-dependent gating.
    \item  \textbf{Mega-S6} replaces all MD-EMA modules in the Mega \citep{mega} architecture 
 with the ShortConv+S6 combinations from Mamba to adapt Mega to the modern Mamba architecture. Rotary position embedding, RMSNorm and Softmax attention are also adopted. We set the intermediate dimension of the Mega-S6 layer to be $d_m$ so that it has a roughly $5d_m^2$ number of parameters. This represents a classical baseline that conducts sequential intra-layer SSM-Attention hybridization.
     \item \textbf{MLP2-SWA-MLP} replaces all Mamba layers in the Samba architecture to SwiGLU layers with $6d_m^2$ number of parameters.
    
     \item \textbf{Samba-NoPE} removes the rotary relative position embedding in Samba and does not have any position embedding in the architecture.


\end{itemize}

% \vspace{-0.4cm}




We pre-train all models on the same SlimPajama \citep{slimpajama} dataset under both around 438M and 1.3B settings, and evaluate these models by calculating perplexity on the validation set with context length at 4096, 8192, and 16384 tokens to investigate their zero-shot length extrapolation ability. Peak training throughput is also measured as an efficiency metric. The details of the hyperparameter settings are included in \Cref{impl}.
As shown in Table~\ref{tab:SCs}, \textsc{Samba} consistently outperforms all other models in different context lengths and model sizes. 
The training speed of \textsc{Samba} is competitive compared to pure Transformer-based models on the 1.3B scale. Mamba has significantly worse training throughput because Mamba layers have slower training speed than MLP layers, and the purebred Mamba models need to have more layers than other models at the same number of parameters. Comparing Mamba-SWA-MLP with Samba, we can see that Samba has slightly better perplexity scores and higher training throughput. Mamba-SWA-MLP trades off the MLP layers with more I/O intensive Mamba and Attention layers, leading to slower training speed. This also indicates that Mamba-SWA-MLP will have slower decoding speed than Samba due to larger total cache size resulting from more SSMs and Attention layers. We can further observe that replacing Mamba with MLP speeds up the training but harms perplexity significantly, indicating the importance of Mamba layers in the Samba architecture. Interestingly, even though we use SWA in Samba architecture, Samba-NoPE still has exploded perplexities beyond its training length without RoPE. 
% We can notice that the full attention-based model cannot extrapolate beyond its context length without specific length extrapolation techniques, which motivates us to use SWA for Samba. % In \Cref{ana}, we further show that even hybridizing with one full attention layer will still lead to exploding perplexity at 16k sequence length. 
We can also find that while RetNet can extrapolate well under the 438M scale, it has an increasing perplexity on 16K length at the 1.4B scale, which may indicate that its input-independent decay may need specific tuning at different scales to work well.

\begin{table}[h]
\centering
\small

    \caption{ Downstream evaluation of models pre-trained with 100B tokens from SlimPajama. We measure the character-normalized accuracy for HellaSwag following \cite{gu2023mamba}. All tasks are evaluated in zero-shot.  }
    \vspace{-0.1cm}
    \label{tab:slim_down}
    \begin{tabular}{lc|ccccc|c}
\toprule
\multirow{2}{*}{\bf Architecture} & \multirow{2}{*}{\bf Size} &  \bf ARC-Easy & \bf HellaSwag & \bf Wino. & \bf PIQA & \bf  LAMBADA & \multirow{2}{*}{ \bf Avg.} \\
    &  & acc $\uparrow$ & acc\_norm $\uparrow$ & acc $\uparrow$ & acc $\uparrow$ & acc $\uparrow$ &  \\
\midrule
LLaMA-2 & 1.3B & 55.09 & 52.32 & 53.35 & 71.11 & 48.52 & 56.08 \\
LLaMA-2-SWA & 1.3B & 56.65 & 52.59 & 54.93 & 71.60 & 47.56 & 56.67 \\
Sliding GLA & 1.2B & 56.94 & 52.52 & \bf 56.75 & 71.38 & 48.17 & 57.15 \\
Sliding RetNet & 1.4B & 57.66 & 52.64 & \bf 56.75 & 71.33 & 48.34 & 57.34 \\
Mega-S6 & 1.3B & 50.63 & 41.91 & 52.96 & 68.17 & 37.88 & 50.31 \\
Mamba & 1.3B & 58.08 & \bf 54.93 & 53.99 & 71.98 & 45.97 & 56.99 \\
Mamba-SWA-MLP & 1.3B &\bf 59.64 & 54.50 & 55.25 & \bf 72.42 & 49.12 & 58.19 \\
MLP2-SWA-MLP & 1.3B & 55.18 & 50.32 & 52.80 & 70.67 & 48.11 & 55.42 \\
\textsc{Samba}-NoPE & 1.3B & \underline{58.38} & 54.62 & 56.51 & 72.03 & \underline{51.08} & \underline{58.52} \\
\textsc{Samba} & 1.3B & 58.21 & \underline{54.73} & 55.72 & \underline{72.36} & \bf 51.68 & \bf 58.54 \\
\bottomrule

    \end{tabular}

\end{table}

 In \Cref{tab:slim_down}, we evaluate all our 1.3B scale models on five typical commonsense reasoning tasks (ARC-Easy, HellaSwag, WinoGrande, PIQA and the OpenAI variant\footnote{\url{https://huggingface.co/datasets/EleutherAI/lambada_openai}} of LAMBADA \citep{paperno2016lambada} ) to understand the effect of architecture designs on downstream performances. We can see that Samba has the best average accuracy, outperforming the LLaMA 2 architectures by a large margin. Similar to our perplexity evaluation, Samba and Samba-NoPE have similar average accuracies, whereas Mamba-SWA-MLP falls slightly behind. We observe that different architectures excel at different tasks. Mamba-SWA-MLP performs best on ARC-Easy, while Samba and Samba-NoPE achieve superior results on LAMBADA. Hybrid models based on Mamba generally outperform hybrid linear attention models and pure softmax-attention models on HellaSwag.





% \todo{arch details}







% Baseline1: Mamba 
% Baseline2: Transformer (Full-Attention)
% Baseline3: Transformer (Sliding-Window Attention)
% Proposal : Mamba+SWA 
% (Validation PPL, and 2x, 4x ppl, 400M)

% 1. hybrid mamba + SWA is better than mamaba, or transformer. validation ppl, training speed;



% MMLU 5-shot is worse than MMLU zero-shot for 1.7B model
\subsection{Efficient Length Extrapolation}
\begin{figure}[!htb]
    \vspace{-0.5cm}
    \centering
        \subfloat[Perplexity on the test set of Proof-Pile]{
          \centering
  \includegraphics[width=.4\linewidth]{ppl.pdf}
}
\hspace{0.5cm}
    \subfloat[{Decoding throughput with batch size 16  }]{
  \centering
  \includegraphics[width=.4\linewidth]{gen_speed.jpg}
}\\
 \vspace{-0.2cm}
    \caption{\textsc{Samba} shows improved prediction up to 1M tokens in the Proof-Pile test set
    %, a dataset of mathematical and scientific documents, 
    while achieving a 3.64$\times$ faster decoding throughput than the Llama-3 architecture on 64K generation length. 
    %.
    We also include an SE-Llama-3 1.6B baseline which applies the SelfExtend \citep{jin2024llm} approach for zero-shot length extrapolation. All models are trained with 4K sequence length. }
    \label{fig:speed}
    \vspace{-0.2cm}
\end{figure}


% phi2 1.7b 


We use the test split of the Proof-Pile \citep{proofpile} dataset to evaluate the length extrapolation ability of our models at a scale of around 1.7B parameters. We follow Position Interpolation \citep{chen2023extending} for data pre-processing. The sliding window approach \citep{press2021train} is used for the perplexity evaluation with a window size of 4096. 
Besides having the decoding throughput in \Cref{fig:speed} for the generation efficiency metric, we also measure the prompt processing speed in \Cref{fig:prefill} of \Cref{add_res} for the models \textsc{Samba} 1.7B, Mistral 1.6B, Mamba 1.8B, Llama-3 1.6B and its Self-Extended \citep{jin2024llm} version SE-Llama-3 1.6B with the prompt length sweeping from 1K to 128K. We set the group size to 4 and the neighborhood window to 1024 for Self-Extension.
We fix the total processing tokens per measurement to be 128K and varying the batch size accordingly. 
The throughput is measured on a single A100 GPU with the precision of bfloat16. We repeat the measurements 10 times and report the averaged results. 
We can see that Samba achieves $3.73\times$ higher throughput in prompt processing compared to Llama-3 1.6B at the 128K prompt length, and the processing time remains linear with respect to the sequence length. We can also observe that the existing zero-shot length extrapolation technique introduces significant inference latency overhead on the full-attention counterpart, while it still cannot extrapolate infinitely with perplexity performance comparable to that of Samba. In \Cref{fig:speed}, we can also see that Mamba has a slowly and stably increasing perplexity up to 1M sequence length, which indicates that linear recurrent models can still not extrapolate infinitely if the context length is extremely large.
% We can see that by training with only 4K sequences length, SAMBA shows improved prediction even up to 1M tokens, while achieving
% a 3.64× faster decoding throughput than the Llama-3 architecture.



\subsection{Long-Context Understanding}

\begin{figure}[!htbp]
    \centering
    \begin{minipage}{.55\textwidth}
      \raggedleft
      \includegraphics[width=\linewidth]{combined_heatmap.pdf}
      \caption{Passkey Retrieval performance up to 256K context length for \textsc{Samba} 1.7B (Left) vs. Mistral 1.6B (right) instruction tuned on 4K sequence length with 500 steps.}
      \label{fig:pk}
    \end{minipage}%
    \hfill
    \begin{minipage}{.4\textwidth}
      \raggedright
      \includegraphics[width=\linewidth]{Phonebook.pdf}
      \caption{Phonebook evaluation accuracy of different base models.}
      \label{fig:pb}
    \end{minipage}
    \vspace{-0.3cm}
\end{figure}

Beyond its efficiency in processing long context, Samba can also extrapolate its memory recall ability to 256K context length through supervised fine-tuning, and still keeps its linear computation complexity. We fine-tune Samba 1.7B on Passkey Retrieval with a 4K training sequence length for only 500 steps.
%\todo{more details in app.}
As presented in Figure~\ref{fig:pk}, \textsc{Samba} 1.7B demonstrates a remarkable ability to recall information from significantly longer contexts compared to Mistral 1.6B, a model based solely on Sliding Window Attention (SWA). This capability is particularly evident in the heatmap, where \textsc{Samba} maintains the perfect retrieval performance across a wider range of pass-key positions in a long document of up to 256K length. We also draw the training loss curve and the overall passkey retrieval accuracy across the fine-tuning procedure in \Cref{fig:loss_pk}  and \Cref{fig:acc_pk} of \Cref{pk}. We find that despite the fact that both architectures can reach near-zero training loss in less than 250 steps, Samba can achieve near-perfect retrieval early at 150 training steps, while the Mistral architecture struggles at around 30\% accuracy throughout the training process. This shows that Samba can have better long-range retrieval ability than SWA due to the input selection mechanism introduced by the Mamba layers.  In \Cref{fig:acc_pk}, we can also notice that the pre-trained base Samba model has a retrieval accuracy (at step 0) similar to that of Mistral, highlighting the need for future work to improve Samba's zero-shot retrieval capabilities. 




The encouraging results on Passkey Retrieval drives us to further explore the limits of our finetuning approach. We perform instruction tuning to the Samba-3.8B base model on Phonebook \citep{jelassi2024repeat} with only 100 steps on 4K sequence length and evaluate the resulting Samba-3.8B-FT model for a sequence length up to 8K. The evaluation setting requires the models to retrieve a random phone number from a phone book containing 20 (length 400) to 480 (length 8400) name-number pairs, resulting in a pressure test of memorization to Samba which has a constant memory state size.
Surprisingly, as shown in \Cref{fig:pb}, we can see that the Samba-3.8B-FT model can close most of its gap with a full-attention model (Llama2 7B) that has twice the parameter size within the 4K training length, and achieves much better extrapolation accuracy compared to all other models including the Phi3 base model which also uses 2K sliding window attention. Since both Passkey Retrieval and Phonebook require models to remember numbers in a long context document, it is interesting to investigate if a model instruction-tuned on one task can transfer its ability to the other task in zero-shot. We directly evaluate the Passkey Retrieval finetuned Samba 1.7B and Mistral 1.6B models (named Samba 1.7B PK-FT and Mistral 1.6B PK-FT respectively) on the Phonebook task. As shown in \Cref{fig:pb}, Samba 1.7B has slightly better retrieval accuracy than Mistral 1.6B, but both models cannot generalize their number recall ability beyond its sliding window size. We leave it for future work to further explore the transferability of long-context capabilities in linear complexity models. 

% The impressive results on synthetic retrieval tasks encourage us to perform a full-cycle post-training of the Samba-3.8B model following the original Phi3-mini-4k recipe, and we find that post-trained Samba-3.8B can achieve significantly better performance than Phi3-mini-4k in long-context summarization tasks, with detailed results in \Cref{add_res}.




\section{Analysis} \label{ana}



% 1. fix window size and training tokens per step, varying context

% 2. fix context, varying window size
In this section, we analyze the experimental results of \textsc{Samba} by answering the following research questions. The perplexity results
on SlimPajama have a fluctuation around $\pm 0.3\%$. Training speed is measured on 8$\times$H100 GPUs by default. All the models in this section are trained on SlimPajama with 20B tokens and 4K sequence length, unless otherwise specified. We also have additional analyses on the effectiveness of short convolution in \Cref{add_ana}.
% We also include additional analyses of the functionality of the Short Convolution in \Cref{add_ana}.


\paragraph{Why not hybridize with full attention?} Some previous works \citep{h3,lieber2024jamba} suggest a hybrid architecture of Mamba with full attention. However, as shown in \Cref{tab:full}, the extrapolation perplexity is exploding at a context length of 16K even if a single full attention layer is placed at the beginning of the model. Although hybridization with full attention in the second and middle sixth blocks (the fourth row in the table), following \cite{dao2022hungry}, can bridge the perplexity gap between full-attention hybrids and Samba, they still cannot extrapolate beyond the training sequence lengths.
 Samba also has much better training throughput compared to Mamba-MLP alternatives because self-attention with the FlashAttention 2 implementation is more training efficient than Mamba when the sequence length is 4096.


\begin{table}[h]
\centering
\small
\caption{Perplexity on SlimPajama of Mamba-MLP architectures with full attention layers replacing Mamba layers at different block indices. We define a block as two consecutive layers with a Mamba/Attention layer followed by an MLP. All the models have 12 blocks in total.} 
\vspace{0.cm}
\begin{tabular}{ccccccc}
\toprule
\multirow{2}{*}{\bf Architecture} & \multirow{2}{*}{\bf Size} & \bf Block Index     & \bf Training Speed &  \multicolumn{3 }{c}{\bf Validation Context Length} \\
 &  & \bf of Full Attention &  ($\times 10^5$ tokens/s) &  4096  &   8192 &   16384 \\ 
\midrule
% \multicolumn{6}{l}{\emph{20B training tokens}} \\
% \midrule

\multirow{4}{*}{ Mamba-MLP} & 449M & 11 & 7.78   & 10.29 & 10.53 & 13.66 \\
& 449M  & 5  & 7.78   & 10.10 & 10.05 & 12.83  \\
& 449M  & 0  & 7.78   & 10.89 & 10.55 & 10.63  \\
 & 443M   & 1, 5  & 7.93  & \bf 10.06 & 10.34 & 13.57 \\
 \midrule
\textsc{Samba} & 421M  & SWA at odd indices  & 8.59 & \bf 10.06  & \bf 9.65 & \bf 9.57 \\

\bottomrule
\end{tabular}
\label{tab:full}
\vspace{-0.2cm}
\end{table}





\begin{table}[!htp]
\centering
\small
\caption{Perplexity on SlimPajama of Llama-2-SWA and Samba models at the 430M scales trained with different number of Query and Key-Value heads. ``KV Size'' means the size of Key-Value vectors per token and attention layer. Since grouped query attention will reduce the parameters for attention from $4d_m^2$ to roughly $2d_m^2$, we increase the intermediate size of MLP from $8/3 d_m$ to $3 d_m = 4608$ to have roughly the same number of total parameters as the original models. } 
\vspace{0.cm}
\begin{tabular}{ccccccccc}
\toprule
\bf Query & \bf Key-Value  & \multirow{1}{*}{ \bf Head } & \multirow{1}{*}{ \bf KV }  & \multirow{1}{*}{ \bf Model} & \bf Training Speed &  \multicolumn{3 }{c}{\bf Validation Context Length} \\
 \bf Head & \bf Head & \bf Dim. & \bf Size & \bf Size &  ($\times 10^5$ tokens/s)  &  4096  &   8192 &   16384 \\ 
\midrule
\multicolumn{6}{l}{\emph{Llama-2-SWA Architecture} } \\
\midrule

12      &  2   &  128  & 512  & 419M & 10.01 & 11.11 & 10.64 & 10.56 \\
6       &  1   &  256  & 512   & 419M & 9.98 & 11.09 & 10.62 & 10.54 \\
12      &  1   &  128 & 256  & 414M  & 10.25 & \bf 10.89 & \bf 10.44 & \bf 10.35 \\
12      &  4   &  128  & 1024  & 428M & 9.85  &   11.11    &  10.64    &  10.56 \\
\midrule
\multicolumn{6}{l}{\emph{Samba Architecture}} \\
\midrule
12      &  2   & 128  &  512 & 426M & 8.55 & 10.09 & 9.68 & 9.60 \\
6      &  1   & 256  &  512 & 426M  & 8.46 & \bf 9.99 & \bf 9.59 & \bf 9.51 \\
12      &  1   &  128 & 256  & 424M  & 8.62 & 10.07 & 9.66 & 9.58 \\
12      &  4   &  128  & 1024  & 431M & 8.57 & 10.02 & 9.62 & 9.55 \\

\bottomrule
\end{tabular}
\label{mqa}
\vspace{-0.4cm}
\end{table}



\paragraph{How many parameters should be allocated to Attention?} 
% The layer-wise combination of Attention and SSM allows us to adjust the compute allocated for different token-mixers easily through modifying their number of parameters. Intuitively,
Given that Mamba can already capture low-rank information in the sequences through recurrent compression, the attention layers in Samba theoretically will only need to focus on information retrieval where a small number of attention heads should suffice. In \Cref{mqa}, we explore the techniques of query head grouping \citep{ainslie2023gqa,shazeer2019fast}, for both the Llama and Samba models. Surprisingly, both the Llama-2-SWA architecture and the Samba architecture show improved validation perplexity when there is only one key-value head. We conjecture that this is because small language models can be more easily optimized with fewer KV heads to pay attention to the contexts. We can also see that Samba has a $2 \times$ smaller optimal number of query heads than the SWA model, which confirms our hypothesis that Samba can support a smaller number of attention heads.





% \paragraph{What makes linear recurrent model efficiently length extrapolatable?} 

% Gating visualization

\paragraph{Potential explanations on why hybrid is better?}


We examine the entropy of the attention distributions for both the Samba 1.7B and the Mistral 1.6B models. As shown in \Cref{fig:ent_attn}, the Samba model has a larger variance of the attention entropy distributed over the layer indices, with an interesting pattern that the upper and lower layers have entropy higher than the middle layers. This may indicate that the attention layers are more specialized in the Samba architecture, with the middle layers focusing on precise retrieval with low-entropy attention, and the top and bottom layers focusing on integrating the global information through high-entropy attention. We can also see in \Cref{fig:ent_mb} that, compared to the Mamba-MLP model, Samba has a higher entropy of input selection probabilities in the middle layers. This indicates that, given the memory recalling ability of the attention layers, the Mamba layers can focus more on modeling the recurrent structure rather than performing retrieval with precise input selections. This kind of specialization can be beneficial for the downstream model performance, which may explain the impressive results from the Samba architecture. Details on how entropy is calculated are included in \Cref{app_ent}.


\begin{figure}[h]
\vspace{-0.4cm}
    \centering
        \subfloat[Average attention entropy per decoding step ]{
          \centering
  \includegraphics[width=.47\linewidth]{entroy_attn.pdf} \label{fig:ent_attn}
}
    \subfloat[Average S6 selection entropy on full sequences ]{
  \centering
  \includegraphics[width=.47\linewidth]{entroy_mb.pdf}\label{fig:ent_mb}
}\\
    \caption{The average entropy of the attention mechanism and the Mamba's S6 input selection mechanism at each block of layers on 100 random samples from the GSM8K dataset.}
    \label{fig:ent}
    \vspace{-0.4cm}
\end{figure}
% \paragraph{Why mamba is bad at explicit long-context retrieval}



% \paragraph{Generation samples of Samba and Mistral on HumanEval and GSM8K?}
% \paragraph{Generation samples of Samba and Mistral on Long Context?}
% verify input selection on summarization
% \paragraph{explore parameter allocation between mamba and SWA}



% find that this operator is also beneficial for other linear recurrent models and even for self-attention as shown in  of \Cref{pk}



\section{Conclusion}
In this paper, we introduce \textsc{Samba}, a simple yet powerful hybrid neural architecture designed for efficient language modeling with unlimited context length. We show that \textsc{Samba} substantially outperforms state-of-the-art pure attention-based and SSM-based models across a wide range of benchmarks including common-sense reasoning, language understanding, mathematics and coding.
%with results indicating significant improvements in  memory recall.
Furthermore, \textsc{Samba} exhibits remarkable efficiency in processing long contexts, achieving substantial speedups in prompt processing and decoding throughput compared to the state-of-the-art Transformer architecture. The architecture's ability to extrapolate memory recall to very long contexts (up to 256K) through minimal fine-tuning underscores its practical applicability for real-world tasks requiring extensive context understanding. This efficient long-term memorization ability is further demonstrated to be useful by our evaluations in downstream long-context summarization tasks.
Our analyses also provide insight into the optimal training configurations for hybrid models and underscore the benefits of combining attention mechanisms with SSMs. We find that allocating fewer parameters to the attention mechanism while leveraging Mamba's strengths for capturing recurrent structures leads to more efficient and effective language modeling. Our results suggest that \textsc{Samba} is a strong neural architecture for language modeling with unlimited context length. 
%Future work may explore better hybrid architectures and length extrapolation.

% 

\section*{Acknowledgement}
We want to thank Shuohang Wang and Liyuan Liu for helping with the training infrastructure, Mojan Javaheripi and the team for the pre-training data, Ziyi Yang, Jianwen Zhang, Junheng Hao and the team for helping with post-training. The first author also wants to thank Songlin Yang for her Triton implementation of Mamba.



\medskip


{
\small


\bibliography{references}
% \bibliographystyle{alpha}
\bibliographystyle{iclr2025_conference}
}

\appendix

\section{Related Works} \label{rel}
\paragraph{Hybrid Recurrent Models} Many recent works \citep{park2024mamba,jelassi2024repeat,akyürek2024incontext} point out the lack of retrieval ability of linear SSMs, and propose hybridization of SSMs with the Attention mechanism. However, the history of SSM/RNN-Attention hybridization can be directly dated back to the birth of the Attention mechanism \citep{bahdanau2014neural} which is proposed as a soft feature alignment technique for recurrent models to cope better with long sequences. The revitalization of the fact that linear recurrent models are sequentially parallelizable \citep{parallrnn,gu2021efficiently} has catalyzed a contemporary renaissance in hybrid recurrent architectures. SPADE \citep{zuo2022efficient}, GSS \citep{gss}, MEGA \citep{mega}, Block State transformers \citep{fathi2023blockstate} and Megalodon \citep{ma2024megalodon} combine SSMs with chunked attention, while H3 \citep{dao2022hungry}, Mambaformer \citep{park2024mamba} and Jamba \citep{lieber2024jamba,team2024jamba15} propose to hybridize with quadratic self-attention. Our works focus particularly on the wall-time efficiency and the length extrapolatability of the hybrid SSM-Attention models, and propose to interleave SSMs with Sliding Window Attention (SWA), which has both linear computation complexity and the translation-invariant property over the sequence length. Infini-Attention \citep{munkhdalai2024leave} is a recently proposed method that implements an intra-layer hybridization \citep{wu2022memorizing} between SWA and Linear Attention with the delta rule \citep{fastweight}. While the preliminary results look promising, its performance in the setting of large-scale pre-training from scratch remains questionable. The most similar work to ours is Griffin \citep{de2024griffin}, which interleaves the Real-Gated Linear Recurrent Unit (RG-LRU) with Sliding Window Attention (SWA).
%However, we want to point out that it is a concurrent work since our Samba 1.7B model finished training with the final checkpoint being saved in the cloud server at a time stamp of 2/11/24, 6:16PM PDT, which is well before the Griffin paper being announced on arXiv.
However, Samba hybridizes SWA with Mamba instead of RG-LRU and shows that this simple hybrid architecture can provide substantially better performance over state-of-the-art Transformer architectures across scales, while Griffin and its follow-up work RecurrentGemma \citep{botev2024recurrentgemma} only show comparable or worse results than Transformers. The original Mamba paper \citep{gu2023mamba} also explores hybridizing pure Mamba models with full attention or MLP layers, but it does not consider the wall-time efficiency of these hybridization and only achieves marginally better performance than the pure Mamba model. In contrast, we are the first to show that interleaving Mamba with both SWA and MLP can substantially outperform modern Transformers (and Mamba) at a scale up to 3.8B parameters, while achieving comparable training speed and better length extrapolation ability under the perplexity metrics. 

\paragraph{Efficient Sparse Attention} Previous works have proposed sparsifying self-attention \citep{vaswani2017attention} with a static attention pattern \citep{child2019generating,zaheer2020big,beltagy2020longformer} or a dynamic learnable pattern \citep{routing,kitaev2020reformer,ren2023sparse} to model long sequences with subquadratic complexity over the sequence length. However, due to the lack of hardware-aware efficient implementation, its actual wall-time training efficiency is often worse than the dense attention optimized with FlashAttention \citep{dao2022flashattention,dao2023flashattention2,shah2024flashattention3}. In this work, we choose Sliding Window Attention, a simple static sparse attention pattern, because it can easily leverage the highly optimized FlashAttention kernels to enjoy an actual training speed-up over its dense self-attention counterpart.



\paragraph{Length Extrapolation} 
 Many previous works have focused on extending the context length of pretrained Transformers to improve their performance on long-context tasks. Methods such as LM-Infinite \citep{han2023lminfinite}, StreamingLLM \citep{streamllm}, and LongLoRA \citep{chen2023longlora} achieve linear complexity for length extrapolation, but they can only stabilize perplexity beyond the training sequence length rather than significantly improve it. In contrast, we demonstrate that pre-training Transformers with Sliding Window Attention from scratch enables natural improvements in perplexity beyond the training sequence length. Other approaches, including LLaMA-2-Long \citep{xiong2023effective}, LongLLaMA \citep{tworkowski2023focused}, PI \citep{chen2023extending}, LongRoPE \citep{ding2024longrope} and Self-Extend \citep{jin2024llm}, attempt to extend the full attention through modifying position embedding or continual training strategies, but they typically retain quadratic complexity in the attention mechanism with additional computation or memory I/O overhead, therefore they do not scale well to very long sequences. Although these methods achieve an improved perplexity on a sequence length that is multiple times longer than the training sequence length, their perplexity still explodes if the sequence is extremely long. Our method achieves both linear complexity and superior extrapolation performance compared to zero-shot length extrapolation methods, such as Self-Extend, under the perplexity metric. However, we acknowledge that, in terms of zero-shot retrieval performance, our method still lags behind these approaches. This underscores a trade-off between perplexity and retrieval performance in length extrapolation, which we plan to explore and address in future work. 


\section{Additional Evaluation Results} \label{add_res}
% \todo{talk about baselines}
% \todo{list generation config in appendix}
% \todo{check real outputs of GSM8K}


 In Table~\ref{tab:eval1}, we conduct comprehensive evaluations on a diverse subset of benchmarks to assess \textsc{Samba} 3.8B base model's performance across all the domains mentioned in \Cref{headings_exp} to ensure a thorough examination of the model's capabilities.  We also report the performance of the Transformer++ (TFM++) model, which uses the same architecture, pre-training recipe as Phi3-mini, for a fair comparison. The details of the generation configurations are included in \Cref{impl}.
We compare with several strong baselines, including Llama 2 \citep{touvron2023llama}, Mistral \citep{jiang2023mistral}, Mamba \citep{gu2023mamba}, Gemma \citep{team2024gemma}, Recurrent-Gemma (R-Gemma) \citep{botev2024recurrentgemma}, Llama 3 \citep{llama3} and TFM++. As shown in Table~\ref{tab:eval1}, \textsc{Samba} achieves the highest average score on all benchmarks, demonstrating its superior performance in handling various language comprehension tasks. Notably, \textsc{Samba} excels in the GSM8K benchmark, achieving an absolute 18.1\% higher accuracy than TFM++ trained on the same dataset. This shows the surprising complementary effect of combining SSM with the attention mechanism. We conjecture that when combined with attention, Mamba, as an input-dependent SSM, can focus more on performing the arithmetic operation through its recurrent states than on doing the retrieval operation which can be easily learned by the sliding window attention.


\begin{table}[!htp]
\centering
\small
\renewcommand{\arraystretch}{1.1}
\caption{
Downstream performance comparison of the \textsc{Samba} 3.8B base model with other pretrained base language models without instruction tuning. ARC-C and HellaSwag are measured with character-normalized accuracy. MMLU and GSM8K are measured in 5-shot, while others are in zero-shot. We report the MC2 score for TruthfulQA, maj@1 for GSM8K, and pass@1 for HumanEval. $^*$ Measured by ours. The fair comparison should only be considered between TFM++ and Samba.} 
\begin{tabular}{ccc|ccccccc|c}
\toprule
\multirow{2}{*}{\bf Model} & \multirow{2}{*}{\bf Size}  & \multirow{2}{*}{\bf Tokens}  & \multirow{2}{*}{\bf MMLU} & \bf Hella-  & \bf ARC- & \bf Wino- & \bf Truth. & \bf GSM & \bf Hum.  & \bf Avg. \\
& \bf    &  \bf   &   &  \bf Swag  &  \bf C  & \bf Gran.  &  \bf QA & \bf 8K & \bf Eval & \\
\midrule

Llama 2 & 6.7B    &  2T &   45.3  &  77.2 & 45.9  & 69.2   &  38.8 &  14.6 & 12.8 & 43.4 \\
        & 13B    &  2T &  54.8  & 80.7  & 49.4  &  72.8 &  37.4 & 28.7 & 18.3  & 48.9 \\
Mistral & 7.2B  &  - & 60.1  & \bf 81.3  &  55.5 & 75.3  & 42.2 & 35.4 & 30.5  & 53.6 \\
%Jamba & 12B\footnotemark &  -  &   &   &   &   &  &  &   \\
Mamba & 2.8B    &  600B &   26.2  & 71.0   & 41.7   & 65.9  & 34.4$^*$ & 3.6$^*$ & 7.3$^*$ & 35.7 \\
%\rowcolor{Gainsboro!60}
 Gemma & 2.5B    &  3T &   42.3 &  71.4  &  42.1 & 65.4 & 33.1 &  17.7 & 22.0 & 42.0\\
   & 8.5B    &  6T &   64.3 &  81.2  &  53.2 & 72.3 &  44.8 &  46.4 & 32.3 & 56.4 \\
R-Gemma & 2.7B    &  2T &  38.4  &  71.0 &  42.3 & 67.8 & 35.1 & 13.4 & 21.3 & 41.3\\
Llama 3 & 8.0B    &  15T+ &  66.6  &  79.2$^*$ &  53.2$^*$ & 72.6$^*$ & 43.9 & 45.8 & 28.7$^*$ & 55.8\\

\midrule
TFM++ & 3.8B  & 3.2T & 67.2 & 76.6 &  53.8 & 72.6 & \bf 47.3 & 51.5 &  51.8 & 60.1\\
\textsc{Samba} & 3.8B    &  3.2T & \bf 71.2    & 77.4 & \bf  55.7 & \bf 77.1 &  43.4   &  \bf 69.6  & \bf  54.9 & \bf 64.2\\

\bottomrule
\end{tabular}
\label{tab:eval1}
\end{table}

\begin{table}[!htbp]
\caption{Post-trained models quality on representative benchmarks under the chat mode. The fair comparison should only be considered between \textsc{Samba} and Phi3 as we control the training recipes and datasets to be the same. Best results are in bold, second best underlined.}
\begin{center}
\begin{adjustbox}{width=1.0\textwidth,center}
\begin{tabular}{ cccc|ccccccc } 
\toprule
\textbf{Category} & \textbf{Benchmark} & \makecell{ \textsc{Samba} (June) \\ \footnotesize 3.8B} & \makecell{Phi3 (June)\\ \footnotesize 3.8B} & \makecell{R-Gemma \\ \footnotesize 9B} & \makecell{FalconMamba \\ \footnotesize 7B} & \makecell{ Jamba-1.5-Mini \\ \footnotesize 12B/52B}  & \makecell{Llama-3.2-In \\ \footnotesize 3B}  & \makecell{Llama-3.1-In \\\footnotesize 8B }
 \\ \midrule
\multirow{3}{*}{MMLU} & \makecell{MMLU \\ \footnotesize (5-shot)} & \underline{ 69.0} & 67.2 &  60.5 & 62.1 & \bf 69.7 & 61.8 & 68.1\\ %\cline{2-9} 
 & \makecell{MMLU-Pro \\ \footnotesize (0-shot, CoT)} & \bf 47.9 & \underline{46.5} & 17.8 & 14.5 & 42.5 & 39.2 & 44 \\ \midrule
\multirow{3}{*}{Reasoning} & \makecell{ARC-C \\ \footnotesize (10-shot)} & \bf 87.8 & \underline{86.8} & 52.0 & 62.0 & 85.7 & 76.1 & 83.1 \\ %\cline{2-9} 
 & \makecell{GPQA \\ \footnotesize (0-shot, CoT)}  & \underline{29.5} & 29.0 & 4.7 & 8.1 & \bf 32.3 & 26.6 & 26.3 \\ %\cline{2-9}
\midrule
\multirow{1}{*}{Math} & \makecell{ GSM8K \\ \footnotesize (8-shot, CoT) } & \bf 86.4 & \underline{84.8} & 42.6 & 52.5 & 75.8 & 75.6 & 77.4 \\ %\cline{2-9} 
\midrule
\multirow{3}{*}{Code} & \makecell{ HumanEval \\ \footnotesize (0-shot)} & \bf 70.1 & \underline{66.5} & 31.1 & - & 62.8 & 62.8 & \underline{66.5} \\ %\cline{2-9} 
 & \makecell{ MBPP \\ \footnotesize (3-shot) }& \underline{71.7} & 70.0 & 42.0 & - & \bf 75.8 & 67.2  & 69.4 \\ \midrule
\multicolumn{2}{c}{Average} & \bf 66.1 & \underline{64.4} & {35.8} & {-} & {63.5} & {58.5} & 62.1 \\ 
\bottomrule
\end{tabular}
\end{adjustbox}

\label{tab:benchmark-comparison-3.5}
\end{center}
\end{table}



As shown in \Cref{tab:benchmark-comparison-3.5}, we can see that post-trained hybrid models can achieve superior performance compared to industry-standard Transformer-based LLMs such as Llama-3.1-Instruct 8B and Llama-3.2-Instruct 3B, and SSM-based LLMs such as FalconMamba\footnote{\url{https://huggingface.co/tiiuae/falcon-mamba-7b-instruct}}. Recent progress on hybrid LLMs, including Jamba 1.5 \citep{team2024jamba15} and our own work on \textsc{Samba}, shows significant improvement over earlier approaches like R-Gemma \citep{botev2024recurrentgemma}, which hybridizes attention with linear recurrent models but is trained on smaller data scales. \textsc{Samba}  delivers comparable performance to Jamba-1.5-Mini while using around 3$\times$ fewer active parameters and 13$\times$ fewer total parameters, due to an advanced text-book data synthesis technique \citep{abdin2024phi3}. Additionally, \textsc{Samba} outperforms the Phi3 architecture, which is trained on the same data and optimization setting, further highlighting the superiority of our hybrid architecture over modern Transformer models.



\begin{figure}[!ht]
    \centering
    \includegraphics[width=7cm]{speed.jpg}
    \caption{Prompt processing throughput of different models with around 1.7B parameters.}
    \label{fig:prefill}
     % \vspace{-0.4cm}
\end{figure}



% We 
% \textbf{Llama-3} \citep{llama3} is a pure attention-based architecture that replaces all attention layers in Llama-2 with grouped query attention layers. 8 query attention heads are grouped to share a single pair of key-value heads.


\section{Additional Experiment Details} \label{pk}
\begin{figure}[!ht]
 %\vspace{-0.4cm}
    \centering
    \includegraphics[width=8cm]{passkey_train_curve.pdf}
    \caption{Training loss curves of Samba 1.7B and Mistral 1.6B models during 500 steps of instruction tuning on Passkey Retrieval with 4K sequence length.  We plot the loss curves for both models using the simple moving average of window size 10. }
    \label{fig:loss_pk}
%\vspace{-0.4cm}
\end{figure}

\begin{figure}[!ht]
 %\vspace{-0.4cm}
    \centering
    \includegraphics[width=0.5\linewidth]{passkey_retrival_acc.pdf}
    \caption{Overall passkey retrieval accuracy on the 256K document length of Samba 1.7B and Mistral 1.6B models during 500 steps of instruction tuning.}
    \label{fig:acc_pk}
%\vspace{-0.4cm}
\end{figure}

We perform instruction tuning for both Mistral 1.6B and Samba 1.7B on Passkey Retrieval using document length 4096, where we generated the data on the fly through randomly sampling a 5-digit integer passkey value and a location/depth between zero and the document length to insert the passkey. The model is then asked to generate the passkey given the full document. We train both models using batch size 2048, 250 warm-up steps with a peak learning rate of $1e^{-4}$, and 0.1 weight decay with AdamW \citep{adw} optimizer. In both cases, the loss converges quickly in 100-200 steps. During the evaluation, we measure the overall average accuracies of the passkey retrieval at the document length of [4k, 8k, 16k, 32k, 64k, 128k, 256k], for each length we evaluate at 11 different depths of the document (from 0, 0.1, 0.2, ... to 1.0). In addition, for each location of the passkey (depth) in the document, we evaluate the model with five different passkeys to measure accuracy. As seen in Figure \ref{fig:acc_pk}, the average passkey retrieval accuracy for Samba 1.7B almost reaches 100\% in around 150 steps, while the accuracy for Mistral 1.6B remains low, demonstrating the extrapolation ability of the Samba architecture. 
% All such materials \textbf{SHOULD be included in the main submission.}


% \section{Additional Analysis} \label{add_ana}


\section{Additional Analyses} \label{add_ana}

\paragraph{How to train models with Sliding Window Attention (SWA)?}

Since SWA has linear complexity with respect to the sequence length, it seems alluring to trade off the batch size to have a longer training sequence length without substantially decreasing the training throughput. However, as shown in \Cref{tab:swa}, when the sequence length is increased, the validation perplexity also increases in all context lengths due to smaller batch sizes \citep{varis-bojar-2021-sequence}, and the optimal ratio of sequence length/window size observed is 2, resulting in a training length of 4096.


\begin{table}[h]
\centering
\small
\caption{Perplexity on SlimPajama of Llama-2-SWA 438M models trained on different context sizes and batch sizes. We fix the sliding window size as 2048 and the training tokens per step as 2M.} 

\begin{tabular}{ccccccc}
\toprule
\multirow{2}{*}{\bf Batch Size} & \multirow{2}{*}{\bf Sequence Length }   & \bf Training Speed &  \multicolumn{4 }{c}{\bf Validation Context Length} \\
  & &  ($\times 10^5$ tokens/s) &  2048  &  4096  &   8192 &   16384 \\ 
\midrule
% \multicolumn{6}{l}{\emph{20B training tokens}} \\
% \midrule
1024      & 2048 (Full Attention)    & 10.4 & \bf 11.59 & 38.12 & 156.18 & 357.32 \\
512 & 4096 & 9.88 &  11.87 &  \bf 11.16 & \bf 10.69 & \bf 10.61 \\
256 & 8192  & 9.66 & 11.98  & 11.26 & 10.79 & 10.69  \\
128 & 16384  & 9.48 & 12.37  & 11.63 & 11.12 & 11.02  \\
64 & 32768  & 9.29 & 12.94  & 12.46 & 11.96 & 11.86  \\

\bottomrule
\end{tabular}
\label{tab:swa}
\end{table}

\begin{table}[h]
\centering
\small
\caption{Perplexity on the SlimPajama validation set of different linear recurrent and sliding window attention models with Short Convolution (SC) modules added separately to query, key and value representations. For hybrid models, SC is applied only to linear attention layers. The training speed is measured on 8$\times$A100 GPUs.} 

\begin{tabular}{lcccccc}
\toprule
\multirow{2}{*}{\bf Architecture} & \multirow{2}{*}{\bf Size }   & \bf Training Speed &  \multicolumn{3 }{c}{\bf Validation Context Length} \\
  & &  ($\times 10^5$ tokens/s) &  4096  &  8192  &   16384 \\ 
\midrule
Llama-2-SWA & 438M &  4.96 & 11.12 & 10.66 & 10.57 \\
 \quad \quad \quad \quad \emph{+ SC} & 438M &  4.69 & 10.83 & 10.39 & 10.31 \\
 \midrule
Sliding GLA      & 438M     & 4.94 & 10.43 & 10.00 & 9.92 \\
 \quad \quad \quad \quad\emph{+ SC}    & 438M     & 4.44 & 10.39 & 9.96 & 9.87 \\
  \midrule
Sliding RetNet & 446M & 4.32 & 10.38 & 9.96 & 9.87 \\
 \quad \quad \quad \quad \emph{+ SC} & 446M & 3.80 & 10.25 & 9.82 & 9.74 \\
 
\bottomrule
\end{tabular}
\label{tab:SC}
\end{table}

\paragraph{Fair comparison between Mamba and other linear recurrent models?} We can notice that the Short Convolution (SC) operator in \Cref{sc}  is independent to the design of other parts of Mamba and can be applied to other linear recurrent models. As shown in \Cref{tab:SC},  we explore the effect of SC on model performance through enhancing Llama-2-SWA, Sliding GLA, and Sliding RetNet with SC. Surprisingly, besides boosting the performance of RetNet, adding SC can also significantly improve the SWA's performance, while the effect on GLA is less prominent. We think this is because GLA already has the fine-grained decays at the channel level, so the depthwise convolution doesn't add much of the useful inductive bias for better modeling power. Notably, even with the SC enhancer, Sliding GLA and Sliding RetNet still fall short than the original Samba 421M's performance shown in \Cref{tab:SCs}. This further justifies our choice of using Mamba for hybridization. We also find that adding SC to both the SWA and the linear attention layers in hybrid models produces negative results, and we leave it as a future work to understand the surprising effectiveness of SC in language modeling.

% \paragraph{Can the short convolution module inside Mamba also benefit other linear recurrent models?}
% We show that 
\section{Details of Entropy Measurement} \label{app_ent}
Given a causal attention probability matrix $A \in \mathbb{R}^{h \times n \times n}, A_{ijk} = 0 ~\forall j<k $, with $h$ number of heads and a sequence length of $n$, and the generation length $0 < l < n$, we calculate the average attention entropy per decoding step as follows,
\[
\mathcal{H}_{a} = - \frac{1}{l \cdot h}\sum_{i=1}^{h} \sum_{j = n-l+1} ^n  \sum_{k = 1}^n A_{ijk}\log(A_{ijk}).
\]
For the selective gate $\Delta \in \mathbb{R}^{n \times d_e}$ used by S6 in \Cref{sp} of the Mamba layers, we first normalize it to be in the simplex $[0, 1]^{n \times d_e}$, \emph{i.e.},
\[
\Delta' = \frac{\Delta}{\sum_{i=1}^{n} \Delta_i} ~ \in [0, 1]^{n \times d_e}.
\]
The average selection entropy of S6 throughout the entire sequence is then calculated as
\[
\mathcal{H}_{s} = - \frac{1}{d_e}  \sum_{j = 1}^{d_e} \sum_{i=1}^{n} \Delta'_{ij}\log(\Delta'_{ij}).
\]

\section{Details of Downstream Long-context Evaluation} \label{add_data}

We use the GovReport \citep{govreport2023} and the SQuALITY \citep{squality} datasets from the ZeroSCROLLS \citep{shaham2023zeroscrolls} benchmark to evaluate models' long-context summarization capability in the real world. After tokenizing with the \emph{Phi3-mini-4k} tokenizer, the average document length for the GovReport dataset is 11,533 tokens, with a median of 10,332, a minimum of 1,493, and a maximum of 40,592 tokens. For the SQuALITY dataset, the average sequence length is 7,974 tokens, with a median of 8,145, a minimum of 5,457, and a maximum of 10,757 tokens. For evaluation, we use greedy decoding for both tasks. A maximum generation length of 450 tokens is applied for GovReport and 600 for SQuALITY.

\section{Implementation Details} \label{impl}

\begin{table}[!ht]
\centering
\small
\caption{Detailed hyper-parameters of the baselines models trained on the Phi2 dataset with 230B tokens.}

\begin{tabular}{cccccccc}
\toprule
\textbf{Architecture} & \textbf{Llama-3 } & \textbf{Mistral} & \textbf{Mamba } & \textbf{Mamba-SWA-MLP } &  \textbf{Mamba-MLP } \\
% \textbf{Total Parameters} & \textbf{438M} & \textbf{1.3B} & \textbf{1.7B } & \bf 3.8B \\
\midrule
Parameters & 1.6B & 1.6B & 1.8B & 1.6B & 1.9B\\ 
% Dataset & SlimPajama  & SlimPajama & Phi-2 & Phi-3\\
Batch size & 2048 & 2048 & 2048 & 2048 & 2048\\
Learning rate & 0.0006 & 0.0006 &  0.0006 & 0.0006 & 0.0006 \\
% Training tokens &  20B & 100B  & 230B & 3.2T \\
Weight decay & 0.1 & 0.1 & 0.1 & 0.1 & 0.1 \\
Gradient clipping & 1.0 & 1.0 & 1.0 & 1.0 & 1.0 \\
Sequence length & 4096 & 4096 & 4096 & 4096 & 4096\\
\midrule
Sliding window size, $w$ & - & 2048 & - & 2048 & - \\
Number of layers, $N$ & 48 & 48 & 64 & 54 & 48 \\
Model width, $d_m$ & 2048 & 2048 & 2048 & 2048 & 2048\\
MLP intermediate size, $d_{p}$ & 8196 & 8196 & -  & 8196 & 8196\\
Number of query heads & 32 & 32 & - & 32 & 32\\
Number of KV heads & 4  &  4 & - & 4 & 4\\
Number of Attention Layers & 24 & 24 & 0 & 18 & 0\\
Number of Mamba Layers & 0 & 0 & 64 & 18 & 24\\
Vocabulary size & 50304 & 50304 & 50304 & 50304 & 50304\\
\bottomrule
\end{tabular}\label{hype_base}
\end{table}

For the GLA layer in the Sliding GLA architecture, we use the number of heads $d_m / 384 $, a key expansion ratio of 0.5, and a value expansion ratio of 1. For the RetNet layer we use a number of head that is half of the number of attention query heads, key expansion ratio of 1 and value expansion ratio of 2. The GLA and RetNet implementations are from the Flash Linear Attention \citep{yang2024fla} repository\footnote{\url{https://github.com/sustcsonglin/flash-linear-attention}} . We use the FlashAttention-based implementation for Self-Extend extrapolation\footnote{\url{https://github.com/datamllab/LongLM/blob/master/self_extend_patch/Llama.py}}. The Mamba 432M model has a model width of 1024 and the Mamba 1.3B model has a model width of 2048. All models trained on SlimPajama have the same training configurations and the MLP intermediate size as Samba, unless otherwise specified. The training infrastructure on SlimPajama is based on a modified version of the TinyLlama codebase\footnote{\url{https://github.com/jzhang38/TinyLlama}}.



\begin{table}[!htp]
\centering
\small
\caption{Detailed hyper-parameters of the \textsc{Samba} models trained at different scales. We only show the optimization settings for the first training phase of the 3.8B model.}

\begin{tabular}{ccccc}
\toprule
\textbf{Total Parameters} & \textbf{421M} & \textbf{1.3B} & \textbf{1.7B } & \bf 3.8B \\
\midrule
Dataset & SlimPajama  & SlimPajama & Phi-2 & Phi-3\\
Batch size & 512 & 512 & 2048 & 2048\\
Learning rate & 0.0004 & 0.0004 &  0.0006 & 0.0006 \\
Total training tokens &  20B & 100B  & 230B & 3.2T \\
Weight decay & 0.1 & 0.1 & 0.1 & 0.1 \\
Gradient clipping & 1.0 & 1.0 & 1.0 & 1.0\\
Sequence length & 4096 & 4096 & 4096 & 4096 \\
\midrule
Sliding window size, $w$ & 2048 & 2048 & 2048 & 2048\\
Number of layers, $N$ & 24 & 36 & 48 & 64 \\
Model width, $d_m$ & 1536 & 2304 & 2048 & 2816\\
MLP intermediate size, $d_{p}$ & 4096 & 6144 & 8196 & 9984\\
Number of query heads & 12 & 18 & 32 & 11\\
Number of key-value heads & 12  &  18 & 4 & 1\\
Vocabulary size & 32000 & 32000 & 50304 & 32064\\
\bottomrule
\end{tabular}\label{hype}
\end{table}


In the generation configurations for the downstream tasks, we use greedy decoding for GSM8K, and Nucleus Sampling \citep{holtzman2019curious} with a temperature of $\tau = 0.2$ and $\text{top-}p = 0.95$ for HumanEval. For MBPP and SQuAD, we set $\tau = 0.01$ and $\text{top-}p = 0.95$.

\section{Limitations \& Broader Impact}
Although Samba demonstrates promising memory retrieval performance through instruction tuning, its pre-trained base model has retrieval performance similar to that of the SWA-based model, as shown in \Cref{fig:acc_pk}. This opens up future direction on further improving the Samba's retrieval ability without compromising its efficiency and extrapolation ability. In addition, the hybridization strategy of Samba is not consistently better than other alternatives in all tasks. As shown in ~\Cref{tab:eval2}, Mamba-SWA-MLP shows improved performance on tasks such as WinoGrande, SIQA, and GSM8K. This gives us the potential to invest in a more sophisticated approach to perform input-dependent dynamic combinations of SWA-based and SSM-based models \citep{ren2023sparse}.  With the improved short-context performance and the long-term memorization ability of linear complexity LLMs such as Samba, cost-effective applications can be developed for personalized learning and automated tutoring. Samba can also be used for emotional accompaniment. The efficiency of the Samba architecture can save inference energy costs for models deployed on the edges, resulting in greener and more sustainable AI applications.





% \section{Related Work}
% % \paragraph{Input Selection Mechanism}
% \paragraph{Length Extrapolation}
% \paragraph{Linear Recurrent Models}


% \input{checklist}

\end{document}