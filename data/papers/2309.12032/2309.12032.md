---
abstract: |
  Structure learning is the crux of causal inference. Notably, causal discovery (CD) algorithms are brittle when data is scarce, possibly inferring imprecise causal relations that contradict expert knowledge — especially when considering latent confounders. To aggravate the issue, most CD methods do not provide uncertainty estimates, making it hard for users to interpret results and improve the inference process. Surprisingly, while CD is a human-centered affair, no works have focused on building methods that both 1) output uncertainty estimates that can be verified by experts and 2) interact with those experts to iteratively refine CD. To solve these issues, we start by proposing to sample (causal) ancestral graphs proportionally to a belief distribution based on a score function, such as the Bayesian information criterion (BIC), using generative flow networks. Then, we leverage the diversity in candidate graphs and introduce an optimal experimental design to iteratively probe the expert about the relations among variables, effectively reducing the uncertainty of our belief over ancestral graphs. Finally, we update our samples to incorporate human feedback via importance sampling. Importantly, our method does not require causal sufficiency (i.e., unobserved confounders may exist). Experiments with synthetic observational data show that our method can accurately sample from distributions over ancestral graphs and that we can greatly improve inference quality with human aid.
author:
- Tiago da Silva
- Eliezer Silva
- António Góis
- Dominik Heider
- Samuel Kaski
- Diego Mesquita
- Adèle Ribeiro
bibliography:
- aaai24.bib
citation-style: ieee
header-includes:
- 
- 
link-citations: true
reference-section-title: References
title: Human-in-the-Loop Causal Discovery under Latent Confounding using Ancestral GFlowNets
---




# Introduction

Drawing conclusions about cause-and-effect relationships presents a fundamental challenge in various scientific fields and significantly impacts decision-making across diverse domains . The importance of having structural knowledge, often encoded as a causal diagram, for conducting causal inferences is widely recognized, a concept made prominent by ’s dictum: *“no causes in, no causes out”*. When there is no objective knowledge to fully specify a causal diagram, causal discovery (CD) tools are instrumental in partially uncovering causal relationships among variables from, for example, observational data. Formally, let $\mathbf{V} = \{V_1, V_2, \dots, V_n\}$ be a set of $n$ observed variables and $\mathcal{D}$ be a dataset containing $|\mathcal{D}| = m$ samples for each $V_i \in \mathbf{V}$. A CD algorithm takes $\mathcal{D}$ as input and typically returns a single graph $\mathcal{G}=(\mathbf{V},\mathbf{E})$ with well-defined causal semantics, in which each node in $\mathbf{V}$ represents a variable $V_i \in \mathbf{V}$ and each edge in $\mathbf{E}$ encodes the possible underlying (causal/confounding) mechanisms compatible with $\mathcal{D}$.

<figure id="fig:human">
<span class="image placeholder" data-original-image-src="figures/hitl_marcus_aurelius2.pdf" data-original-image-title="" width="0.7\linewidth"></span>
<figcaption><strong>Human-in-the-loop probabilistic CD.</strong> We first train an AGFN to fit a data-informed belief over AGs. Then, we iteratively refine it by 1) questioning (Q) experts on the relation between a highly informative pair of variables and 2) updating the belief given the potentially noisy answers (A). The histograms on top of the edges show marginals over edge types (green denotes ground truth). Notably, our belief increasingly concentrates on the true AG, <span class="math inline">\(1 \rightarrow 2 \leftrightarrow 3\)</span>. </figcaption>
</figure>

This work focuses on recovering the structure of the underlying causal diagram when unobserved confounders may be at play. We propose to address this task by not only leveraging observational data but also by accounting for potentially noisy pieces of expert knowledge, otherwise unavailable as data. Throughout this work, we consider ancestral graphs (AGs) as surrogates for causal diagrams. AGs are particularly convenient since they encode latent confounding without explicitly invoking unobserved variables. Moreover, AGs capture all conditional independencies and ancestral relations among observed variables $\mathbf{V}$, as entailed by a causal diagram .

In the realm of CD from solely observational data, algorithms aim to construct a compact representation of the joint observational distribution $P(\mathbf{V})$, which implies a factorization as a product of conditional probabilities. Notably, multiple models may entail the same conditional independencies; in such cases, they are denoted as Markov-equivalent. As a result, these algorithms can only reconstruct the class of Markov-equivalent models (AGs), denoted as the Markov Equivalence Class (MEC) and typically represented by a *Partial Ancestral Graph* (PAG). Importantly, CD beyond the MEC by leveraging domain knowledge presents a critical challenge. Notably, there is no proper characterization of an equivalence class that accounts for knowledge stemming from both humans and data .

There is a variety of algorithms for CD from observational data, primarily categorized into constraint- and score-based methods. The former uses (in)dependence constraints derived via conditional independence tests to directly construct a PAG representing the MEC. The latter uses a goodness-of-fit score to navigate the space of AGs, selecting an optimum as a representative for the MEC.

Nonetheless, methods within both paradigms suffer from unreliability when data is scarce. Specifically, for the majority of the CD algorithms, formal assurances that the inferred MEC accurately represents the true causal model heavily rely on the so-called *faithfulness* assumption, which posits that all conditional independencies satisfied by $P(\mathbf{V})$ are entailed by the true causal model . However, this presents a critical challenge in real-world scenarios, as violations of the faithfulness assumption become more prominent when relying on $P(\mathbf{V})$ estimated from limited data . For constraint-based methods, hypothesis tests may lack the statistical power to detect conditional independencies accurately. These errors may propagate and trigger a chain reaction of erroneous orientations . For score-based methods, although score functions directly measure goodness-of-fit on observational data, small sample sizes can significantly skew the estimates for the population parameters. Consequently, structures deemed score-optimal may not necessarily align with the ground-truth MEC  . A major concern is that the overwhelming majority of CD algorithms produce a single representation of the MEC as output, without quantifying the uncertainty that arises during the learning process . This poses a significant challenge for experts, as it hinders their ability to validate the algorithm’s outcome or gain insights into potential venues for improving inference quality.

To alleviate the lack of uncertainty quantification in CD, we propose sampling AGs from a distribution defined using a score function, which places best-scoring AGs around the mode by design. This effectively provides end-users with samples that reflect the epistemic uncertainty inherent in CD, thus allowing their propagation through downstream causal inferences. In particular, we sample from our belief using *Generative Flow Networks* , which are generative models known for sampling diverse modes while avoiding the mixing time problem of MCMC methods, and not requiring handcrafted proposals nor accept-reject steps .

Acknowledging the low-data regime as CD’s primary challenge, we also propose actively integrating human feedback in the inferential process. This involves modeling user knowledge on the existence and nature (confounding/ancestral) of the relations and using it to weigh our beliefs over AGs. During our interactions with experts, we probe them about the relation of the pair of variables that optimizes a utility/acquisition function, for which we propose the negative expected cross-entropy between our prior and updated beliefs. Unlike prior strategies, our acquisition avoids the need to estimate the normalizing constant and predictive distribution of our updated belief, as needed for information gain and mutual information, respectively. Notably, we use importance sampling  to update our initial belief with the human feedback, which avoids retraining GFlowNets after each human interaction.

While incorporating expert knowledge into CD has been a long-standing goal , existing works either rely on strong assumptions (e.g., causal sufficiency) or assume the knowledge is noiseless, aligned with the ground truth  . Importantly, our work introduces the first iterative CD framework for AGs involving a human in the loop and accommodating potentially noisy feedback, as depicted in .

To validate our approach, we conduct experiments using the BIC score, for linear Gaussian causal models. Specifically, we assess: i) our ability to sample from score-based beliefs over AGs, ii) how our samples compare to samples from bootstrapped versions of state-of-the-art (SOTA) methods, and iii) the efficacy of our active knowledge elicitation framework using simulated humans. We observe that our method, Ancestral GFlowNet (AGFN), i) accurately samples from our beliefs over AGs; ii) consistently includes AGs with low structural error among its top-scored samples; and iii) is able to greatly improve performance metrics (i.e., SHD and BIC) when incorporating human in the loop.

In summary, the **contributions** of our work are:

1.  We leverage GFlowNets to introduce AGFN, the first CD algorithm for scenarios under latent confounding that employs fully-probabilistic inference on AGs;

2.  We show AGFN accurately learns distributions over AGs, effectively capturing epistemic uncertainty.

3.  We propose an experimental design to query potentially noisy expert insights on relationships among pairs of variables that lead to optimal uncertainty reduction.

4.  We show how to incorporate expert feedback into AGFN without retraining them from scratch.

# Background

This section introduces the relevant notation and concepts. We use uppercase letters $V$ to represent a random variable or node in a graph, and boldface uppercase letters $\mathbf{V}$ to represent matrices or sets of random variables or nodes.

**Ancestral graphs.** Under the assumption of no selection bias, an *ancestral graph* (AG) $\mathcal{G}$ over $\mathbf{V}$ is a directed graph comprising directed ($\rightarrow$) and bidirected ($\leftrightarrow$) edges . In any directed graph, if a sequence of directed edges, $V_i \rightarrow \cdots \rightarrow V_j$, connects two nodes $V_i$ and $V_j$, we refer to this sequence as a directed path. In this case, we also say that $V_i$ is an ancestor of $V_j$ and denote this relation as $V_i \in An(V_j)$. By definition, any AG $\mathcal{G}$ must further satisfy the following:

1.  there is no directed cycle, i.e., if $V_i \rightarrow V_j$ is in $\mathcal{G}$, then $V_j \not \in An(V_i)$; and

2.  there is no almost directed cycle, i.e., if $V_i \leftrightarrow V_j$ is in $\mathcal{G}$, then $V_j \not \in An(V_i)$ and $V_i \not \in An(V_j)$.

As a probabilistic model, the nodes in an AG represent random variables, directed edges represent ancestral (causal) relationships, and bidirected edges represent associations solely due to latent confounding. For a complete characterization of AGs, refer to .

**Data generating model.** We assume that the data-generating model corresponds to a *linear Gaussian structural causal model* (SCM) defined by a 4-tuple $\mathcal{M} = \langle \mathbf{V}, \mathbf{U}, \mathcal{F}, P(\mathbf{U}) \rangle$, in which $\mathbf{V} = \{V_1, V_2, \dots, V_n\}$ is a set of $n$ observed random variables and $\mathbf{U} = \{U_1, U_2, \dots, U_n\}$ is the set of unobserved random variables. Further, let $Pa_i \subseteq \mathbf{V} \setminus \{V_i\}$ be the set of observed causes (parents) of $V_i$, and $U_i$ be the set of unobserved causes of $V_i$. Then, each structural equation $f_i \in \mathcal{F}$ is defined as: $$V_i = \sum_{j: V_j \in Pa_i} \beta_{ij} V_j + U_i$$ with $P(\mathbf{U})$ being a multivariate Gaussian distribution with zero mean and a not necessarily identity covariance matrix $\boldsymbol{\Omega} = (\omega_{ij})_{1\leq i,j\leq n}$ — the error terms $\{U_i\}$ are not necessarily mutually independent, implying that the system can be semi-Markovian (i.e., latent confounding may be present).

Consider a lower triangular matrix of structure coefficients $\mathbf{B} = (\beta_{ij})_{1\leq i,j\leq n}$ such that $(\mathbf{I}-\mathbf{B})$ is invertible, and $\beta_{ij} \neq 0$ only if $V_j \in Pa_i$. Then, the set of structural equations is given in matrix form by $$\mathbf{V} = \mathbf{B} \mathbf{V} + \mathbf{U} \implies \mathbf{V} = (\mathbf{I}-\mathbf{B})^{-1} \mathbf{U}.$$ The class of all linear Gaussian SCMs parametrized as $$\label{eq:linear_model}
    \mathcal{N}_{\mathcal{M}}=\{ \mathcal{N}(\mathbf{0},\boldsymbol{\Sigma}) | \boldsymbol{\Sigma} = (\mathbf{I}-\mathbf{B})^{-1}\boldsymbol{\Omega} (\mathbf{I}-\mathbf{B})^{-\top}\}$$ is represented by an AG in which, for every $i \neq j$, there is a directed edge $V_j \rightarrow V_i$ if $\beta_{ij} \neq 0$ and a bidirected edge $V_j \leftrightarrow V_i$ if $\omega_{ij} \neq 0$ .

<figure id="fig:ancgfn">

<figcaption><strong>Illustration of the generative process of AGs</strong> <span class="math inline">\(\{\mathcal{G}_5, \mathcal{G}_6, \mathcal{G}_7\}\)</span> using GFlowNets. Starting with an empty graph <span class="math inline">\(\mathcal{G}_0\)</span>, we add edges between variables <span class="math inline">\(\{X_1, X_2, X_3\}\)</span> according to the action-policy <span class="math inline">\(\pi_F\)</span>. Solid edges trace trajectories leading to sampled graphs. Dashed lines represent non-realized transitions to terminal state <span class="math inline">\(\square\)</span>.</figcaption>
</figure>

**GFlowNets.** Generative Flow Networks are generative models designed to sample from a finite domain $\mathcal{X}$ proportionally to some reward function $R:\mathcal{X}\rightarrow\mathbb{R}_{+}$, which may be parametrized using neural networks. In this work, we define $R$ as a strictly decreasing transformation of the BIC (more details in ). GFlowNets also assume there is a compositional nature to the elements $x \in \mathcal{X}$, meaning that they can be built by iteratively acting to modify a base object (i.e., an *initial state*). For instance, graphs can be built by adding edges to a node skeleton or molecules by adding atoms to an initial structure .

The generative process follows a trajectory of states $s\in\mathcal S$ guided by a transition probability $\pi_{F}:\mathcal{S}^2\rightarrow [0,1]$. In turn, $\pi_F$ is proportional to a *foward flow* function $F_{\theta} : \mathcal{S}^2\rightarrow \mathbb{R}_{+}$, which is parameterized by a neural network $\theta$. Let $\text{Pa}(s')$ ($\text{Ch}(s')$) be the set of all states which can transition into (directly reached from) $s'$. Then, $\pi_F$ is defined as $$\pi_F(s'|s) = \frac{F_{\theta}(s\rightarrow s')}{\sum_{{s'\in \text{Ch}(s)}} F_{\theta}(s\rightarrow s')}.$$

The support $\mathcal{X}$ of $R$ is contained within $\mathcal{S}$. There are also two special states in $\mathcal{S}$: an *initial state* $s_0$ and a *terminal state* $s_f$. We start with the initial state $s_0$ and transform it to a new valid state $s$ with probability $\pi_F(s|s_0;\theta)$. We keep iterating this procedure until reaching $s_f$. States $s$ valid as final samples ($s\in\mathcal X$) are known as *terminating states* and have a positive probability for the transition $s\rightarrow s_f$. illustrates this process with $\mathcal{X}$ being the space of AGs. Crucially, the same parameterization $\theta$ is used for all transition probabilities $\pi_F(\cdot|s;\theta)$ given any departing state $s$, allowing for generalization to states never visited during training.

As the GFlowNet framework requires that no sequence of actions leads to a loop, we represent the space of possible action sequences by a pointed Directed Acyclic Graph (DAG) . The generation of any sample $x \in \mathcal{X}$ follows a trajectory $\tau=(s_0, s_1, \ldots, s_{T} = x, s_f) \in \mathcal S^{T+2}$ for a $T\geq0$. Different trajectories may lead to the same sample $x$. To ensure we sample proportionally to $R$, we search for a GFlowNet that satisfies the *flow-matching condition*, i.e., $\forall s'\in\mathcal{S}$: $$\sum_{s\in\text{Pa}(s')} F_\theta(s\rightarrow s') = R(s') + \sum_{s''\in \text{Ch}(s')}F_\theta(s'\rightarrow s'').
    \label{eq:balance}$$

implies the flow that enters $s^\prime$ equals the flow leaving $s^\prime$, except for some flow $R(s')$ leaking from $s^\prime$ into $s_f$. We let $R(s) = 0$ for $s \notin \mathcal{X}$. Eventually, it may be that all states $s$ are valid candidates, i.e., $\mathcal{S} = \mathcal{X} \cup \{s_{f}\}$. If so, each of ’s solutions satisfies a *detailed-balance condition*, $$\label{eq:dbalance} 
    \frac{R(s) F_{\theta}(s \rightarrow s') F_{\theta}(s' \rightarrow s_{f})}{F_{\theta}(s \rightarrow s_{f})} = R(s') F_{B, \theta}(s' \rightarrow s),$$ for a parametrized backward flow $F_{B, \theta} \colon \mathcal{S}^{2} \rightarrow \mathbb{R}_{+}$ . In practice, we enforce by minimizing $$\label{eq:dbalancetheta} 
\mathcal{L}(\theta) \! = \!\underset{s \rightarrow s^\prime}{\mathbb{E}}\!\left[\!\left(\! \log \frac{R(s') \pi_{F_B}(s | s^\prime; \theta) \pi_{F}(s_{f} | s; \theta)}{R(s) \pi_{F}(s^\prime | s; \theta) \pi_{F}(s_{f} | s^\prime; \theta)} \!\right)^{2} \!\right].$$

# Ancestral GFlowNets

We propose AGFN, a GFlowNet-based method for sampling AGs using a score function. Specifically, AGFN encompasses a GFlowNet with the following characteristics:

1.  Each trajectory state is a valid AG $\mathcal{G}_t$.

2.  A terminating state’s reward $R(\mathcal{G_T})$ is a score-based potential suitable for CD of AGs.

3.  A well-trained AGFN samples AGs with frequencies proportional to their rewards and with the best-scoring AG being, by design, the mode.

The generation of a trajectory $\tau = \{\{\}, \mathcal{G}_1, \mathcal{G}_2, \ldots, \mathcal{G}_T \}$ begins with a totally disconnected graph with nodes $\mathbf{V}$, iteratively adding edges of types $\{\leftarrow, \rightarrow, \leftrightarrow\}$ between pairs of variables. The following paragraphs describe AGFN. For further details, please refer to the Appendix.

**Action constraints.** To ensure AGFN only samples AGs, we mask out actions that would lead to paths forming cycles or almost cycles. To achieve this, we verify whether the resulting graph respects ’s algebraic characterization of the space of AGs. More specifically, any AG $\mathcal{G}$ is characterized by an adjacency matrix $\mathbf{A}_d \in \mathbb{R}^{n \times n}$ for its directed edges and another adjacency matrix $\mathbf{A}_b \in \mathbb{R}^{n \times n}$ for its bidirected edges, adhering to: $$\label{eq:cond:ancestral} 
    \text{trace}(\exp\{ \mathbf{A}_d \}) - n + \mathbf{1}^{T}(\exp\{ \mathbf{A}_d \} \odot \mathbf{A}_b)\mathbf{1} = 0,$$ in which $\mathbf{1}$ is a $n$-dimensional unit vector and $\odot$ denotes the Hadamard (elementwise) product of matrices.

**Score-based belief.** We propose using a strictly decreasing transformation of a score function $U$ as the reward $R$ for AGFN. More precisely, we define $R$ as $$\label{eq:reward}
    R(\mathcal{G}) = \exp\left\{\frac{\mu - U(\mathcal{G})}{\sigma}\right\}$$ for given constants $\mu\in\mathbb{R}$ and $\sigma \in \mathbb{R}^+$ that ensure numerical stability . In practice, we sample $S$ AGs $\{\mathcal{G}^{(s)}\}_{s=1}^{S}$ from an untrained AGFN, and set $\mu = \nicefrac{1}{S} \sum_s U(\mathcal{G}^{(s)})$ and $\sigma = \sqrt{\nicefrac{1}{S} \sum_s (U(\mathcal{G}^{(s)}) - \mu)^2}$.

**Score for linear Gaussian models.** Since we focus on linear Gaussian models, we choose the *extended Bayesian Information Criterion* as our score function. Specifically, for any AG $\mathcal{G}=(\mathbf{V}, \mathbf{E})$: $$\begin{aligned}
 \label{eq:bic} 
    U(\mathcal{G}) &= - 2 l_{N}(\hat{\mathbf{B}}, \hat{\boldsymbol{\Omega}}) + |\mathbf{E}| \log n + 2 |\mathbf{E} | \log |\mathbf{V}|, % .
\end{aligned}$$ in which $(\hat{\mathbf{B}}, \hat{\boldsymbol{\Omega}})$ is the MLE estimate of model parameters (see ) obtained using the *residual iterative conditional fitting* algorithm .

**Forward flow.** We use a Graph Isomorphism Network (GIN) $\Phi$ to compute a $d$-dimensional representation for each node in the AG $\mathcal{G}_{t}$ at the $t$-th step of the generative process and use sum pooling to get an embedding for $\mathcal{G}_t$. Then, considering $\mathcal{A}_{t}$ as the space of feasible actions at $\mathcal{G}_t$ (i.e., those leading to an AG), we use an MLP $\phi \colon \mathbb{R}^{d} \rightarrow \mathbb{R}^{|\mathcal{A}_{t}|}$ with a softmax activation at its last layer to map $\mathcal{G}_t$’s embedding to a distribution over $\mathcal{A}_{t}$. More precisely, given $\mathbf{H}^{(t)} = \Phi(\mathcal{G}_{t}) \in \mathbb{R}^{|\mathbf{V}| \times d}$, we compute $$\mathbf{p} = \phi\left(\sum_{v \in \mathbf{V}} \mathbf{H}_{v}^{(t)} \right)$$ as the probability distribution over the feasible actions at $\mathcal{G}_{t}$.

**Backward flow.** Backward actions correspond to removing edges. Following , we parametrize the backward flow $F_B$ with an MLP and alternate between updating $\pi_F$ and $\pi_{F_B}$, using gradient-based optimization.

# Human-in-the-Loop Causal Discovery

Concluding the training, we propose leveraging the AGFN-generated samples to design questions for the expert that optimize the reduction of entropy in the distribution $p_{\theta}(\mathcal{G})$ over the space of AGs. Then, we use the human feedback to update $p_\theta(\mathcal{G})$, and iteratively repeat the process. The following paragraphs describe i) how we model human feedback, ii) how we update our belief over AGs given human responses, and iii) our experimental design strategy for expert inquiry.

### Modeling human feedback.

We assume humans are capable of answering questions regarding the ancestral relationship between pairs of random variables. In this case, we model their prior knowledge on a relation $r=\{U, V\}$ between nodes $U, V \in \mathbf{V}$ as a categorical distribution over a random variable denoted $\omega_{r}$. Fix an arbitrary total order $<$ in $\mathbf{V}$. By definition, $\omega_r=1$ if there is no edge between $U$ and $V$; $\omega_{r} = 2$ if $U$ is ancestor of $V < U$; $\omega_{r} = 3$ if $V$ is ancestor of $U > V$; and $\omega_{r} = 4$ if there is a bidirected edge between $U$ and $V$. Since the human has access to our AGFN before being probed for the first time, we set $\rho_{r, k} = p_{\theta}(\omega_r=k)$ as the prior probability of $\omega_r=k$. Moreover, we consider that the expert’s feedback $f_{r} \in \{1, 2, 3, 4\}$ on the relation $r$ is a noisy realization of the true, unobserved value of the relation feature $\omega_{r}$ under the expert’s model. Putting all elements together results in a two-level Bayesian hierarchical scheme for categorical data: $$\begin{aligned}
{2}
    \omega_{r} &\sim \text{Cat}(\boldsymbol{\rho}_{r}), \\
    f_{r} | \omega_{r} &\sim \text{Cat}\left(\delta_{\omega_{r}} \cdot \pi + (\mathbf{1} - \delta_{\omega_{r}}) \cdot \left( \frac{1 - \pi}{3} \right) \right), 
\end{aligned}$$ in which $\boldsymbol{\rho}_{r} = (\rho_{r, 1}, \rho_{r, 2}, \rho_{r, 3}, \rho_{r, 4})$ represents our prior beliefs about the relations’ features, $\pi \in [0, 1]$ reflects the reliability of the expert’s feedback, and $\delta_{k}$ is the $k$-th canonical basis of $\mathbb{R}^4$. Conveniently, the posterior distribution of the relation feature $\omega_{r}$ given the feedback $f_{r}$ is a categorical distribution parametrized by $$\frac{\boldsymbol{\rho}_{r}}{\eta_{r}} \odot \left( \pi \cdot \delta_{f_{r}} + \left(\frac{1 - \pi}{3}\right) \cdot (\mathbf{1} - \delta_{f_{r}})\right), % .$$ with $\eta_{r} = \rho_{r, f_{r}} \cdot \pi + \left(\frac{1 - \pi}{3}\right) \cdot (1 - \rho_{r, f_{r}})$.

### Updating beliefs.

We update our AGFN by weighing it by our posterior over the expert’s knowledge, described in the previous paragraph, similarly to a product-of-experts approach . For this, let $\mathbf{f}_{K} = (f_{r_{k}})_{1 \le k \le K}$ be the sequence of $K$ feedbacks issued by the expert and define our novel belief distribution $q(\mathcal{G}; \mathbf{f}_{K})$ over the space of AGs as $$q(\mathcal{G} ; \mathbf{f}_{K}) \propto p_{\theta}(\mathcal{G}) \prod_{1 \le k \le K} p(\omega_{r_{k}} | f_{r_{k}}).$$ Importantly, we use $p_{\theta}$ as proposal distribution in importance (re-)sampling to approximately sample from $q(\mathcal{G}; \mathbf{f}_{K})$ — or to approximate the expected value of a test function. More precisely, we estimate the value of a function $h$ over the space of AGs as: $$\label{eq:resample}
    \mathbb{E}_{q}[h(\mathcal{G})] \approx \sum_{t=1}^{T} c^{-1} \frac{q(\mathcal{G}^{(t)} ; \mathbf{f}_{K})}{p_{\theta}(\mathcal{G}^{(t)})} h(\mathcal{G}^{(t)})$$ with $(\mathcal{G}^{(t)})_{t=1}^T \sim p_\theta(\mathcal{G})$ and $c = \sum_{t=1}^T\nicefrac{q(\mathcal{G}^{(t)}; \mathbf{f}_{K})}{p_{\theta}(\mathcal{G}^{(t)})}$.

### Active knowledge elicitation.

To make the most out of possibly costly human interactions, we query the human about the relation that maximally reduces the expected cross-entropy between our belief over AGs before and after human feedback. More precisely, we define an acquisition function $a_k : {{\mathbf{V}}\choose{2}} \rightarrow \mathbb{R}$ for the $k>1$-th inquiry as: $$\label{eq:divergence} 
    a_{k}(r) = - \mathbb{E}_{f_r \sim p(\cdot| \mathbf{f}_{K})}\big[ \mathbf{H} \left( q(\mathcal{G}; \mathbf{f}_{K}, f_r), q(\mathcal{G} ; \mathbf{f}_{K} ) \right) \! \big]$$ in which $p(f_r|\mathbf{f}_{K})$ is the posterior predictive distribution according to the user model, $q_0 \propto R$ and $\mathbf{H}(\cdot, \cdot)$ is the cross-entropy. Then, we maximize this acquisition to select which relation $\tilde{r}_k$ we will probe the expert, i.e.: $$\tilde{r}_k = \mathop{\mathrm{arg\ max}}_{r \in {{\mathbf{V}}\choose{2}}} a_{k}(r). % .$$

As aforementioned, we use importance sampling with $q_0$ as a proposal to estimate the acquisition function $a_k$. This allows us to leverage AGFN samples and effectively avoid the need for retraining them. It is worth mentioning that because $\mathbf{H}(p, p^\prime) \geq \mathbf{H}(p, p)$ for any two distributions $p$ and $p^\prime$ of the same support, our strategy is equivalent to minimizing an upper bound on the entropy of $q_{k}$. Also, different from acquisitions based on information gain or mutual information, approximating via Monte Carlo does not require exhaustive integration over the space of AGs to yield asymptotically unbiased estimates — see Appendix.

# Experiments

Our experiments have three objectives. First, we validate that AGFN can accurately learn the target distribution over the space of AGs. Second, we show that AGFN performs competitively with alternative methods on three data sets. Third, we attest that our experimental design for incorporating the expert’s feedback efficiently reduces the uncertainty over AGFN’s distribution. We provide further experimental details in the Appendix. Code is available in the supplement.

## Distributional Assessment of AGFN

**Data.** Since violations of faithfulness are more likely in dense graphs , we create $20$ $5$-node random graphs from a directed configuration model  whose in- and out-degrees are uniformly sampled from $\{0, 1, 2, 3, 4\}$. We draw $500$ independent samples from a structure-compatible linear Gaussian SCM with random parameters for each graph.

**Setup.** We train AGFN for each random graph using their respective samples. Then, we collect AGFN samples and use them to compute empirical distributions over the (i) edge features (i.e., $p_{\theta}(U \rightarrow V)$, $p_{\theta}(U \leftarrow V)$, $p_{\theta}(U \leftrightarrow V)$ and $p_{\theta}(U \not\mathrel{-} V)$ for each pair $(U, V)$), (ii) BIC, and (iii) structural Hamming distance to the true causal diagram (SHD).

**Results.** shows that the AGFN adequately approximates the theoretical distribution induced by the reward in . Furthermore, AGFNs induce distributions over BIC and SHD values that closely resemble those induced by $p(\mathcal{G}) \propto R(\mathcal{G})$. We also note an important improvement over the prior art on probabilistic CD (N-ADMG): we found that over $60\%$ of its samples were non-ancestral and that this method was of little use for making inferences over AGs. Meanwhile, AGFN does not sample non-ancestral graphs.

## Comparison with SOTA CD algorithms

<figure id="fig:datasets">
<figure>
<span class="image placeholder" data-original-image-src="figures/chain4.pdf" data-original-image-title=""></span>
<figcaption>chain4</figcaption>
</figure>
<figure>
<span class="image placeholder" data-original-image-src="figures/iv.pdf" data-original-image-title=""></span>
<figcaption>IV</figcaption>
</figure>
<figure>
<span class="image placeholder" data-original-image-src="figures/collfork.pdf" data-original-image-title=""></span>
<figcaption>collfork</figcaption>
</figure>
<figcaption><strong>Ancestral graphs</strong> representing the data generating models for the three considered datasets in Table <span class="math inline">\(\ref{tab:table}\)</span>.</figcaption>
</figure>

**Data.** We generate $10$ datasets with $500$ independent samples from the randomly parametrized linear Gaussian SCMs corresponding to the canonical causal diagram in each AG depicted in Figure . Unshielded colliders and discriminating paths are fundamental patterns in the detection of invariances by CD algorithms under latent confounding . Thus, we consider the following 4-node causal diagrams with increasingly difficult configurations: (i) `chain4`, a chain without latent confounders; (ii) `collfork`, a graph with triplets involving colliders and non-colliders under latent confounding, and (iii) `IV`, a structure with a discriminating path for $Z$: $W \rightarrow X \leftarrow Z \rightarrow Y$.

**Baselines.** We compare AGFN with four notable CD methods: FCI , GFCI , DCD , and N-ADMG . The baselines span four broad classes of CD methods. FCI is a seminal constraint-based CD algorithm that learns a PAG consistent with conditional independencies entailed by statistical tests. GFCI is a hybrid CD algorithm that learns a PAG by first obtaining an approximate structure using FGS (a BIC-score-based search algorithm for causally sufficient scenarios) and then by applying FCI to identify possible confounding and remove some edges added by FGS. DCD casts CD as continuous optimization with differentiable algebraic constraints defining the space of AGs and uses gradient-based algorithms to solve it. N-ADMG computes a variational approximation of the joint posterior distribution over the space of bow-free causal diagrams associated with non-linear SCMs with additive noise. While N-ADMG focuses on a more restricted setting compared to AGs, it offers some uncertainty quantification in the variational pohttps://www.overleaf.com/project/650454a084b798332af29ebesterior, making it more closely comparable to our approach. We rigorously follow the experimental guidelines in the original works.

**Experimental setup** We train AGFN on each dataset and use it to sample 100k graphs. We also apply FCI, GFCI, and DCD to $100$ bootstrapped resamplings of each dataset to emulate *confidence* distributions induced by these algorithms. To compare the algorithms’ outputs, we compute the sample mean and standard deviation of the BIC and SHD at the PAG level. Specifically, we compute the SHD between the ground-truth PAG and each estimated PAG obtained by each method. If the output is a PAG member (as for DCD, N-ADMG, and AGFN) we use FCI to transform the output using these graphs as oracles for conditional independencies. Furthermore, we directly compute the BIC for the outputs, as all PAG members are asymptotically score-equivalent.

**Results.** compares AGFN against baseline CD algorithms. Notably, our method consistently outperforms the only probabilistic baseline in the literature (N-ADMG) in terms of both SHD and BIC. As expected, however, the average BIC and SHD induced by AGFN are larger than those induced by the bootstrapped versions of the non-probabilistic algorithms, and the variances are greater; this is due to the inherent sampling diversity of our method and the resulting generation of possibly implausible samples. Indeed, Table  shows that the three most rewarding samples from AGFN are as good as (and sometimes better than) the other CD algorithms. Results for N-ADMG comprise the three most frequent samples from the variational distribution.

## Simulating humans in the loop

**Data.** We follow the procedure from to generate graphs with $4$, $6$, $8$ and $10$ nodes. We draw $500$ samples from a compatible linear Gaussian SCM and use them to train an AGFN. Then, we follow our active elicitation strategy from to probe simulated humans, adhering to the generative model described in the same section, with $\pi = 0.9$.

**Setup.** Since we are the first to propose an optimal design for expert knowledge elicitation, there are no baselines to compare AGFN against. That being said, we aim to determine whether the inclusion of expert feedback enhances the concentration of the learned distribution around the true AG, and evaluate the effectiveness of our elicitation strategy. To do so, we measure SHD to the true AG and BIC as a function of the number of expert interactions.

**Results.** Figure  shows that incorporating expert feedback substantially decreases the expected SHD and BIC under our belief over AGs. On the one hand, the remarkable decrease in expected SHD shows that our belief becomes increasingly focused on the true AG as we iteratively request the expert’s feedback, regardless of the querying strategy. On the other hand, the second row shows that our querying strategy results in a substantial decrease in the BIC, demonstrating a faster reduction than random queries. This validates the notion that some edges are more informative than others, and we should prioritize them when probing the expert.

# Related Work

**CD under latent confounding.** Following the seminal works by and introducing the complete FCI, a variety of works have emerged. Among them are algorithms designed for sparse scenarios, including RFCI and others . Notably, ’s framework uses a Bayesian approach to CD of Gaussian causal diagrams based on sparse covariance matrices. Nonetheless, it requires sampling one edge at a time and relies on numerical heuristics that might effectively alter the posterior we are sampling from. introduced the conservative FCI to handle conflicts arising from statistical errors in scenarios with limited data, even though it yields less informative results. Subsequent efforts to improve reliability led to the emergence of constraint-based CD algorithms based in Boolean satisfiability , although they are known to scale poorly on $|\mathbf{V}|$ . In another paradigm, score-based search algorithms rank MAGs according to goodness-of-fit measures, commonly using BIC for linear Gaussian SCMs . There are also hybrid approaches that combine constraint-based strategies to reduce the search space, such as GFCI , M3HC , BCCD , and GSPo . Continuous optimization approaches have recently emerged as a novel approach to score-based CD, such as DCD and N-ADMG .

**CD with expert knowledge.** Previous works on CD have explored various forms of background knowledge. This includes knowledge on edge existence/non-existence , ancestral constraints , variable grouping , partial order and typing of variables . Incorporating expert knowledge is pivotal to reducing the search space and the size of the learned equivalence class. However, due to significant challenges, up to date, there are only a few works trying to integrate human knowledge into CD within the context of latent confounding . These works operate under the assumption of perfect expert feedback. In contrast, our contribution is novel in that it confronts the challenges of real-world situations where expert input might be inaccurate.

# Discussion

We presented AGFN, the first probabilistic CD method that accounts for latent confounding and incorporates potentially noisy human feedback in the loop. AGFN samples AGs according to a score function, quantifying the uncertainty in the learning process. Furthermore, it can leverage human feedback in an optimal design strategy, efficiently reducing our uncertainty on the true data-generating model.

This work is focused on linear Gaussian models, using BIC as our score. However, the implementation of AGFNs is not restricted by this choice. In principle, we could replace the BIC with alternative score functions that are more appropriate for different types of variables, e.g. for discrete data . It is also important to highlight that our framework does not require retraining the AGFN after we see human feedback. Moreover, AGFN is a GPU-powered algorithm, and while we used only one GPU in our experiments, it is possible to greatly accelerate AGFN by using cluster architectures with multiple GPUs.

By offering uncertainty-quantified CD together with a recipe for including humans in the loop, we expect AGFNs will significantly enhance the accuracy and reliability of CD, especially in real-world domains. Moreover, AGFNs bring a novel perspective to developing more comprehensive tools for downstream causal tasks , as the resulting distribution encodes knowledge from data and human feedback while accounting for epistemic uncertainty. For example, methods for causal reasoning that currently rely on a single AG could exploit this distribution to incorporate a richer understanding of uncertainty and knowledge, thereby enhancing their robustness and reliability.

# Acknowledgments

Diego Mesquita acknowledges the support by the Fundação Carlos Chagas Filho de Amparo à Pesquisa do Estado do Rio de Janeiro FAPERJ (SEI-260003/000709/2023), the São Paulo Research Foundation FAPESP (2023/00815-6), the Conselho Nacional de Desenvolvimento Científico e Tecnológico CNPq (404336/2023-0), and the Silicon Valley Community Foundation through the University Blockchain Research Initiative (Grant \#2022-199610). António Góis acknowledges the support by Samsung Electronics Co., Ldt. Adèle Ribeiro and Dominik Heider were supported by the LOEWE program of the State of Hesse (Germany) in the Diffusible Signals research cluster and by the German Federal Ministry of Education and Research (BMBF) \[031L0267A\] (Deep Insight). Samuel Kaski was supported by the Academy of Finland (Flagship programme: Finnish Center for Artificial Intelligence FCAI), EU Horizon 2020 (European Network of AI Excellence Centres ELISE, grant agreement 951847), UKRI Turing AI World-Leading Researcher Fellowship (EP/W002973/1). We also acknowledge the computational resources provided by the Aalto Science-IT Project from Computer Science IT.

# Additional Related Works

**Generative Flow Networks** are generative models that sample discrete composite objects from an unnormalized reward function. They have been successfully used to sample various structures such as protein sequences  and schedules . They have also been used to train energy-based models . In the field of structure learning, they have been applied to Bayesian networks — more specifically to sample a posterior over DAGs in linear Gaussian networks, although without accounting for unobserved confounding . Recently, proposed an extension to jointly infer the structure and parameters, also grounded in the assumption of causal sufficiency. It is worth highlighting that training GFlowNets in these scenarios presents optimization challenges, resulting in the utilization of a variety of loss functions . Moreover, proposed an extension of GFlowNets to continuous domains.

# Cross-entropy acquisition

The expected *mutual information* and the *information gain* are the most widely used information-theoretic measures to actively interact with a human and choose the most informative data points to be labeled . However, we instead use the negative expected cross-entropy between the current and updated beliefs as the acquisition function of our experimental design (see ). As we show next, the approximation of both the mutual information and the information gain is intrinsically dependent upon the estimation of the log-partition of the updated beliefs over the space of ancestral graphs. Doing so is computationally intensive, and we would either need to use a Monte Carlo estimator of the integrals or use some posterior approximation — in both cases, leading to asymptotically biased estimates of the acquisition. In contrast, we can easily leverage AGFN samples to compute asymptotically unbiased estimates of our acquisition function. The next paragraphs provide further details.

#### Mutual information.

The *mutual information* between two random variables $X$ and $Y$ with joint distribution $p(X, Y)$ and marginal distributions $p(X)$ and $p(Y)$ is $$I(X, Y) = \mathcal{D}_{KL}[ p(X, Y) || p(X) \otimes p(Y)],$$ in which $\mathcal{D}_{KL}$ is the Kullback-Leibler divergence. In this context, an alternative approach to our experimental design for active knowledge elicitation would consist in iteratively maximizing the expected mutual information between the observed samples, $\mathcal{G}$, and the elicited feedback, $f_{K}$, to select the relation about which the expert would provide feedback. More specifically, we could choose $$\label{eq:mutualinformation}  
    r_{K + 1} = \mathop{\mathrm{arg\ max}}_{r \in {\mathbf{V} \choose 2}} \mathbb{E}_{f_{r} \sim p(\cdot | \mathbf{f}_{K})} [ I(\mathcal{G}, f_{r}) ],$$ in which $$I(\mathcal{G}, f_{r}) = \mathcal{D}_{KL}[ q(\mathcal{G}, f_{r} | \mathbf{f}_{K}) || q(\mathcal{G} | \mathbf{f}_{K}) \otimes p(f_{r} | \mathbf{f}_{K})], \label{eq:MI}$$ at each interaction with the expert. Nonetheless, note that $$\begin{aligned}
    &q(\mathcal{G}, f_{r} | \mathbf{f}_{K}) = q(\mathcal{G} | \mathbf{f}_{K + 1}) p(f_{r} | \mathbf{f}_{K}) \\ & = c_{K + 1}(f_{r}) p_{\theta}(\mathcal{G}) \left(\prod_{1 \le k \le K + 1} p(\omega_{r_{k}} | f_{r_{k}})\right) \cdot p(f_{r} | \mathbf{f}_{K}),  
\end{aligned}$$ with $f_{r_{K + 1}} = f_{r}$ and $$\label{eq:partition} 
    c_{K + 1}(f_{r}) = \left(\!\!\sum_{\mathcal{G}} p_{\theta}(\mathcal{G}) \!\! \left(\prod_{1 \le k \le K + 1} p(\omega_{r_{k}} | f_{r_{k}}) \!\!\right)\!\!\right)^{-1}$$ as the partition function of our updated beliefs. Note also that entails computing the entropy of $q(\mathcal{G}, f_r | \mathbf{f}_K)$. Thus, the selection criterion in requires an accurate estimate of $\log c_{K + 1}(f_{r})$ — which is well-known for being a difficult problem — and the Monte Carlo estimator for the log-partition function is asymptotically biased.

#### Information gain.

The expected *information gain* of an elicitation is defined as the expected KL divergence between our updated and current beliefs over ancestral graphs. This approach is widely employed in Bayesian experimental design . In our framework, the information gain resulting from a feedback $f_{r}$ is $$% \label{eq:informationgain}  
    \text{IG}_{K}(f_{r}) = \mathcal{D}_{KL}[ q(\mathcal{G} | \mathbf{f}_{K} \cup f_{r}) || q(\mathcal{G} | \mathbf{f}_{K})],  % .$$ which yields the criterion $$\label{eq:informationgain} 
    r_{K + 1} = \mathop{\mathrm{arg\ max}}_{r \in {\mathbf{V} \choose 2}} \mathbb{E}_{f_{r} \sim p(\cdot | \mathbf{f}_{K})} \left[ \text{IG}_{K}(f_{r}) \right].$$ Nonetheless, suffers from the same problems of : it requires approximating the logarithm of the partition function $c_{K + 1}(f_{r})$ of a distribution over the combinatorially large space of ancestral graphs, which is notably very challenging to estimate. Indeed, as $$\begin{aligned}
    \mathcal{D}_{KL} [ q(\mathcal{G} | \mathbf{f}_{K + 1}) || q(\mathcal{G} | \mathbf{f}_{K}) ] = \underset{\mathcal{G} \sim q(\cdot | \mathbf{f}_{K + 1}) }{\mathbb{E}} \left[ \log \frac{q(\mathcal{G} | \mathbf{f}_{K + 1})}{q(\mathcal{G} | \mathbf{f}_{K})} \right] \\ 
    = \underset{\mathcal{G} \sim q(\cdot | \mathbf{f}_{K + 1})}{\mathbb{E}} \left[ \log p(f_{r} | \omega_{r}) + \log c_{K + 1}(f_{r}) - \log c_{K} \right], 
\end{aligned}$$ with $f_{r_{K + 1}} = f_{r}$, $c_{K}$ as the partition function of $q(\cdot | \mathbf{f}_{K})$ — that does not depend upon $f_{r}$ —, and $c_{K + 1}(f_{r})$ defined in , the estimation of the information gain is inherently dependent upon the estimation of the log-partition function.

#### Cross-entropy.

The cross-entropy between our updated and current beliefs is an intuitively plausible and practically useful strategy to interact with an expert efficiently. In fact, since $$\begin{split}
    \mathbf{H}&[q(\cdot | \mathbf{f}_{K + 1}), q(\cdot | \mathbf{f}_{K})]\\ 
    &= \underset{\mathcal{G} \sim q(\cdot | \mathbf{f}_{K + 1})}{\mathbb{E}} [- \log q(\mathcal{G} | \mathbf{f}_{K})] \\ 
    &= \underset{\mathcal{G} \sim q(\cdot | \mathbf{f}_{K + 1})}{\mathbb{E}} \left[ - \log p_{\theta}(\mathcal{G}) - \sum_{1 \le k \le K} \log p(\omega_{r_{k}} | f_{r_{k}}) - l_{K} \right]
\end{split},$$ in which $l_{K}$ is the log-partition function of the distribution $q(\cdot | \mathbf{f}_{K})$. Further, the cross-entropy depends exclusively upon i) the logarithm of the samples’ rewards, $\log p_{\theta}(\mathcal{G})$, which is readily computed within AGFN’s generative process, and ii) the posterior distribution over the relations’ features $\omega_{r}$ given the expert’s feedbacks $f_{r}$, which is available in closed form. Hence, the previously mentioned expectation is unbiasedly and consistently estimated by our importance sampling scheme. Furthermore, our empirical findings in suggest that the cross-entropy yields good results and consistently outperforms a uniformly random strategy with respect to the BIC score.

# Experimental details

We lay out the experimental and implementational details of our empirical analysis in the next subsections. In , we describe the specific configurations of the CD algorithms that we compared with our method in . Then, we consider in some practical guidelines and architectural specifications that enable us to train and make inferences with AGFN efficiently. Finally, we contemplate in the algorithmic details for simulating the expert’s feedback according to our model for active knowledge elicitation.

## Baselines

#### FCI.

For the results in , we first estimated a PAG using the stable version of FCI, which produces a fully order-independent final skeleton . To identify conditional independencies, we used Fisher’s Z partial correlation test with a significance level of $\alpha = 0.05$. The BIC score associated with the PAG estimated by the FCI was computed as the BIC of a randomly selected maximal AG (MAG) within the equivalence class characterized by such PAG. The maximality of an AG depends on the absence of inducing paths between non-adjacent variables, which are paths where every node along it (except the endpoints) is a collider and every collider is an ancestor of an endpoint . This ensures that in the MAG every non-adjacent pair of nodes is m-separated by some set of other variables. Importantly, Markov equivalent MAGs exhibit asymptotic equivalence in terms of BIC scores . As a result, the choice of a random MAG does not disrupt the validity of our results.

#### GFCI.

Similarly, we applied GFCI with an initial search algorithm (FGS) based on the BIC score and the subsequent application of the FCI with conditional independencies identified by the Fisher’s Z partial correlation test with a significance level $\alpha = 0.05$. This was performed for all datasets listed in . Also similar to the procedure adopted with the FCI, the BIC score associated with the estimated PAG was computed as the BIC of a randomly selected MAG within the equivalence class characterized by such PAG.

#### DCD.

We adhered to the instructions provided in the official repository[^1] to apply the DCD method on the datasets in . The SHD was obtained between the ground-truth PAG and the PAG corresponding to the estimated ADMG (i.e., the one obtained via FCI by using the d-separations entailed by the estimated ADMG as an oracle for conditional independencies). On the other hand, the BIC was computed for the estimated ADMG directly.

#### N-ADMG.

To estimate the parameters of the variational distribution defined by N-ADMG, we executed the code provided at the official repository[^2] For fairness, we used the same hyperparameters and architectures reported in their original work ; in particular, we trained the models for $30$k epochs. After this, we sampled $100$k graphs from the learned distribution. It is worth mentioning that the constraints of bow-free ADMG are guaranteed in the N-ADMG samples only in an asymptotic sense. Thus, we manually removed any cyclic graphs from the learned distribution. Then, we proceeded exactly as with DCD to estimate both the average SHD and the average BIC under the variational distribution.

## Implementational details for AGFN

#### Masking.

To ensure AGFN only samples ancestral graphs, we keep track of a binary mask $\mathbf{m}_{t}$ that indicates which actions lead to a valid state at the iteration $t$ of the generative process; this mask defines the support of the policy evaluated at the corresponding state. In more detail, let $\mathbf{y}_{t}$ be the last layer embedding (prior to a softmax) at iteration $t$ of the neural network used to parametrize the forward flow of AGFN. The probability distribution over the space of feasible actions is then $$\mathbf{p}_{t} = \text{Softmax} \left( \mathbf{y}_{t} \odot \mathbf{m}_{t} + \epsilon \cdot (1 - \mathbf{m}_{t}) \right)$$ for a large and negative constant $\epsilon$. We empirically verified that $\epsilon = -10^{5}$ is sufficient to avoid the sampling of non-ancestral graphs.

#### Exploratory policy.

During training, we must use an exploratory policy that (i) enables the exploration of yet unvisited states within the pointed DAG and (ii) exploits highly valuable and already visited states. To alleviate this phenomenon, we also draw trajectories from a uniform policy, which is a widespread practice in the literature . More precisely, let $\text{Ch}(\mathcal{G}_{t})$ be the set of states (i.e., ancestral graphs) directly reachable from $\mathcal{G}_{t}$ and $\alpha \in [0, 1]$. At each iteration $t$ of the generative process, we sample an action (either an edge to be appended to the graph or a signal to stop the process) $$a_{t} \sim (1 - \alpha) \cdot \mathcal{U}(\text{Ch}(\mathcal{G}_{t})) + \alpha \cdot \pi_{F}(\cdot | \mathcal{G}_{t}) % .$$ and modify $\mathcal{G}_{t}$ accordingly. The parameter $\alpha$ quantifies the mean proportion of on-policy actions and represents a trade-off between choosing actions that lead to highly valuable states ($\alpha = 1$) and actions that lead to unvisited states ($\alpha = 0$). We fix $\alpha = \frac{1}{2}$ throughout the experiments. During inference, we set $\alpha = 1$ to sample actions exclusively from the GFlowNet’s learned policy.

#### Detection of invalid states.

We use the algebraic condition in to check whether a graph $\mathcal{G}$ is ancestral. At each iteration of the generative process, we draw an action from the current exploratory policy and test the ancestrality of the updated graph; if it is not ancestral, we revert the sampled action and mask it. Importantly, this protocol guarantees that all graphs sampled from AGFN are ancestral.

#### Batch sampling.

We exploit batch sampling to fully leverage the power of GPU-based computing in AGFN. As both the maximum-log-likelihood-based reward and the validation of the states are parallelizable operations, we are able to distribute them across multiple processing units and efficiently draw samples from the learned distribution. Crucially, this end-to-end parallelization substantially improves the computational feasibility of our algorithm and is a notable feature generally unavailable in prior works . We use a batch size of 256 for all the experiments — independently of the graph size.

#### Training hyperparameters.

For AGFN’s forward flow, we use a Graph Isomorphism Network (GIN, ) with $2$ layers to compute embeddings of dimension $256$. Then, we project these embeddings to a probability distribution using a three-layer MLP having leaky RELUs with a negative slope of $-0.01$ as activation functions. Correspondingly, we use an equally configured three-layer MLP to parametrize AGFN’s backward flow. For training, we use the Adam method for the stochastic optimization problem defined by the minimization of the loss in . Moreover, we trained the neural networks for $3000$ epochs for the human-in-the-loop simulations (in which we considered graphs having up to $10$ nodes) and for $500$ epochs for both the assessment of the distributional quality of AGFN and the comparison of AGFN with alternative CD approaches.

#### Computational settings.

We trained the AGFNs for the experiments in and and for $500$ epochs in computers equipped with NVIDIA’s V100 GPUs. All the experiments were executed in a cluster of NVIDIA’s V100 GPUs and the algorithms were implemented using the machine learning framework `PyTorch`. To estimate the PAG corresponding to AGFN’s samples and compute the SHDs reported in , we used the FCI’s implementation of the `pcalg` package in `R` considering the d-separations entailed by these samples as a criterion for conditional dependence.

## Human in the loop

#### Algorithmic details.

We describe in our procedure for simulating interactions with an expert. Initially, we estimate the marginal probabilities $p(\omega_{r}=k)$ of a relation $r$ displaying the feature $k \in \{1, 2, 3, 4\}$ under AGFN’s learned distribution. This is our prior distribution. In , we denote $\{1, 2, 3, 4\}$ by $[4]$. Then, we iteratively select the relation that maximizes our acquisition function; the simulated human thus returns a feedback that equals the selected relation’s true feature with probability $\pi$ or is otherwise uniformly distributed among the incorrect alternatives. Importantly, this iterative mechanism can be interrupted at any iteration and the collected feedbacks can be used to compute the importance weights necessary for estimating expectations of functionals under our updated beliefs.

# Additional experiments

<figure id="fig:arch">
<span class="image placeholder" data-original-image-src="figures/ablations_arch.pdf" data-original-image-title="" width=".7\linewidth"></span>
<figcaption><strong>Architectural design of AGFN.</strong> Top: The inductively biased parametrization of AGFN’s forward flow — based upon a GNN — enables the substantial reduction of the number of epochs required for training. Bottom: The use of a parametrized backward policy similarly enhances the training efficiency compared to a uniform policy. For both experiments, we considered <span class="math inline">\(\mathcal{L}(\theta) &lt; 0.1\)</span> as the early stopping criterion to interrupt AGFN’s training.</figcaption>
</figure>

#### Trade-off between diversity and optimality in AGFN.

We may use tempered rewards to increase the frequency of high-scoring samples and thereby reduce the diversity of AGFN’s distribution. More precisely, we choose a temperature $T$ and consider $$\label{eq:tempering} 
    R_{T}(\mathcal{G}) = R(\mathcal{G})^{1/T} = \exp\left\{\frac{\mu - U(\mathcal{G})}{T \sigma}\right\}$$ as the reward upon which the GFlowNet is trained; if $T \rightarrow 0$, the distribution $p_{T} \propto R_{T}$ converges to a point mass in $R(\mathcal{G})$’s mode and, if $T \rightarrow \infty$, $p_{T}$ converges to an uniform distribution. This approach resembles the simulated tempering scheme commonly exploited in Monte Carlo methods and was previously considered in the context of GFlowNets by . shows that progressively cold distributions (i.e., with $T \rightarrow 0$) lead to progressively concentrated and decreasingly diverse samples. Notably, the use of cold distributions may be adequate if we are highly confident in our score and are mostly interested in high-scoring samples .

#### Sensitivity analysis for different noise levels.

displays the effect of the feedback of an increasingly reliable expert over the expectations of both the SHD and the BIC. Notably, the usefulness of these feedbacks increases as the feedback noise decreases. This is expected as, for example, a completely unreliable expert consistently rules out only one of four possibilities for the features of each relation; then, there remains a great ambiguity, albeit not as much as there was prior to their feedback, about the true nature of the elicited causal relation. Moreover, this experiment highlights the potential to adjust the reliability parameter $\pi$ to incorporate knowledge into AGFN’s learned distribution regarding the non-existence of a particular relation, rather than its existence. More specifically, assume that the expert is certain that there is no directed edge from the variable $U$ to the variable $V$ in the underlying ancestral graph; for instance, a doctor may be certain that cancer ($U$) is not an ancestor (cause) of smoking ($V$), but may be uncertain about the definite relation between $U$ and $V$ (i.e., smoking may or may not cause cancer). To incorporate such knowledge into our model, one approach is to set a necessarily small reliability parameter $\pi$ (possibly, $\pi = 0$) along with the improbable relation $U \rightarrow V$. This feedback will then be modeled as a relation unlikely to exist in the true ancestral graph. We emphasize that our model for the expert’s responses is straightforwardly extensible to accommodate multiple feedbacks about the same causal relation under different reliability levels.

#### Ablation studies.

shows the increase in the training efficiency due to our architectural designs for parametrizing both the forward and backward flows of AGFN. Noticeably, the use of a two-layer graph isomorphism network with a 256-dimensional embedding for the forward flow entailed a decrease of more than 10x in the number of epochs required for successfully training AGFN; this highlights the effectiveness of an inductively biased architectural design for the parametrization of GFlowNet’s flows. Correlatively, the use of a parametrized backward flow significantly enhances the training efficiency of AGFN and emphasizes the inadequacy of a uniformly distributed backward policy pointed out in a previous work .

#### Human-aided AGFN versus alternative CD methods.

exposes the significant enhancement of AGFN’s point estimates entailed by our HITL framework for CD. This underlines the usefulness of the elicited knowledge, which is simply incorporated into our model through a re-weighting of the reward function, enabling the identification of the true ancestral graph. In contrast, most alternative CD algorithms cannot be as easily adapted to include various forms of expert knowledge — and such incorporation, when it is possible, usually precedes any inferential process or assumes the knowledge is perfect .

[^1]: Available online at `https://gitlab.com/rbhatta8/dcd`.

[^2]: Available online at `https://github.com/microsoft/causica/releases/tag/v0.0.0`.
