{"version":3,"file":"content.bundle.js","sources":["../content/metadata_fetcher.ts","../content/paper_detector.ts","../content/annotator.ts","../content/message_handlers.ts","../content/index.ts"],"sourcesContent":["// content/metadata_fetcher.ts - Fetch paper metadata from services\n\n/**\n * Paper metadata interface\n */\nexport interface PaperMetadata {\n  title?: string;\n  authors?: string;\n  abstract?: string;\n  url?: string;\n  source?: string;\n  id?: string;\n  primary_id?: string;\n  [key: string]: any;\n}\n\n/**\n * Cache for paper metadata to avoid repeated API calls\n */\nconst metadataCache = new Map<string, PaperMetadata>();\n\n/**\n * Fetch paper metadata from APIs or background service\n * @param {string} source Paper source type\n * @param {string} id Paper ID\n * @returns {Promise<PaperMetadata>} Paper metadata\n */\nexport async function fetchPaperMetadata(source: string, id: string): Promise<PaperMetadata> {\n  // Create cache key\n  const cacheKey = `${source}:${id}`;\n  \n  // Check cache first\n  if (metadataCache.has(cacheKey)) {\n    return metadataCache.get(cacheKey)!;\n  }\n  \n  try {\n    // Try to get metadata from the extension's background script first\n    const backgroundMetadata = await getMetadataFromBackground(source, id);\n    \n    if (backgroundMetadata) {\n      // Cache the result\n      metadataCache.set(cacheKey, backgroundMetadata);\n      return backgroundMetadata;\n    }\n\n    // Fall back to directly fetching from APIs\n    let metadata: PaperMetadata;\n    \n    switch (source) {\n      case 'arxiv':\n        metadata = await fetchArxivMetadata(id);\n        break;\n      case 'semanticscholar':\n        metadata = await fetchSemanticScholarMetadata(id);\n        break;\n      case 'openreview':\n        metadata = await fetchOpenReviewMetadata(id);\n        break;\n      default:\n        // For other sources, use minimal data\n        metadata = {\n          title: `${source.toUpperCase()} Paper: ${id}`,\n          id: id,\n          source: source\n        };\n    }\n    \n    // Cache and return the result\n    metadataCache.set(cacheKey, metadata);\n    return metadata;\n  } catch (error) {\n    console.error(`Error fetching metadata for ${source}:${id}:`, error);\n    \n    // Return minimal metadata on error\n    return {\n      title: `${source.toUpperCase()} Paper: ${id}`,\n      id: id,\n      source: source\n    };\n  }\n}\n\n/**\n * Get metadata from background script\n * @param {string} source Paper source\n * @param {string} id Paper ID\n * @returns {Promise<PaperMetadata|null>} Paper metadata or null\n */\nasync function getMetadataFromBackground(source: string, id: string): Promise<PaperMetadata | null> {\n  return new Promise(resolve => {\n    chrome.runtime.sendMessage({\n      type: 'getPaperMetadata',\n      source: source,\n      id: id\n    }, (response) => {\n      // Check if we got valid metadata\n      if (response && response.title) {\n        resolve(response);\n      } else {\n        resolve(null);\n      }\n    });\n  });\n}\n\n/**\n * Fetch arXiv metadata from the arXiv API\n * @param {string} id arXiv paper ID\n * @returns {Promise<PaperMetadata>} Paper metadata\n */\nasync function fetchArxivMetadata(id: string): Promise<PaperMetadata> {\n  try {\n    const apiUrl = `https://export.arxiv.org/api/query?id_list=${id}`;\n    const response = await fetch(apiUrl);\n    \n    if (!response.ok) {\n      throw new Error(`arXiv API error: ${response.status}`);\n    }\n    \n    const text = await response.text();\n    \n    // Extract data using regex since we're in content script\n    // (DOMParser is available but a little more complex to handle)\n    const titleMatch = text.match(/<title>(.*?)<\\/title>/);\n    const authorsMatch = text.match(/<author>(.*?)<\\/author>/g);\n    const summaryMatch = text.match(/<summary>(.*?)<\\/summary>/s);\n    \n    const title = titleMatch ? titleMatch[1].trim() : `arXiv Paper: ${id}`;\n    \n    // Process authors\n    let authors = '';\n    if (authorsMatch) {\n      const authorNames = authorsMatch.map(authorTag => {\n        const nameMatch = authorTag.match(/<name>(.*?)<\\/name>/);\n        return nameMatch ? nameMatch[1].trim() : '';\n      }).filter(Boolean);\n      \n      authors = authorNames.join(', ');\n    }\n    \n    const abstract = summaryMatch ? summaryMatch[1].trim() : '';\n    \n    return {\n      title,\n      authors,\n      abstract,\n      id,\n      source: 'arxiv',\n      url: `https://arxiv.org/abs/${id}`\n    };\n  } catch (error) {\n    console.error('Error fetching arXiv metadata:', error);\n    return {\n      title: `arXiv Paper: ${id}`,\n      id,\n      source: 'arxiv',\n      url: `https://arxiv.org/abs/${id}`\n    };\n  }\n}\n\n/**\n * Fetch Semantic Scholar metadata\n * @param {string} id Semantic Scholar paper ID\n * @returns {Promise<PaperMetadata>} Paper metadata\n */\nasync function fetchSemanticScholarMetadata(id: string): Promise<PaperMetadata> {\n  try {\n    const apiUrl = `https://api.semanticscholar.org/v1/paper/${id}`;\n    const response = await fetch(apiUrl);\n    \n    if (!response.ok) {\n      throw new Error(`Semantic Scholar API error: ${response.status}`);\n    }\n    \n    const data = await response.json();\n    \n    // Extract authors as a string\n    const authors = data.authors\n      ? data.authors.map((author: { name: string }) => author.name).join(', ')\n      : '';\n    \n    return {\n      title: data.title || `Semantic Scholar Paper: ${id}`,\n      authors,\n      abstract: data.abstract || '',\n      id,\n      source: 'semanticscholar',\n      url: `https://www.semanticscholar.org/paper/${id}`,\n      year: data.year,\n      citationCount: data.citationCount\n    };\n  } catch (error) {\n    console.error('Error fetching Semantic Scholar metadata:', error);\n    return {\n      title: `Semantic Scholar Paper: ${id}`,\n      id,\n      source: 'semanticscholar',\n      url: `https://www.semanticscholar.org/paper/${id}`\n    };\n  }\n}\n\n/**\n * Fetch OpenReview metadata\n * @param {string} id OpenReview paper ID\n * @returns {Promise<PaperMetadata>} Paper metadata\n */\nasync function fetchOpenReviewMetadata(id: string): Promise<PaperMetadata> {\n  try {\n    const apiUrl = `https://api.openreview.net/notes?id=${id}`;\n    const response = await fetch(apiUrl);\n    \n    if (!response.ok) {\n      throw new Error(`OpenReview API error: ${response.status}`);\n    }\n    \n    const data = await response.json();\n    \n    // Check if we have valid data\n    if (data.notes && data.notes.length > 0) {\n      const note = data.notes[0];\n      const content = note.content || {};\n      \n      // Handle different content structures\n      const getContentValue = (field: string): any => {\n        if (!content[field]) return '';\n        return typeof content[field] === 'object' && 'value' in content[field]\n          ? content[field].value\n          : content[field];\n      };\n      \n      // Get title\n      const title = getContentValue('title') || `OpenReview Paper: ${id}`;\n      \n      // Handle authors (could be in different formats)\n      let authors = '';\n      const authorsData = getContentValue('authors');\n      if (Array.isArray(authorsData)) {\n        authors = authorsData.join(', ');\n      } else if (typeof authorsData === 'string') {\n        authors = authorsData;\n      }\n      \n      // Get abstract\n      const abstract = getContentValue('abstract') || '';\n      \n      return {\n        title,\n        authors,\n        abstract,\n        id,\n        source: 'openreview',\n        url: `https://openreview.net/forum?id=${id}`,\n        venue: getContentValue('venue') || note.venue,\n        forum_id: note.forum\n      };\n    }\n    \n    // If no valid data found\n    return {\n      title: `OpenReview Paper: ${id}`,\n      id,\n      source: 'openreview',\n      url: `https://openreview.net/forum?id=${id}`\n    };\n  } catch (error) {\n    console.error('Error fetching OpenReview metadata:', error);\n    return {\n      title: `OpenReview Paper: ${id}`,\n      id,\n      source: 'openreview',\n      url: `https://openreview.net/forum?id=${id}`\n    };\n  }\n}\n","// content/paper_detector.ts - Paper link detection and processing\n\nimport { fetchPaperMetadata } from './metadata_fetcher';\nimport { createPopup, createPopupWrapper } from './annotator';\n\n/**\n * Paper source information\n */\nexport interface SourceInfo {\n  type: string;\n  id: string;\n  url: string;\n}\n\n/**\n * Reference to active popup\n */\nlet activePopup: HTMLElement | null = null;\n\n/**\n * Format a primary ID properly using a consistent approach\n * @param {string} source Source type (e.g., 'arxiv', 'doi')\n * @param {string} id Original ID from the source\n * @returns {string} Formatted primary ID\n */\nexport function formatPrimaryId(source: string, id: string): string {\n  // Sanitize the ID by replacing problematic characters\n  const safeId = id\n    .replace(/\\//g, '_')\n    .replace(/:/g, '.')\n    .replace(/\\s/g, '_')\n    .replace(/\\\\/g, '_');\n  \n  return `${source}.${safeId}`;\n}\n\n/**\n * Get a human-readable label for a source\n * @param {string} source Source type identifier\n * @returns {string} Human-readable label\n */\nexport function getSourceLabel(source: string): string {\n  const labels: Record<string, string> = {\n    'arxiv': 'arXiv',\n    'semanticscholar': 'Semantic Scholar',\n    'doi': 'DOI',\n    'acm': 'ACM Digital Library',\n    'openreview': 'OpenReview'\n  };\n  \n  return labels[source] || source.charAt(0).toUpperCase() + source.slice(1);\n}\n\n/**\n * Paper sources configuration\n */\nconst PAPER_SOURCES = [\n  {\n    type: 'arxiv',\n    urlPatterns: [\n      /arxiv\\.org\\/abs\\/([0-9.]+)(v[0-9]+)?/,\n      /arxiv\\.org\\/pdf\\/([0-9.]+)(v[0-9]+)?\\.pdf/\n    ],\n    getIdFromMatch: (match: RegExpMatchArray) => match[1] + (match[2] || '')\n  },\n  {\n    type: 'semanticscholar',\n    urlPatterns: [\n      /semanticscholar\\.org\\/paper\\/([a-f0-9]+)/,\n      /s2-research\\.org\\/papers\\/([a-f0-9]+)/\n    ],\n    getIdFromMatch: (match: RegExpMatchArray) => match[1]\n  },\n  {\n    type: 'doi',\n    urlPatterns: [\n      /doi\\.org\\/(10\\.[0-9.]+\\/[^\\s&\\/?#]+[^\\s&\\/?#.:])/\n    ],\n    getIdFromMatch: (match: RegExpMatchArray) => match[1]\n  },\n  {\n    type: 'acm',\n    urlPatterns: [\n      /dl\\.acm\\.org\\/doi\\/(10\\.[0-9.]+\\/[^\\s&\\/?#]+[^\\s&\\/?#.:])/\n    ],\n    getIdFromMatch: (match: RegExpMatchArray) => match[1]\n  },\n  {\n    type: 'openreview',\n    urlPatterns: [\n      /openreview\\.net\\/forum\\?id=([a-zA-Z0-9_\\-]+)/,\n      /openreview\\.net\\/pdf\\?id=([a-zA-Z0-9_\\-]+)/\n    ],\n    getIdFromMatch: (match: RegExpMatchArray) => match[1]\n  }\n];\n\n/**\n * Detect paper source and ID from URL\n * @param {string} url URL to check for paper identifiers\n * @returns {SourceInfo|null} Source information or null if not a paper URL\n */\nexport function detectPaperSource(url: string): SourceInfo | null {\n  // Check each source type\n  for (const source of PAPER_SOURCES) {\n    for (let i = 0; i < source.urlPatterns.length; i++) {\n      const match = url.match(source.urlPatterns[i]);\n      if (match) {\n        const id = source.getIdFromMatch(match);\n        return {\n          type: source.type,\n          id: id,\n          url: url\n        };\n      }\n    }\n  }\n  return null;\n}\n\n/**\n * Process paper link and add annotation functionality\n * @param {HTMLAnchorElement} link Link element to process\n */\nexport async function processPaperLink(link: HTMLAnchorElement): Promise<void> {\n  // Skip if already processed\n  if (link.classList.contains('paper-processed')) return;\n  link.classList.add('paper-processed');\n\n  // Detect paper source from URL\n  const sourceInfo = detectPaperSource(link.href);\n  if (!sourceInfo) return;\n  \n  const { type: source, id } = sourceInfo;\n\n  // Create annotator button with source-specific class\n  const annotator = document.createElement('span');\n  annotator.className = `paper-annotator annotator-${source}`;\n  annotator.title = `Add ${getSourceLabel(source)} annotation`;\n  \n  // Update the click handler\n  annotator.addEventListener('click', async (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n  \n    // Remove existing popup if any\n    if (activePopup) {\n      activePopup.parentElement?.remove(); // Remove the wrapper\n      if (\n        // Access properties directly - they're properly defined \n        // on the HTMLElement with Object.defineProperties\n        activePopup.hasOwnProperty('paperSource') && \n        activePopup.hasOwnProperty('paperId') &&\n        (activePopup as any).paperSource === source && \n        (activePopup as any).paperId === id\n      ) {\n        activePopup = null;\n        return;\n      }\n    }\n  \n    // Create popup\n    const popup = await createPopup(source, id);\n    \n    // Create wrapper and add popup to it\n    const wrapper = createPopupWrapper();\n    wrapper.appendChild(popup);\n    \n    // Position popup relative to annotator\n    const annotatorRect = annotator.getBoundingClientRect();\n    const available_width = window.innerWidth - annotatorRect.left;\n    \n    if (available_width < 320) { // if not enough space on right\n      popup.style.right = '0';  // align to right edge\n      popup.style.left = 'auto';\n    } else {\n      popup.style.left = '0';\n    }\n    popup.style.top = `${annotatorRect.height + 5}px`;\n    \n    // Add to page and store reference\n    annotator.parentNode!.insertBefore(wrapper, annotator.nextSibling);\n    activePopup = popup;\n  });\n  \n  // Add to page\n  link.parentNode!.insertBefore(annotator, link.nextSibling);\n}\n\n/**\n * Track a paper via the background script\n * @param {string} url Paper URL to track\n */\nexport function trackPaper(url: string): void {\n  const sourceInfo = detectPaperSource(url);\n  if (!sourceInfo) {\n    console.log('Not a recognized paper URL:', url);\n    return;\n  }\n  \n  // Get the page title if possible\n  const title = document.title || `${sourceInfo.type.toUpperCase()} Paper: ${sourceInfo.id}`;\n  \n  // Send message to background script with proper data format\n  chrome.runtime.sendMessage({\n    type: 'trackPaper',\n    source: sourceInfo.type,\n    id: sourceInfo.id,\n    url: url,\n    title: title\n  }, (response) => {\n    console.log('Paper tracking result:', response);\n  });\n}\n\n/**\n * Setup automatic link detection on page\n */\nexport function setupLinkDetection(): void {\n  // Process existing links\n  document.querySelectorAll('a[href]').forEach(link => {\n    processPaperLink(link as HTMLAnchorElement);\n  });\n  \n  // Set up a MutationObserver to detect new links\n  const observer = new MutationObserver(mutations => {\n    mutations.forEach(mutation => {\n      // Process added nodes\n      mutation.addedNodes.forEach(node => {\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          // Check if node is a link\n          if ((node as Element).tagName === 'A' && (node as HTMLAnchorElement).href) {\n            processPaperLink(node as HTMLAnchorElement);\n          }\n          \n          // Check for links within the node\n          (node as Element).querySelectorAll('a[href]').forEach(link => {\n            processPaperLink(link as HTMLAnchorElement);\n          });\n        }\n      });\n    });\n  });\n  \n  // Start observing the document\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true\n  });\n}\n","// content/annotator.ts - Paper annotation UI components and functionality\n\nimport { fetchPaperMetadata } from './metadata_fetcher';\nimport { getSourceLabel, formatPrimaryId } from './paper_detector';\n\n/**\n * Paper metadata from API\n */\ninterface PaperMetadata {\n  title?: string;\n  authors?: string;\n  abstract?: string;\n  [key: string]: any;\n}\n\n/**\n * Create a wrapper element for the popup\n * @returns {HTMLElement} Popup wrapper element\n */\nexport function createPopupWrapper(): HTMLElement {\n  const wrapper = document.createElement('div');\n  wrapper.className = 'paper-popup-container';\n  wrapper.style.position = 'relative';\n  return wrapper;\n}\n\n/**\n * Create popup element for paper annotation\n * @param {string} source Paper source\n * @param {string} id Paper ID\n * @param {string} initialTitle Optional initial title\n * @returns {Promise<HTMLElement>} Popup element\n */\nexport async function createPopup(\n  source: string, \n  id: string, \n  initialTitle = ''\n): Promise<HTMLElement> {\n  console.log(`Creating popup for ${source}:${id}`);\n  \n  // Calculate the standardized primary ID\n  const primary_id = formatPrimaryId(source, id);\n  \n  // Fetch metadata\n  const metadata = await fetchPaperMetadata(source, id);\n  console.log('Fetched metadata:', metadata);\n\n  // Create the popup element\n  const popup = document.createElement('div');\n  popup.className = 'paper-popup';\n  \n  // Add enhanced styles\n  Object.assign(popup.style, {\n    position: 'absolute',\n    zIndex: '10000',\n    background: 'white',\n    border: '1px solid #ccc',\n    borderRadius: '4px',\n    boxShadow: '0 2px 10px rgba(0,0,0,0.1)',\n    padding: '12px',\n    width: '300px',\n    maxWidth: '90vw',\n    fontSize: '14px',\n    fontFamily: 'system-ui, sans-serif'\n  });\n  \n  // Create popup content\n  popup.innerHTML = `\n    <div class=\"paper-popup-source source-${source}\" style=\"\n      display: inline-block;\n      font-size: 11px;\n      border-radius: 4px;\n      padding: 2px 6px;\n      margin-bottom: 10px;\n      color: white;\n      font-weight: 500;\n      background-color: ${getSourceColor(source)};\n    \">${getSourceLabel(source)}</div>\n    <div class=\"paper-popup-header\" style=\"\n      font-weight: bold;\n      margin-bottom: 8px;\n      font-size: 14px;\n      line-height: 1.4;\n    \">${metadata?.title || initialTitle || id}</div>\n    <div class=\"paper-popup-meta\" style=\"\n      font-size: 12px;\n      color: #666;\n      margin-bottom: 12px;\n      line-height: 1.4;\n    \">${metadata?.authors || ''}</div>\n    <div class=\"paper-popup-buttons\" style=\"\n      display: flex;\n      gap: 10px;\n      margin-bottom: 10px;\n    \">\n      <button class=\"vote-button\" data-vote=\"thumbsup\" style=\"\n        flex: 1;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        background: #f5f5f5;\n        cursor: pointer;\n      \">👍 Interesting</button>\n      <button class=\"vote-button\" data-vote=\"thumbsdown\" style=\"\n        flex: 1;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        background: #f5f5f5;\n        cursor: pointer;\n      \">👎 Not Relevant</button>\n    </div>\n    <textarea placeholder=\"Add notes...\" style=\"\n      width: 100%;\n      min-height: 80px;\n      padding: 8px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      box-sizing: border-box;\n      font-family: inherit;\n      font-size: 13px;\n      margin-bottom: 10px;\n      resize: vertical;\n    \"></textarea>\n    <div class=\"paper-popup-actions\" style=\"\n      display: flex;\n      justify-content: flex-end;\n    \">\n      <button class=\"save-button\" style=\"\n        padding: 8px 16px;\n        border: none;\n        border-radius: 4px;\n        background: #0366d6;\n        color: white;\n        cursor: pointer;\n        font-weight: 500;\n      \">Save</button>\n    </div>\n  `;\n\n  // Add event listeners for voting\n  popup.querySelectorAll('.vote-button').forEach(button => {\n    button.addEventListener('click', () => {\n      popup.querySelectorAll('.vote-button').forEach(b => {\n        (b as HTMLElement).style.background = '#f5f5f5';\n        (b as HTMLElement).style.borderColor = '#ddd';\n        b.classList.remove('active');\n      });\n      \n      button.classList.add('active');\n      (button as HTMLElement).style.background = '#e0f7fa';\n      (button as HTMLElement).style.borderColor = '#4dd0e1';\n    });\n  });\n\n  // Add event listener for save button\n  const saveButton = popup.querySelector('.save-button');\n  \n  if (saveButton) {\n    saveButton.addEventListener('click', () => {\n      const vote = popup.querySelector('.vote-button.active')?.getAttribute('data-vote');\n      const notes = (popup.querySelector('textarea') as HTMLTextAreaElement).value;\n      \n      // Format data for the background script with primary_id\n      if (vote || notes) {\n        chrome.runtime.sendMessage({\n          type: 'updateAnnotation',\n          annotationType: notes ? 'notes' : 'vote',\n          data: {\n            paperId: primary_id, // Use the formatted primary ID\n            source: source,\n            vote,\n            notes,\n            title: metadata?.title,\n            authors: metadata?.authors,\n            abstract: metadata?.abstract,\n            timestamp: new Date().toISOString()\n          }\n        }, (response) => {\n          console.log('Annotation saved:', response);\n          \n          // Add success feedback\n          const feedbackEl = document.createElement('div');\n          feedbackEl.textContent = 'Saved successfully!';\n          feedbackEl.style.color = '#4CAF50';\n          feedbackEl.style.padding = '8px';\n          feedbackEl.style.textAlign = 'center';\n          feedbackEl.style.fontWeight = 'bold';\n          \n          const actionsContainer = popup.querySelector('.paper-popup-actions');\n          if (actionsContainer) {\n            actionsContainer.parentElement!.insertBefore(feedbackEl, actionsContainer);\n          }\n          \n          // Remove the popup after a delay\n          setTimeout(() => {\n            popup.parentElement?.remove();\n          }, 1500);\n        });\n      }\n    });\n  }\n\n  // Store source info on the popup element - use simple property access\n  // Use Object.defineProperties to attach properties\n  Object.defineProperties(popup, {\n    paperSource: {\n      value: source,\n      writable: true,\n      enumerable: true\n    },\n    paperId: {\n      value: id,\n      writable: true,\n      enumerable: true\n    },\n    primary_id: {\n      value: primary_id,\n      writable: true,\n      enumerable: true\n    }\n  });\n  \n  return popup;\n}\n\n/**\n * Get color for source branding\n * @param {string} source Source type\n * @returns {string} CSS color\n */\nfunction getSourceColor(source: string): string {\n  const colors: Record<string, string> = {\n    'arxiv': '#B31B1B',\n    'semanticscholar': '#2e7d32',\n    'doi': '#0277bd',\n    'acm': '#0277bd',\n    'openreview': '#6d4c41'\n  };\n  \n  return colors[source] || '#666666';\n}\n\n/**\n * Initialize annotator module\n */\nexport function initializeAnnotator(): void {\n  console.log('Initializing paper annotator module');\n  \n  // CSS is now imported in index.ts via import './styles.css'\n  // which is more maintainable than injecting it here\n  \n  // Initialize any event listeners or other setup needed\n  document.addEventListener('click', (e) => {\n    // Close popups when clicking outside them\n    if (\n      e.target && \n      !(e.target as HTMLElement).closest('.paper-popup') && \n      !(e.target as HTMLElement).closest('.paper-annotator')\n    ) {\n      // Get all popup containers and remove them\n      document.querySelectorAll('.paper-popup-container').forEach(container => {\n        if (container.contains(document.activeElement)) {\n          // Don't remove if it contains the active element (like a focused textarea)\n          return;\n        }\n        container.remove();\n      });\n    }\n  });\n}\n","// content/message_handlers.ts - Handle messages between content script and background\n\nimport { detectPaperSource, trackPaper } from './paper_detector';\n\n/**\n * Initialize message handlers for content script\n */\nexport function initializeMessageHandlers(): void {\n  console.log('Initializing content script message handlers');\n  \n  // Listen for messages from the background script\n  chrome.runtime.onMessage.addListener(handleMessage);\n  \n  // Listen for messages from the page script\n  window.addEventListener('message', handleWindowMessage);\n}\n\n/**\n * Handle messages from the background script\n * @param {any} message Message data\n * @param {chrome.runtime.MessageSender} sender Message sender\n * @param {Function} sendResponse Response callback\n * @returns {boolean} Whether to use sendResponse asynchronously\n */\nfunction handleMessage(\n  message: any, \n  sender: chrome.runtime.MessageSender, \n  sendResponse: (response?: any) => void\n): boolean {\n  console.log('Content script received message:', message);\n\n  // Handle different message types\n  switch (message.type) {\n    case 'detectPaper':\n      // Check if the current page is a paper\n      const currentUrl = window.location.href;\n      const sourceInfo = detectPaperSource(currentUrl);\n      sendResponse(sourceInfo);\n      break;\n\n    case 'trackCurrentPaper':\n      // Track the current page as a paper\n      trackPaper(window.location.href);\n      sendResponse({ success: true });\n      break;\n      \n    case 'extractMetadata':\n      // Extract metadata from the current page\n      const metadata = extractMetadataFromPage();\n      sendResponse(metadata);\n      break;\n      \n    case 'injectAnnotator':\n      // Inject annotator on specific element\n      if (message.selector) {\n        try {\n          const element = document.querySelector(message.selector);\n          if (element) {\n            // TODO: Implement specialized annotator injection\n            sendResponse({ success: true });\n          } else {\n            sendResponse({ success: false, error: 'Element not found' });\n          }\n        } catch (error) {\n          sendResponse({ success: false, error: String(error) });\n        }\n      }\n      break;\n      \n    default:\n      // Unhandled message type\n      console.log('Unhandled message type:', message.type);\n  }\n\n  return true; // Keep channel open for async response\n}\n\n/**\n * Handle messages from the page script\n * @param {MessageEvent} event Window message event\n */\nfunction handleWindowMessage(event: MessageEvent): void {\n  // Ensure message is from the same origin\n  if (event.source !== window) {\n    return;\n  }\n\n  const message = event.data;\n  \n  // Check if it's a message for our extension\n  if (typeof message !== 'object' || message === null || message.target !== 'paper_tracker_extension') {\n    return;\n  }\n\n  console.log('Content script received window message:', message);\n\n  // Handle different action types\n  switch (message.action) {\n    case 'trackPaper':\n      if (message.url) {\n        trackPaper(message.url);\n        // Respond to the page script\n        window.postMessage({\n          source: 'paper_tracker_extension',\n          response: 'trackPaper',\n          success: true\n        }, '*');\n      }\n      break;\n\n    case 'detectPaper':\n      if (message.url) {\n        const sourceInfo = detectPaperSource(message.url);\n        // Respond to the page script\n        window.postMessage({\n          source: 'paper_tracker_extension',\n          response: 'detectPaper',\n          data: sourceInfo\n        }, '*');\n      }\n      break;\n\n    default:\n      console.log('Unhandled window message action:', message.action);\n  }\n}\n\n/**\n * Extract metadata from the current page\n * @returns {Object} Page metadata\n */\nfunction extractMetadataFromPage(): Record<string, any> {\n  // Helper to safely get meta content\n  const getMetaContent = (selector: string): string | undefined => {\n    const element = document.querySelector(selector);\n    return element && 'content' in element ? \n      (element as HTMLMetaElement).content : undefined;\n  };\n\n  // Extract common metadata fields\n  const metadata: Record<string, any> = {\n    title: getMetaContent('meta[name=\"citation_title\"]') ||\n           getMetaContent('meta[property=\"og:title\"]') ||\n           document.title,\n    authors: getMetaContent('meta[name=\"citation_author\"]') ||\n             getMetaContent('meta[name=\"citation_authors\"]') ||\n             getMetaContent('meta[name=\"author\"]'),\n    abstract: getMetaContent('meta[name=\"description\"]') ||\n              getMetaContent('meta[property=\"og:description\"]') ||\n              getMetaContent('meta[name=\"citation_abstract\"]'),\n    published_date: getMetaContent('meta[name=\"citation_publication_date\"]') ||\n                    getMetaContent('meta[name=\"citation_date\"]'),\n    doi: getMetaContent('meta[name=\"citation_doi\"]'),\n    url: getMetaContent('meta[property=\"og:url\"]') || window.location.href\n  };\n\n  // Try to get abstract from various elements if not found in meta tags\n  if (!metadata.abstract) {\n    // Common abstract containers\n    const abstractElement = document.querySelector('.abstract') || \n                           document.querySelector('#abstract') ||\n                           document.querySelector('[class*=\"abstract\"]') ||\n                           document.querySelector('[id*=\"abstract\"]');\n    \n    if (abstractElement) {\n      metadata.abstract = abstractElement.textContent?.trim();\n    }\n  }\n\n  return metadata;\n}\n","// content/index.ts - Main entry point for content script\n\nimport { initializeAnnotator } from './annotator';\nimport { initializeMessageHandlers } from './message_handlers';\nimport { setupLinkDetection, detectPaperSource, trackPaper } from './paper_detector';\nimport { fetchPaperMetadata } from './metadata_fetcher';\nimport './styles.css';\n\n/**\n * Initialize the content script\n */\nfunction initialize(): void {\n  console.log('Academic Paper Tracker content script initialized');\n  \n  // Initialize components\n  initializeMessageHandlers();\n  initializeAnnotator();\n  setupLinkDetection();\n  \n  // Expose global functions for backward compatibility\n  exposeGlobalFunctions();\n}\n\n/**\n * Expose critical functions to window for backward compatibility\n * and for access from page context\n */\nfunction exposeGlobalFunctions(): void {\n  // Create the global object\n  window.paperTracker = {\n    detectPaperSource,\n    fetchPaperMetadata,\n    trackPaper\n  };\n  \n  // Backward compatibility for direct access\n  window.trackPaper = trackPaper;\n}\n\n// Run initialization when DOM is fully loaded\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', initialize);\n} else {\n  // DOM is already loaded, initialize immediately\n  initialize();\n}\n"],"names":[],"mappings":"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"}