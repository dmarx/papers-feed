!function(){"use strict";class e{constructor(e){this.module=e}debug(e,t){console.debug(`[${this.module}] ${e}`,void 0!==t?t:"")}info(e,t){console.info(`[${this.module}] ${e}`,void 0!==t?t:"")}warning(e,t){console.warn(`[${this.module}] ${e}`,void 0!==t?t:"")}error(e,t){console.error(`[${this.module}] ${e}`,void 0!==t?t:"")}}const t=new class{getLogger(t){return new e(t)}},r=t.getLogger("link-processor");const n=t.getLogger("base-source");class o{formatPaperId(e){return`${this.id}.${e}`}parsePaperId(e){const t=`${this.id}.`;if(e.startsWith(t))return e.substring(t.length);const r=`${this.id}:`;return e.startsWith(r)?(n.debug(`Parsed legacy format identifier: ${e}`),e.substring(r.length)):null}formatObjectId(e,t){return`${e}:${this.formatPaperId(t)}`}}const a=t.getLogger("arxiv-xml-parser");const s=t.getLogger("metadata-transformer");const i=t.getLogger("arxiv-integration");const d=new class extends o{constructor(){super(...arguments),this.id="arxiv",this.name="arXiv.org",this.urlPatterns=[/arxiv\.org\/(abs|pdf|html)\/([0-9.]+)/,/arxiv\.org\/\w+\/([0-9.]+)/],this.contentScriptMatches=["*://*.arxiv.org/*"],this.METADATA_MAPPING={titleField:"title",authorsField:"authors",abstractField:"summary",dateField:"published_date",tagsField:"arxiv_tags",extractAuthors:e=>Array.isArray(e.authors)?e.authors.join(", "):e.authors||""}}canHandleUrl(e){return this.urlPatterns.some((t=>t.test(e)))}extractPaperId(e){for(const t of this.urlPatterns){const r=e.match(t);if(r)return r[2]||r[1]}return null}async extractMetadata(e,t){i.info(`Extracting metadata for arXiv ID: ${t}`);const r=this.extractFromPage(e,t);return r?(i.debug("Extracted metadata from page"),r):(i.debug("Falling back to API for metadata"),this.fetchFromApi(t))}extractFromPage(e,t){try{const r=e.querySelector(".title");if(!r)return null;const n=r.textContent?.replace("Title:","").trim()||"",o=e.querySelector(".authors"),a=o?.textContent?.replace("Authors:","").trim()||"",s=e.querySelector(".abstract"),i=s?.textContent?.replace("Abstract:","").trim()||"",d=e.querySelector(".subjects"),c=(d?.textContent?.replace("Subjects:","").trim()||"").split(";").map((e=>e.trim())),p=e.querySelector(".dateline"),u=p?.textContent?.trim()||"";return{sourceId:this.id,paperId:t,url:window.location.href,title:n,authors:a,abstract:i,timestamp:(new Date).toISOString(),rating:"novote",publishedDate:u,tags:c}}catch(e){return i.error("Error extracting from page:",e),null}}async fetchFromApi(e){try{const t=`https://export.arxiv.org/api/query?id_list=${e}`;i.debug(`API URL: ${t}`);const r=await fetch(t);if(!r.ok)throw new Error(`ArXiv API error: ${r.status}`);const n=await r.text(),o=await async function(e){a.debug("Parsing ArXiv XML response");try{const t=(new DOMParser).parseFromString(e,"text/xml"),r=t.querySelector("parsererror");if(r)throw new Error("XML parsing error: "+r.textContent);const n=t.querySelector("entry");if(!n)throw new Error("No entry element found in XML");const o=n.querySelector("title")?.textContent?.trim()||"",s=n.querySelector("summary")?.textContent?.trim()||"",i=n.querySelector("published")?.textContent?.trim()||"",d=Array.from(n.querySelectorAll("author name")).map((e=>e.textContent?.trim()||"")),c=new Set,p=n.querySelector("arxiv\\:primary_category, primary_category");p&&p.hasAttribute("term")&&c.add(p.getAttribute("term")||""),n.querySelectorAll("category").forEach((e=>{e.hasAttribute("term")&&c.add(e.getAttribute("term")||"")}));const u={title:o,summary:s,authors:d,published_date:i,arxiv_tags:Array.from(c)};return a.debug("XML parsing completed successfully"),u}catch(e){return a.error("Error parsing ArXiv XML",e),null}}(n);if(!o)return i.error("Failed to parse API response"),null;const d=function(e,t,r,n,o){const a=(e,t)=>{if(Array.isArray(t)){for(const r of t){const t=a(e,r);if(null!=t&&""!==t)return t}return""}const r=t.split(".");let n=e;for(const e of r){if(null==n)return"";n=n[e]}return null!=n?n:""},i=a(r,n.titleField),d=n.extractAuthors?n.extractAuthors(r):Array.isArray(a(r,n.authorsField))?a(r,n.authorsField).join(", "):a(r,n.authorsField),c=a(r,n.abstractField),p=n.extractDate?n.extractDate(r):a(r,n.dateField),u=n.extractTags?n.extractTags(r):Array.isArray(a(r,n.tagsField))?a(r,n.tagsField):[],l={sourceId:e,paperId:t,url:o,title:i,authors:d,abstract:c,timestamp:(new Date).toISOString(),rating:"novote",publishedDate:p,tags:u};return s.debug("Transformed metadata",{sourceId:e,paperId:t}),l}(this.id,e,o,this.METADATA_MAPPING,`https://arxiv.org/abs/${e}`);return i.debug("Paper metadata processed",d),d}catch(e){return i.error("Error processing arXiv metadata",e),null}}},c=t.getLogger("content-script");c.info("Paper Tracker content script loaded");const p=[d];let u=null,l=null;let g=!0;const h=new class{constructor(e){this.patterns=[],this.observer=null,this.processedLinks=new Set,this.onLinkFound=e,r.debug("Link processor initialized")}registerPattern(e){this.patterns.push(e),r.debug(`Registered pattern for ${e.sourceId}`)}processLinks(e){e.querySelectorAll("a[href]").forEach((e=>{const t=this.getLinkId(e);if(!this.processedLinks.has(t)){this.processedLinks.add(t);for(const t of this.patterns)if(t.pattern.test(e.href)){const r=t.extractPaperId(e.href);if(r){this.onLinkFound(t.sourceId,r,e);break}}}}))}startObserving(e){this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let r=!1;t.forEach((e=>{e.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){"A"===e.tagName&&(r=!0);e.querySelectorAll("a[href]").length>0&&(r=!0)}}))})),r&&this.processLinks(e)})),this.observer.observe(e.body,{childList:!0,subtree:!0}),r.debug("Started observing for DOM changes")}getLinkId(e){const t=this.getElementPath(e);return`${e.href}|${t}`}getElementPath(e){const t=[];let r=e;for(;r&&r!==document.body;){let e=r.tagName.toLowerCase();if(r.id)e+=`#${r.id}`;else{const t=Array.from(r.parentElement?.children||[]),n=t.indexOf(r)+1;t.length>1&&(e+=`:nth-child(${n})`)}t.unshift(e),r=r.parentElement}return t.join(" > ")}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null,r.debug("Stopped observing DOM changes"))}}(((e,t,r)=>{!function(e,t,r){if(e.nextSibling&&e.nextSibling.nodeType===Node.ELEMENT_NODE&&e.nextSibling.classList.contains("paper-annotator"))return;const n=document.createElement("span");n.className="paper-annotator",n.textContent="📝",n.title="Add annotation",n.dataset.sourceId=t,n.dataset.paperId=r,n.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),chrome.runtime.sendMessage({type:"showAnnotationPopup",sourceId:t,paperId:r,position:{x:e.clientX,y:e.clientY}})})),e.parentNode?.insertBefore(n,e.nextSibling)}(r,e,t)}));function m(e){for(const t of p)if(t.canHandleUrl(e)){const r=t.extractPaperId(e);if(r)return{sourceId:t.id,paperId:r}}return null}function f(e,t){b(),g?(chrome.runtime.sendMessage({type:"startSession",sourceId:e,paperId:t},(r=>{r?.success?c.debug(`Started session for ${e}:${t}`):c.error(`Failed to start session for ${e}:${t}`,r?.error)})),l=window.setInterval((()=>{chrome.runtime.sendMessage({type:"sessionHeartbeat",sourceId:e,paperId:t,timestamp:Date.now()})}),5e3),c.info(`Started heartbeat for ${e}:${t}`)):c.debug(`Not starting session for ${e}:${t} because tab is not visible`)}function b(){null!==l&&(clearInterval(l),l=null,c.debug("Stopped heartbeat"))}async function x(){const e=m(window.location.href);if(e){c.info(`Detected paper: ${e.sourceId}:${e.paperId}`);const{sourceId:t,paperId:r}=e,n=p.find((e=>e.id===t));if(n)try{const e=await n.extractMetadata(document,r);e&&(chrome.runtime.sendMessage({type:"paperMetadata",metadata:e}),c.debug(`Sent metadata to background script for ${t}:${r}`),g&&f(t,r))}catch(e){c.error(`Error extracting metadata for ${t}:${r}`,e)}}}document.addEventListener("click",(e=>{!u||u.contains(e.target)||e.target.classList.contains("paper-annotator")||(u.parentElement?.remove(),u=null)})),document.addEventListener("visibilitychange",(()=>{const e=g;g="visible"===document.visibilityState;const t=m(window.location.href);t&&(g&&!e?(c.info(`Tab became visible again for ${t.sourceId}:${t.paperId}`),f(t.sourceId,t.paperId)):!g&&e&&(c.info(`Tab hidden for ${t.sourceId}:${t.paperId}`),chrome.runtime.sendMessage({type:"endSession",sourceId:t.sourceId,paperId:t.paperId,reason:"tab_hidden"}),b()))})),window.addEventListener("focus",(()=>{const e=m(window.location.href);e&&(l||(c.info(`Tab gained focus for ${e.sourceId}:${e.paperId}`),f(e.sourceId,e.paperId)))})),window.addEventListener("blur",(()=>{const e=m(window.location.href);e&&(c.info(`Tab lost focus for ${e.sourceId}:${e.paperId}`),chrome.runtime.sendMessage({type:"endSession",sourceId:e.sourceId,paperId:e.paperId,reason:"tab_blur"}),b())})),window.addEventListener("beforeunload",(()=>{const e=m(window.location.href);e&&chrome.runtime.sendMessage({type:"endSession",sourceId:e.sourceId,paperId:e.paperId,reason:"page_unload"}),b()})),chrome.runtime.onMessage.addListener(((e,t,r)=>{if(c.debug("Received message",e),"showPopup"===e.type){u&&(u.parentElement?.remove(),u=null);const t=document.createElement("div");t.className="paper-popup-wrapper",e.position&&(t.style.left=`${e.position.x}px`,t.style.top=`${e.position.y}px`);const n=document.createElement("div");if(n.className="paper-popup",n.innerHTML=e.html,t.appendChild(n),document.body.appendChild(t),e.handlers)for(const t of e.handlers){n.querySelectorAll(t.selector).forEach((r=>{r.addEventListener(t.event,(()=>{chrome.runtime.sendMessage({type:"popupAction",action:t.action,sourceId:e.sourceId,paperId:e.paperId,data:{value:"TEXTAREA"===r.tagName?r.value:r.getAttribute("data-vote"),checked:"INPUT"===r.tagName?r.checked:void 0,id:r.id}})}))}))}return u=n,r({success:!0}),!0}if("processPage"===e.type)return h.processLinks(document),x(),r({success:!0}),!0})),async function(){!function(){if(document.getElementById("paper-tracker-styles"))return;const e=document.createElement("style");e.id="paper-tracker-styles",e.textContent="\n  .paper-annotator {\n    display: inline-block;\n    margin-left: 4px;\n    cursor: pointer;\n    font-size: 0.9em;\n    opacity: 0.7;\n    transition: opacity 0.2s;\n    vertical-align: baseline;\n  }\n\n  .paper-annotator:hover {\n    opacity: 1;\n  }\n\n  .paper-popup-wrapper {\n    position: fixed;\n    z-index: 10000;\n  }\n\n  .paper-popup {\n    position: relative;\n    background: white;\n    border: 1px solid #ddd;\n    border-radius: 6px;\n    padding: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    width: 300px;\n    box-sizing: border-box;\n  }\n\n  .paper-popup-header {\n    font-weight: bold;\n    margin-bottom: 8px;\n    line-height: 1.4;\n    font-size: 1em;\n  }\n\n  .paper-popup-meta {\n    color: #666;\n    font-size: 0.85em;\n    margin-bottom: 12px;\n    line-height: 1.4;\n  }\n\n  .paper-popup-buttons {\n    display: flex;\n    gap: 8px;\n    margin: 8px 0;\n  }\n\n  .paper-popup button {\n    padding: 6px 12px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background: #f5f5f5;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    font-size: 0.9em;\n  }\n\n  .paper-popup button:hover {\n    background: #e8e8e8;\n    border-color: #ccc;\n  }\n\n  .paper-popup button.active {\n    background: #e0e0e0;\n    border-color: #aaa;\n  }\n\n  .paper-popup textarea {\n    width: calc(100% - 16px);\n    min-height: 80px;\n    margin: 8px 0;\n    padding: 8px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    resize: vertical;\n    font-family: inherit;\n    font-size: 0.9em;\n    line-height: 1.4;\n    box-sizing: border-box;\n  }\n\n  .paper-popup textarea:focus {\n    outline: none;\n    border-color: #aaa;\n  }\n\n  .paper-popup-actions {\n    display: flex;\n    justify-content: flex-end;\n    gap: 8px;\n    margin-top: 12px;\n  }\n\n  .paper-popup .save-button {\n    background: #2563eb;\n    color: white;\n    border-color: #2563eb;\n  }\n\n  .paper-popup .save-button:hover {\n    background: #1d4ed8;\n    border-color: #1d4ed8;\n  }\n  ",document.head.appendChild(e),c.debug("Injected styles")}(),function(){for(const e of p)c.debug(`Initializing source: ${e.id}`),e.urlPatterns.forEach((t=>{h.registerPattern({sourceId:e.id,pattern:t,extractPaperId:t=>e.extractPaperId(t)})}))}(),h.processLinks(document),h.startObserving(document),g="visible"===document.visibilityState,x(),chrome.runtime.sendMessage({type:"contentScriptReady",url:window.location.href},(e=>{e?.success&&c.debug("Background script acknowledged ready status")}))}();let y=location.href;new MutationObserver((()=>{const e=location.href;e!==y&&(y=e,x())})).observe(document,{subtree:!0,childList:!0})}();
//# sourceMappingURL=content-script.js.map
