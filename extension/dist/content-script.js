!function(){"use strict";class e{constructor(e){this.module=e}debug(e,t){console.debug(`[${this.module}] ${e}`,void 0!==t?t:"")}info(e,t){console.info(`[${this.module}] ${e}`,void 0!==t?t:"")}warning(e,t){console.warn(`[${this.module}] ${e}`,void 0!==t?t:"")}error(e,t){console.error(`[${this.module}] ${e}`,void 0!==t?t:"")}}const t=new class{getLogger(t){return new e(t)}},n=t.getLogger("link-processor");const r=t.getLogger("metadata-extractor"),o="pdf",a="url";class i{constructor(e){this.document=e,this.url=e.location.href,r.debug("Initialized metadata extractor for:",this.url)}getMetaContent(e){const t=this.document.querySelector(e);return t&&t.getAttribute("content")||""}extract(){r.debug("Extracting metadata from page:",this.url);const e={title:this.extractTitle(),authors:this.extractAuthors(),description:this.extractDescription(),publishedDate:this.extractPublishedDate(),doi:this.extractDoi(),journalName:this.extractJournalName(),tags:this.extractTags(),url:this.url};return r.debug("Metadata extraction complete:",e),e}extractTitle(){return this.getMetaContent('meta[name="DC.Title"]')||this.getMetaContent('meta[name="citation_title"]')||this.getMetaContent('meta[property="og:title"]')||this.getMetaContent('meta[name="title"]')||this.document.title}extractAuthors(){const e=[];this.document.querySelectorAll('meta[name="citation_author"]').forEach((t=>{const n=t.getAttribute("content");n&&e.push(n)}));const t=[];this.document.querySelectorAll('meta[name="DC.Creator.PersonalName"]').forEach((e=>{const n=e.getAttribute("content");n&&t.push(n)}));const n=this.getMetaContent('meta[name="DC.Creator.PersonalName"]'),r=this.getMetaContent('meta[name="citation_author"]'),o=this.getMetaContent('meta[property="og:article:author"]')||this.getMetaContent('meta[name="author"]');return t.length>0?t.join(", "):e.length>0?e.join(", "):n||(r||(o||""))}extractDescription(){return this.getMetaContent('meta[name="DC.Description"]')||this.getMetaContent('meta[name="citation_abstract"]')||this.getMetaContent('meta[property="og:description"]')||this.getMetaContent('meta[name="description"]')}extractPublishedDate(){return this.getMetaContent('meta[name="DC.Date.issued"]')||this.getMetaContent('meta[name="citation_date"]')||this.getMetaContent('meta[property="article:published_time"]')}extractDoi(){return this.getMetaContent('meta[name="DC.Identifier.DOI"]')||this.getMetaContent('meta[name="citation_doi"]')}extractJournalName(){return this.getMetaContent('meta[name="DC.Source"]')||this.getMetaContent('meta[name="citation_journal_title"]')}extractTags(){const e=this.getMetaContent('meta[name="keywords"]')||this.getMetaContent('meta[name="DC.Subject"]');return e?e.split(",").map((e=>e.trim())):[]}isPdf(){return this.url.toLowerCase().endsWith(".pdf")}getSourceType(){return this.isPdf()?o:a}generatePaperId(){return s(this.url)}}function s(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return Math.abs(t).toString(16).toUpperCase().substring(0,8)}const c=t.getLogger("base-source");class d{constructor(){this.id="url",this.name="Web Page",this.urlPatterns=[/^https?:\/\/(?!.*\.pdf($|\?|#)).*$/i],this.contentScriptMatches=[]}canHandleUrl(e){return this.urlPatterns.some((t=>t.test(e)))}extractPaperId(e){return s(e)}createMetadataExtractor(e){return function(e){return new i(e)}(e)}async extractMetadata(e,t){try{c.debug(`Extracting metadata using base extractor for ID: ${t}`);const n=this.createMetadataExtractor(e),r=n.extract(),o=e.location.href,a=n.getSourceType();return{sourceId:this.id,paperId:t,url:o,title:r.title||e.title||t,authors:r.authors||"",abstract:r.description||"",timestamp:(new Date).toISOString(),rating:"novote",publishedDate:r.publishedDate||"",tags:r.tags||[],doi:r.doi,journalName:r.journalName,sourceType:a}}catch(e){return c.error("Error extracting metadata with base extractor",e),null}}formatPaperId(e){return`${this.id}.${e}`}parsePaperId(e){const t=`${this.id}.`;if(e.startsWith(t))return e.substring(t.length);const n=`${this.id}:`;return e.startsWith(n)?(c.debug(`Parsed legacy format identifier: ${e}`),e.substring(n.length)):null}formatObjectId(e,t){return`${e}:${this.formatPaperId(t)}`}}const u=t.getLogger("arxiv-integration");const p=new class extends d{constructor(){super(...arguments),this.id="arxiv",this.name="arXiv.org",this.urlPatterns=[/arxiv\.org\/(abs|pdf|html)\/([0-9.]+)/,/arxiv\.org\/\w+\/([0-9.]+)/],this.contentScriptMatches=["*://*.arxiv.org/*"]}extractPaperId(e){for(const t of this.urlPatterns){const n=e.match(t);if(n)return n[2]||n[1]}return null}async extractMetadata(e,t){u.info(`Extracting metadata for arXiv ID: ${t}`);const n=await super.extractMetadata(e,t);return u.debug("Extracted metadata from page"),n}},l=t.getLogger("openreview-integration");class h extends i{extract(){const e=super.extract();try{const t=this.document.querySelector(".citation_title")?.textContent||this.document.querySelector(".forum-title h2")?.textContent,n=Array.from(this.document.querySelectorAll(".forum-authors a")).map((e=>e.textContent)).filter(Boolean).join(", "),r=this.document.querySelector('meta[name="citation_abstract"]')?.getAttribute("content")||Array.from(this.document.querySelectorAll(".note-content-field")).find((e=>e.textContent?.includes("Abstract")))?.nextElementSibling?.textContent,o=this.document.querySelector(".date.item")?.textContent;let a="";if(o){const e=o.match(/Published: ([^,]+)/);e&&(a=e[1])}const i=this.document.querySelector('meta[name="citation_doi"]')?.getAttribute("content")||"",s=this.document.querySelectorAll(".forum-meta .item");let c="";for(let e=0;e<s.length;e++){const t=s[e];if(t.querySelector(".glyphicon-folder-open")){c=t.textContent?.trim()||"";break}}const d=Array.from(this.document.querySelectorAll(".note-content-field")).find((e=>e.textContent?.includes("Keywords")));let u=[];if(d){const e=d.nextElementSibling?.textContent;e&&(u=e.split(",").map((e=>e.trim())))}return{title:t||e.title,authors:n||e.authors,description:r||e.description,publishedDate:a||e.publishedDate,doi:i||e.doi,journalName:c||e.journalName,tags:u.length?u:e.tags,url:this.url}}catch(t){return l.error("Error during OpenReview-specific extraction",t),e}}}const m=new class extends d{constructor(){super(...arguments),this.id="openreview",this.name="OpenReview",this.urlPatterns=[/openreview\.net\/forum\?id=([a-zA-Z0-9]+)/,/openreview\.net\/pdf\?id=([a-zA-Z0-9]+)/],this.contentScriptMatches=["*://*.openreview.net/*"]}extractPaperId(e){for(const t of this.urlPatterns){const n=e.match(t);if(n)return n[1]}return null}createMetadataExtractor(e){return new h(e)}async extractMetadata(e,t){l.info(`Extracting metadata for OpenReview ID: ${t}`);const n=await super.extractMetadata(e,t);return n&&(l.debug("Extracted metadata from OpenReview page"),e.location.href.includes("/pdf?id=")&&(n.sourceType="pdf")),n}},g=[p,m],f=t.getLogger("content-script");f.info("Paper Tracker content script loaded");const b=new d;let x=null,y=null;let v=!0,I=null;const w=new class{constructor(e){this.patterns=[],this.observer=null,this.processedLinks=new Set,this.onLinkFound=e,n.debug("Link processor initialized")}registerPattern(e){this.patterns.push(e),n.debug(`Registered pattern for ${e.sourceId}`)}processLinks(e){e.querySelectorAll("a[href]").forEach((e=>{const t=this.getLinkId(e);if(!this.processedLinks.has(t)){this.processedLinks.add(t);for(const t of this.patterns)if(t.pattern.test(e.href)){const n=t.extractPaperId(e.href);if(n){this.onLinkFound(t.sourceId,n,e);break}}}}))}startObserving(e){this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let n=!1;t.forEach((e=>{e.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){"A"===e.tagName&&(n=!0);e.querySelectorAll("a[href]").length>0&&(n=!0)}}))})),n&&this.processLinks(e)})),this.observer.observe(e.body,{childList:!0,subtree:!0}),n.debug("Started observing for DOM changes")}getLinkId(e){const t=this.getElementPath(e);return`${e.href}|${t}`}getElementPath(e){const t=[];let n=e;for(;n&&n!==document.body;){let e=n.tagName.toLowerCase();if(n.id)e+=`#${n.id}`;else{const t=Array.from(n.parentElement?.children||[]),r=t.indexOf(n)+1;t.length>1&&(e+=`:nth-child(${r})`)}t.unshift(e),n=n.parentElement}return t.join(" > ")}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null,n.debug("Stopped observing DOM changes"))}}(((e,t,n)=>{!function(e,t,n){if(e.nextSibling&&e.nextSibling.nodeType===Node.ELEMENT_NODE&&e.nextSibling.classList.contains("paper-annotator"))return;const r=document.createElement("span");r.className="paper-annotator",r.textContent="📝",r.title="Add annotation",r.dataset.sourceId=t,r.dataset.paperId=n,r.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),chrome.runtime.sendMessage({type:"showAnnotationPopup",sourceId:t,paperId:n,position:{x:e.clientX,y:e.clientY}})})),e.parentNode?.insertBefore(r,e.nextSibling)}(n,e,t)}));function M(e,t){E(),v?(I={sourceId:e,paperId:t},chrome.runtime.sendMessage({type:"startSession",sourceId:e,paperId:t},(n=>{n?.success?(f.debug(`Started session for ${e}:${t}`),function(){if(!I)return;E(),y=window.setInterval((()=>{I&&chrome.runtime.sendMessage({type:"sessionHeartbeat",sourceId:I.sourceId,paperId:I.paperId,timestamp:Date.now()})}),5e3),f.debug(`Started heartbeat for ${I.sourceId}:${I.paperId}`)}()):f.error(`Failed to start session for ${e}:${t}`,n?.error)}))):f.debug(`Not starting session for ${e}:${t} because tab is not visible`)}function E(){null!==y&&(clearInterval(y),y=null,f.debug("Stopped heartbeat"))}function C(e){if(!I)return;const{sourceId:t,paperId:n}=I;E(),chrome.runtime.sendMessage({type:"endSession",sourceId:t,paperId:n,reason:e},(r=>{f.debug(`Ended session for ${t}:${n}`,{reason:e})})),I=null}async function $(e=!1){const t=window.location.href;let n=function(e){for(const t of g)if(t.canHandleUrl(e))return t;return null}(t);if(!n&&e&&(f.info(`No matching source found, but force parameter set. Using base source for: ${t}`),n=b),!n)return f.debug(`No source found for URL: ${t}`),null;const r=n.extractPaperId(t);if(!r)return f.info(`Unable to determine a paperId for url: ${t}`),null;try{const e=await n.extractMetadata(document,r);if(e)return chrome.runtime.sendMessage({type:"paperMetadata",metadata:e}),f.debug(`Sent extracted metadata to background script for ${e.sourceId}:${e.paperId}`),v&&M(e.sourceId,e.paperId),e}catch(e){f.error(`Error extracting metadata for ${n.id}:${r}`,e)}return null}document.addEventListener("click",(e=>{!x||x.contains(e.target)||e.target.classList.contains("paper-annotator")||(x.parentElement?.remove(),x=null)})),document.addEventListener("visibilitychange",(()=>{const e=v;v="visible"===document.visibilityState,v&&!e?(f.info("Tab became visible again"),I?M(I.sourceId,I.paperId):$()):!v&&e&&(f.info("Tab hidden"),I&&C("tab_hidden"))})),window.addEventListener("focus",(()=>{v&&(f.info("Window gained focus"),I?M(I.sourceId,I.paperId):$())})),window.addEventListener("blur",(()=>{f.info("Window lost focus"),I&&C("window_blur")})),window.addEventListener("beforeunload",(()=>{I&&(f.info("Page unloading"),C("page_unload"))})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if(f.debug("Received message",e),"extractPaperMetadata"===e.type)return f.debug("Received request to force paper metadata extraction"),$(!0).then((e=>{n(e?{success:!0,metadata:e}:{success:!1,error:"Failed to extract metadata"})})).catch((e=>{f.error("Error extracting metadata",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})})),!0;if("showPopup"===e.type){x&&(x.parentElement?.remove(),x=null);const t=document.createElement("div");t.className="paper-popup-wrapper",e.position&&(t.style.left=`${e.position.x}px`,t.style.top=`${e.position.y}px`);const r=document.createElement("div");if(r.className="paper-popup",r.innerHTML=e.html,t.appendChild(r),document.body.appendChild(t),e.handlers)for(const t of e.handlers){r.querySelectorAll(t.selector).forEach((n=>{n.addEventListener(t.event,(()=>{chrome.runtime.sendMessage({type:"popupAction",action:t.action,sourceId:e.sourceId,paperId:e.paperId,data:{value:"TEXTAREA"===n.tagName?n.value:n.getAttribute("data-vote"),checked:"INPUT"===n.tagName?n.checked:void 0,id:n.id}})}))}))}return x=r,n({success:!0}),!0}return"processPage"===e.type?(w.processLinks(document),$(),n({success:!0}),!0):void 0})),async function(){!function(){if(document.getElementById("paper-tracker-styles"))return;const e=document.createElement("style");e.id="paper-tracker-styles",e.textContent="\n  .paper-annotator {\n    display: inline-block;\n    margin-left: 4px;\n    cursor: pointer;\n    font-size: 0.9em;\n    opacity: 0.7;\n    transition: opacity 0.2s;\n    vertical-align: baseline;\n  }\n\n  .paper-annotator:hover {\n    opacity: 1;\n  }\n\n  .paper-popup-wrapper {\n    position: fixed;\n    z-index: 10000;\n  }\n\n  .paper-popup {\n    position: relative;\n    background: white;\n    border: 1px solid #ddd;\n    border-radius: 6px;\n    padding: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    width: 300px;\n    box-sizing: border-box;\n  }\n\n  .paper-popup-header {\n    font-weight: bold;\n    margin-bottom: 8px;\n    line-height: 1.4;\n    font-size: 1em;\n  }\n\n  .paper-popup-meta {\n    color: #666;\n    font-size: 0.85em;\n    margin-bottom: 12px;\n    line-height: 1.4;\n  }\n\n  .paper-popup-buttons {\n    display: flex;\n    gap: 8px;\n    margin: 8px 0;\n  }\n\n  .paper-popup button {\n    padding: 6px 12px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background: #f5f5f5;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    font-size: 0.9em;\n  }\n\n  .paper-popup button:hover {\n    background: #e8e8e8;\n    border-color: #ccc;\n  }\n\n  .paper-popup button.active {\n    background: #e0e0e0;\n    border-color: #aaa;\n  }\n\n  .paper-popup textarea {\n    width: calc(100% - 16px);\n    min-height: 80px;\n    margin: 8px 0;\n    padding: 8px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    resize: vertical;\n    font-family: inherit;\n    font-size: 0.9em;\n    line-height: 1.4;\n    box-sizing: border-box;\n  }\n\n  .paper-popup textarea:focus {\n    outline: none;\n    border-color: #aaa;\n  }\n\n  .paper-popup-actions {\n    display: flex;\n    justify-content: flex-end;\n    gap: 8px;\n    margin-top: 12px;\n  }\n\n  .paper-popup .save-button {\n    background: #2563eb;\n    color: white;\n    border-color: #2563eb;\n  }\n\n  .paper-popup .save-button:hover {\n    background: #1d4ed8;\n    border-color: #1d4ed8;\n  }\n  ",document.head.appendChild(e),f.debug("Injected styles")}(),function(){for(const e of g)f.debug(`Initializing source: ${e.id}`),e.urlPatterns.forEach((t=>{w.registerPattern({sourceId:e.id,pattern:t,extractPaperId:t=>e.extractPaperId(t)})}))}(),w.processLinks(document),w.startObserving(document),v="visible"===document.visibilityState,$(),chrome.runtime.sendMessage({type:"contentScriptReady",url:window.location.href},(e=>{e?.success&&f.debug("Background script acknowledged ready status")}))}();let S=location.href;new MutationObserver((()=>{const e=location.href;e!==S&&(I&&C("url_change"),S=e,$())})).observe(document,{subtree:!0,childList:!0})}();
//# sourceMappingURL=content-script.js.map
