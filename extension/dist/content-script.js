!function(){"use strict";class t{constructor(t){this.module=t}debug(t,e){console.debug(`[${this.module}] ${t}`,void 0!==e?e:"")}info(t,e){console.info(`[${this.module}] ${t}`,void 0!==e?e:"")}warning(t,e){console.warn(`[${this.module}] ${t}`,void 0!==e?e:"")}error(t,e){console.error(`[${this.module}] ${t}`,void 0!==e?e:"")}}const e=new class{getLogger(e){return new t(e)}},r=e.getLogger("link-processor");const n=e.getLogger("metadata-extractor"),a="pdf",o="url";class s{constructor(t){this.document=t,this.url=t.location.href,n.debug("Initialized metadata extractor for:",this.url)}getMetaContent(t){const e=this.document.querySelector(t);return e&&e.getAttribute("content")||""}extract(){n.debug("Extracting metadata from page:",this.url);const t={title:this.extractTitle(),authors:this.extractAuthors(),description:this.extractDescription(),publishedDate:this.extractPublishedDate(),doi:this.extractDoi(),journalName:this.extractJournalName(),tags:this.extractTags(),url:this.url};return n.debug("Metadata extraction complete:",t),t}extractTitle(){return this.getMetaContent('meta[name="DC.Title"]')||this.getMetaContent('meta[name="citation_title"]')||this.getMetaContent('meta[property="og:title"]')||this.getMetaContent('meta[name="title"]')||this.document.title}extractAuthors(){const t=[];this.document.querySelectorAll('meta[name="citation_author"]').forEach((e=>{const r=e.getAttribute("content");r&&t.push(r)}));const e=[];this.document.querySelectorAll('meta[name="DC.Creator.PersonalName"]').forEach((t=>{const r=t.getAttribute("content");r&&e.push(r)}));const r=this.getMetaContent('meta[name="DC.Creator.PersonalName"]'),n=this.getMetaContent('meta[name="citation_author"]'),a=this.getMetaContent('meta[property="og:article:author"]')||this.getMetaContent('meta[name="author"]');return e.length>0?e.join(", "):t.length>0?t.join(", "):r||(n||(a||""))}extractDescription(){return this.getMetaContent('meta[name="DC.Description"]')||this.getMetaContent('meta[name="citation_abstract"]')||this.getMetaContent('meta[property="og:description"]')||this.getMetaContent('meta[name="description"]')}extractPublishedDate(){return this.getMetaContent('meta[name="DC.Date.issued"]')||this.getMetaContent('meta[name="citation_date"]')||this.getMetaContent('meta[property="article:published_time"]')}extractDoi(){return this.getMetaContent('meta[name="DC.Identifier.DOI"]')||this.getMetaContent('meta[name="citation_doi"]')}extractJournalName(){return this.getMetaContent('meta[name="DC.Source"]')||this.getMetaContent('meta[name="citation_journal_title"]')}extractTags(){const t=this.getMetaContent('meta[name="keywords"]')||this.getMetaContent('meta[name="DC.Subject"]');return t?t.split(",").map((t=>t.trim())):[]}isPdf(){return this.url.toLowerCase().endsWith(".pdf")}getSourceType(){return this.isPdf()?a:o}generatePaperId(){return i(this.url)}}function i(t){let e=0;for(let r=0;r<t.length;r++){e=(e<<5)-e+t.charCodeAt(r),e|=0}return Math.abs(e).toString(16).toUpperCase().substring(0,8)}const c=e.getLogger("base-source");class d{createMetadataExtractor(t){return function(t){return new s(t)}(t)}async extractMetadata(t,e){try{c.debug(`Extracting metadata using base extractor for ID: ${e}`);const r=this.createMetadataExtractor(t),n=r.extract(),a=t.location.href,o=r.getSourceType();return{sourceId:this.id,paperId:e,url:a,title:n.title||t.title||e,authors:n.authors||"",abstract:n.description||"",timestamp:(new Date).toISOString(),rating:"novote",publishedDate:n.publishedDate||"",tags:n.tags||[],doi:n.doi,journalName:n.journalName,sourceType:o}}catch(t){return c.error("Error extracting metadata with base extractor",t),null}}formatPaperId(t){return`${this.id}.${t}`}parsePaperId(t){const e=`${this.id}.`;if(t.startsWith(e))return t.substring(e.length);const r=`${this.id}:`;return t.startsWith(r)?(c.debug(`Parsed legacy format identifier: ${t}`),t.substring(r.length)):null}formatObjectId(t,e){return`${t}:${this.formatPaperId(e)}`}async createManualPaperEntry(t,e){try{c.debug(`Creating manual paper entry for URL: ${t}`);const r=this.createMetadataExtractor(e),n=r.extract(),a=i(t),o=r.getSourceType(),s={sourceId:o,paperId:a,url:t,title:n.title||e.title||a,authors:n.authors||"",abstract:n.description||"",timestamp:(new Date).toISOString(),rating:"novote",publishedDate:n.publishedDate||"",tags:n.tags||[],doi:n.doi,journalName:n.journalName,sourceType:o};return c.debug("Created manual paper entry",s),s}catch(t){return c.error("Error creating manual paper entry",t),null}}}const u=e.getLogger("arxiv-xml-parser");const p=e.getLogger("arxiv-integration");class l extends s{extractAuthors(){const t=this.document.querySelector(".authors");if(t){const e=t.textContent?.replace("Authors:","").trim();if(e)return e}return super.extractAuthors()}extractDescription(){const t=this.document.querySelector(".abstract");if(t){const e=t.textContent?.replace("Abstract:","").trim();if(e)return e}return super.extractDescription()}extractTags(){const t=this.document.querySelector(".subjects");if(t){const e=t.textContent?.replace("Subjects:","").trim();if(e)return e.split(";").map((t=>t.trim()))}return super.extractTags()}extractPublishedDate(){const t=this.document.querySelector(".dateline");if(t){const e=t.textContent?.trim();if(e)return e}return super.extractPublishedDate()}}const h=new class extends d{constructor(){super(...arguments),this.id="arxiv",this.name="arXiv.org",this.urlPatterns=[/arxiv\.org\/(abs|pdf|html)\/([0-9.]+)/,/arxiv\.org\/\w+\/([0-9.]+)/],this.contentScriptMatches=["*://*.arxiv.org/*"]}createMetadataExtractor(t){return new l(t)}canHandleUrl(t){return this.urlPatterns.some((e=>e.test(t)))}extractPaperId(t){for(const e of this.urlPatterns){const r=t.match(e);if(r)return r[2]||r[1]}return null}async extractMetadata(t,e){p.info(`Extracting metadata for arXiv ID: ${e}`);const r=await super.extractMetadata(t,e);return r&&r.title&&r.authors?(p.debug("Extracted metadata from page"),r):(p.debug("Falling back to API for metadata"),this.fetchFromApi(e))}async fetchFromApi(t){try{const e=`https://export.arxiv.org/api/query?id_list=${t}`;p.debug(`API URL: ${e}`);const r=await fetch(e);if(!r.ok)throw new Error(`ArXiv API error: ${r.status}`);const n=await r.text(),a=await async function(t){u.debug("Parsing ArXiv XML response");try{const e=(new DOMParser).parseFromString(t,"text/xml"),r=e.querySelector("parsererror");if(r)throw new Error("XML parsing error: "+r.textContent);const n=e.querySelector("entry");if(!n)throw new Error("No entry element found in XML");const a=n.querySelector("title")?.textContent?.trim()||"",o=n.querySelector("summary")?.textContent?.trim()||"",s=n.querySelector("published")?.textContent?.trim()||"",i=Array.from(n.querySelectorAll("author name")).map((t=>t.textContent?.trim()||"")),c=new Set,d=n.querySelector("arxiv\\:primary_category, primary_category");d&&d.hasAttribute("term")&&c.add(d.getAttribute("term")||""),n.querySelectorAll("category").forEach((t=>{t.hasAttribute("term")&&c.add(t.getAttribute("term")||"")}));const p={title:a,summary:o,authors:i,published_date:s,arxiv_tags:Array.from(c)};return u.debug("XML parsing completed successfully"),p}catch(t){return u.error("Error parsing ArXiv XML",t),null}}(n);return a?{sourceId:this.id,paperId:t,url:`https://arxiv.org/abs/${t}`,title:a.title||t,authors:Array.isArray(a.authors)?a.authors.join(", "):a.authors||"",abstract:a.summary||"",timestamp:(new Date).toISOString(),rating:"novote",publishedDate:a.published_date||"",tags:a.arxiv_tags||[],sourceType:"url"}:(p.error("Failed to parse API response"),null)}catch(t){return p.error("Error processing arXiv metadata",t),null}}},m=e.getLogger("content-script");m.info("Paper Tracker content script loaded");const g=new class extends d{constructor(){super(...arguments),this.id="url",this.name="Generic Source",this.urlPatterns=[],this.contentScriptMatches=[]}canHandleUrl(t){return!1}extractPaperId(t){return i(t)}};const f=new class extends d{constructor(){super(...arguments),this.id="pdf",this.name="PDF Document",this.urlPatterns=[/\.pdf$/i],this.contentScriptMatches=[]}canHandleUrl(t){return t.toLowerCase().endsWith(".pdf")}extractPaperId(t){return i(t)}},b=[h,f];let x=null,y=null;let v=!0;const w=new class{constructor(t){this.patterns=[],this.observer=null,this.processedLinks=new Set,this.onLinkFound=t,r.debug("Link processor initialized")}registerPattern(t){this.patterns.push(t),r.debug(`Registered pattern for ${t.sourceId}`)}processLinks(t){t.querySelectorAll("a[href]").forEach((t=>{const e=this.getLinkId(t);if(!this.processedLinks.has(e)){this.processedLinks.add(e);for(const e of this.patterns)if(e.pattern.test(t.href)){const r=e.extractPaperId(t.href);if(r){this.onLinkFound(e.sourceId,r,t);break}}}}))}startObserving(t){this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((e=>{let r=!1;e.forEach((t=>{t.addedNodes.forEach((t=>{if(t.nodeType===Node.ELEMENT_NODE){"A"===t.tagName&&(r=!0);t.querySelectorAll("a[href]").length>0&&(r=!0)}}))})),r&&this.processLinks(t)})),this.observer.observe(t.body,{childList:!0,subtree:!0}),r.debug("Started observing for DOM changes")}getLinkId(t){const e=this.getElementPath(t);return`${t.href}|${e}`}getElementPath(t){const e=[];let r=t;for(;r&&r!==document.body;){let t=r.tagName.toLowerCase();if(r.id)t+=`#${r.id}`;else{const e=Array.from(r.parentElement?.children||[]),n=e.indexOf(r)+1;e.length>1&&(t+=`:nth-child(${n})`)}e.unshift(t),r=r.parentElement}return e.join(" > ")}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null,r.debug("Stopped observing DOM changes"))}}(((t,e,r)=>{!function(t,e,r){if(t.nextSibling&&t.nextSibling.nodeType===Node.ELEMENT_NODE&&t.nextSibling.classList.contains("paper-annotator"))return;const n=document.createElement("span");n.className="paper-annotator",n.textContent="ðŸ“",n.title="Add annotation",n.dataset.sourceId=e,n.dataset.paperId=r,n.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),chrome.runtime.sendMessage({type:"showAnnotationPopup",sourceId:e,paperId:r,position:{x:t.clientX,y:t.clientY}})})),t.parentNode?.insertBefore(n,t.nextSibling)}(r,t,e)}));function I(t){for(const e of b)if(e.canHandleUrl(t))return e;return null}function M(t,e){E(),v?(chrome.runtime.sendMessage({type:"startSession",sourceId:t,paperId:e},(r=>{r?.success?m.debug(`Started session for ${t}.${e}`):m.error(`Failed to start session for ${t}.${e}`,r?.error)})),y=window.setInterval((()=>{chrome.runtime.sendMessage({type:"sessionHeartbeat",sourceId:t,paperId:e,timestamp:Date.now()})}),5e3),m.info(`Started heartbeat for ${t}:${e}`)):m.debug(`Not starting session for ${t}.${e} because tab is not visible`)}function E(){null!==y&&(clearInterval(y),y=null,m.debug("Stopped heartbeat"))}async function S(t=!1){const e=window.location.href;let r=I(e);if(!r&&t&&(m.info(`No matching source found, but force parameter set. Using generic source for: ${e}`),r=e.toLowerCase().endsWith(".pdf")?f:g),!r)return m.debug(`No source found for URL: ${e}`),null;const n=r.extractPaperId(e);if(!n)return m.info(`Unable to determine a paperId for url: ${e}`),null;try{let t;if(t=await r.extractMetadata(document,n),t)return chrome.runtime.sendMessage({type:"paperMetadata",metadata:t}),m.debug(`Sent extracted metadata to background script for ${t.sourceId}.${t.paperId}`),v&&M(t.sourceId,t.paperId),t}catch(t){m.error(`Error extracting metadata for ${r.id}.${n}`,t)}return null}document.addEventListener("click",(t=>{!x||x.contains(t.target)||t.target.classList.contains("paper-annotator")||(x.parentElement?.remove(),x=null)})),document.addEventListener("visibilitychange",(()=>{const t=v;v="visible"===document.visibilityState;const e=I(window.location.href);if(!e)return;const r=e.extractPaperId(window.location.href);r&&(v&&!t?(m.info(`Tab became visible again for ${e.id}:${r}`),M(e.id,r)):!v&&t&&(m.info(`Tab hidden for ${e.id}:${r}`),chrome.runtime.sendMessage({type:"endSession",sourceId:e.id,paperId:r,reason:"tab_hidden"}),E()))})),window.addEventListener("focus",(()=>{const t=I(window.location.href);if(!t)return;const e=t.extractPaperId(window.location.href);e&&(y||(m.info(`Tab gained focus for ${t.id}:${e}`),M(t.id,e)))})),window.addEventListener("blur",(()=>{const t=I(window.location.href);if(!t)return;const e=t.extractPaperId(window.location.href);e&&(m.info(`Tab lost focus for ${t.id}:${e}`),chrome.runtime.sendMessage({type:"endSession",sourceId:t.id,paperId:e,reason:"tab_blur"}),E())})),window.addEventListener("beforeunload",(()=>{const t=window.location.href,e=I(t);if(!e)return;const r=e.extractPaperId(t);r&&(chrome.runtime.sendMessage({type:"endSession",sourceId:e.id,paperId:r,reason:"page_unload"}),E())})),chrome.runtime.onMessage.addListener(((t,e,r)=>{if(m.debug("Received message",t),"extractPaperMetadata"===t.type)return m.debug("Received request to extract paper metadata manually"),S(!0).then((t=>{r(t?{success:!0,metadata:t}:{success:!1,error:"Failed to extract metadata"})})).catch((t=>{m.error("Error extracting metadata",t),r({success:!1,error:t instanceof Error?t.message:"Unknown error"})})),!0;if("showPopup"===t.type){x&&(x.parentElement?.remove(),x=null);const e=document.createElement("div");e.className="paper-popup-wrapper",t.position&&(e.style.left=`${t.position.x}px`,e.style.top=`${t.position.y}px`);const n=document.createElement("div");if(n.className="paper-popup",n.innerHTML=t.html,e.appendChild(n),document.body.appendChild(e),t.handlers)for(const e of t.handlers){n.querySelectorAll(e.selector).forEach((r=>{r.addEventListener(e.event,(()=>{chrome.runtime.sendMessage({type:"popupAction",action:e.action,sourceId:t.sourceId,paperId:t.paperId,data:{value:"TEXTAREA"===r.tagName?r.value:r.getAttribute("data-vote"),checked:"INPUT"===r.tagName?r.checked:void 0,id:r.id}})}))}))}return x=n,r({success:!0}),!0}return"processPage"===t.type?(w.processLinks(document),S(),r({success:!0}),!0):void 0})),async function(){!function(){if(document.getElementById("paper-tracker-styles"))return;const t=document.createElement("style");t.id="paper-tracker-styles",t.textContent="\n  .paper-annotator {\n    display: inline-block;\n    margin-left: 4px;\n    cursor: pointer;\n    font-size: 0.9em;\n    opacity: 0.7;\n    transition: opacity 0.2s;\n    vertical-align: baseline;\n  }\n\n  .paper-annotator:hover {\n    opacity: 1;\n  }\n\n  .paper-popup-wrapper {\n    position: fixed;\n    z-index: 10000;\n  }\n\n  .paper-popup {\n    position: relative;\n    background: white;\n    border: 1px solid #ddd;\n    border-radius: 6px;\n    padding: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    width: 300px;\n    box-sizing: border-box;\n  }\n\n  .paper-popup-header {\n    font-weight: bold;\n    margin-bottom: 8px;\n    line-height: 1.4;\n    font-size: 1em;\n  }\n\n  .paper-popup-meta {\n    color: #666;\n    font-size: 0.85em;\n    margin-bottom: 12px;\n    line-height: 1.4;\n  }\n\n  .paper-popup-buttons {\n    display: flex;\n    gap: 8px;\n    margin: 8px 0;\n  }\n\n  .paper-popup button {\n    padding: 6px 12px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    background: #f5f5f5;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    font-size: 0.9em;\n  }\n\n  .paper-popup button:hover {\n    background: #e8e8e8;\n    border-color: #ccc;\n  }\n\n  .paper-popup button.active {\n    background: #e0e0e0;\n    border-color: #aaa;\n  }\n\n  .paper-popup textarea {\n    width: calc(100% - 16px);\n    min-height: 80px;\n    margin: 8px 0;\n    padding: 8px;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    resize: vertical;\n    font-family: inherit;\n    font-size: 0.9em;\n    line-height: 1.4;\n    box-sizing: border-box;\n  }\n\n  .paper-popup textarea:focus {\n    outline: none;\n    border-color: #aaa;\n  }\n\n  .paper-popup-actions {\n    display: flex;\n    justify-content: flex-end;\n    gap: 8px;\n    margin-top: 12px;\n  }\n\n  .paper-popup .save-button {\n    background: #2563eb;\n    color: white;\n    border-color: #2563eb;\n  }\n\n  .paper-popup .save-button:hover {\n    background: #1d4ed8;\n    border-color: #1d4ed8;\n  }\n  ",document.head.appendChild(t),m.debug("Injected styles")}(),function(){for(const t of b)m.debug(`Initializing source: ${t.id}`),t.urlPatterns.forEach((e=>{w.registerPattern({sourceId:t.id,pattern:e,extractPaperId:e=>t.extractPaperId(e)})}))}(),w.processLinks(document),w.startObserving(document),v="visible"===document.visibilityState,S(),chrome.runtime.sendMessage({type:"contentScriptReady",url:window.location.href},(t=>{t?.success&&m.debug("Background script acknowledged ready status")}))}();let C=location.href;new MutationObserver((()=>{const t=location.href;t!==C&&(C=t,S())})).observe(document,{subtree:!0,childList:!0})}();
//# sourceMappingURL=content-script.js.map
